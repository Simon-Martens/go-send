import{a as w,b as y,i as r}from"./chunk.RASS3VP2.js";import{a as p,b as f}from"./chunk.NJSDOF6A.js";async function T(d,u={}){let{clearFirst:m=!1}=u;if(!d){console.warn("[syncFiles] No user secrets provided, skipping sync");return}try{let t=await fetch("/api/me/files",{method:"GET",headers:{Accept:"application/json"},credentials:"same-origin"});if(!t.ok){console.warn("[syncFiles] Failed to fetch owned files",t.status);return}let i=await t.json(),h=Array.isArray(i==null?void 0:i.files)?i.files:[];m&&r.clearLocalFiles();let F=m?new Set:new Set(r.files.map(e=>e.id).filter(e=>e)),o=0,a=0;for(let e of h)try{if(F.has(e.id)){a++;continue}let n=await d.unwrapSecret({ciphertext:e.secret_ciphertext,nonce:e.secret_nonce,ephemeralPublicKey:e.secret_ephemeral_pub,version:e.secret_version});try{let c=p(n),_=new w(c,e.nonce),g=f(e.metadata),s=await _.decryptMetadata(g),A=Array.isArray(e.recipients)?e.recipients.map(l=>({userId:l.user_id,userName:l.name||"",userEmail:l.email||""})):[],k=new y({id:e.id,url:`${window.location.origin}/download/${e.id}#${c}`,name:s.name,size:s.size,manifest:s.manifest||{},time:0,speed:s.size||0,createdAt:e.created_at*1e3,expiresAt:e.expires_at*1e3,secretKey:c,nonce:e.nonce,ownerToken:e.owner_token,dlimit:e.dl_limit,dtotal:e.dl_count,hasPassword:e.password,timeLimit:e.time_limit,ownerString:e.owner_string||"",authString:e.auth_string||"",recipients:A});r.addFile(k),o++}finally{n.fill(0)}}catch(n){console.warn("[syncFiles] Failed to restore file",n,e==null?void 0:e.id)}(o>0||a>0)&&console.log(`[syncFiles] Sync complete: ${o} added, ${a} already present`)}catch(t){console.warn("[syncFiles] Failed to sync owned files",t)}}export{T as a};
