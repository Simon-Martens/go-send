import{b as w,c as C,e as S,f as T,h as _,i as y}from"./chunk.GRDFA2OT.js";import{i as v}from"./chunk.RASS3VP2.js";import"./chunk.EL6E2633.js";import{A as f,y as r}from"./chunk.NJSDOF6A.js";import"./chunk.XOPNHUSF.js";var b=class extends HTMLElement{constructor(){super(),this.form=null,this.nameInput=null,this.emailInput=null,this.passwordInput=null,this.passwordConfirmInput=null,this.errorElement=null,this.submitButton=null,this.passwordToggle=null,this.passwordConfirmToggle=null,this.token=null,this.registerType="admin",this._postMountFrame=null,this._templateMounted=!1,this._storageCleared=!1,this._handlersBound=!1,this._boundHandlers={submit:this.handleSubmit.bind(this),togglePassword:this.togglePasswordVisibility.bind(this),togglePasswordConfirm:this.togglePasswordConfirmVisibility.bind(this)}}connectedCallback(){if(this._storageCleared||(v.clearAll(),this._storageCleared=!0),!this._templateMounted){let e=document.getElementById("register-layout");if(!e){console.error("Template #register-layout not found");return}let t=e.content.cloneNode(!0);this.appendChild(t),this._templateMounted=!0}this._postMountFrame!==null&&cancelAnimationFrame(this._postMountFrame),this._postMountFrame=requestAnimationFrame(()=>{if(this._postMountFrame=null,!this.isConnected)return;f(this),this.extractToken(),this.form=this.querySelector('[data-role="register-form"]'),this.nameInput=this.querySelector('[data-role="name-input"]'),this.emailInput=this.querySelector('[data-role="email-input"]'),this.passwordInput=this.querySelector('[data-role="password-input"]'),this.passwordConfirmInput=this.querySelector('[data-role="password-confirm-input"]'),this.errorElement=this.querySelector('[data-role="error"]'),this.submitButton=this.querySelector('[data-role="submit"]'),this.passwordToggle=this.querySelector('[data-role="toggle-password"]'),this.passwordConfirmToggle=this.querySelector('[data-role="toggle-password-confirm"]');let e=this.querySelector('[data-role="register-title"] span'),t=this.querySelector('[data-role="register-description"] span');e&&t&&(this.registerType==="admin"?(e.id="registerAdminTitle",t.id="registerAdminDescription"):(e.id="registerUserTitle",t.id="registerUserDescription"),f(this)),this.setPlaceholders(),!this._handlersBound&&this.form&&(this.form.addEventListener("submit",this._boundHandlers.submit),this.passwordToggle&&this.passwordToggle.addEventListener("click",this._boundHandlers.togglePassword),this.passwordConfirmToggle&&this.passwordConfirmToggle.addEventListener("click",this._boundHandlers.togglePasswordConfirm),this.nameInput&&this.nameInput.addEventListener("input",()=>this.validateForm()),this.emailInput&&this.emailInput.addEventListener("input",()=>this.validateForm()),this.passwordInput&&this.passwordInput.addEventListener("input",()=>this.validateForm()),this.passwordConfirmInput&&this.passwordConfirmInput.addEventListener("input",()=>this.validateForm()),this._handlersBound=!0),this.validateForm(),console.log("[RegisterLayout] Initialized",{token:this.token?this.token.substring(0,8)+"...":null,type:this.registerType})})}disconnectedCallback(){this._postMountFrame!==null&&(cancelAnimationFrame(this._postMountFrame),this._postMountFrame=null),this._handlersBound&&this.form&&(this.form.removeEventListener("submit",this._boundHandlers.submit),this.passwordToggle&&this.passwordToggle.removeEventListener("click",this._boundHandlers.togglePassword),this.passwordConfirmToggle&&this.passwordConfirmToggle.removeEventListener("click",this._boundHandlers.togglePasswordConfirm),this._handlersBound=!1)}extractToken(){let e=window.location.pathname,t=e.split("/").filter(s=>s);t[0]==="register"&&t[1]==="admin"&&t[2]?(this.token=t[2],this.registerType="admin"):t[0]==="register"&&t[1]==="user"&&t[2]?(this.token=t[2],this.registerType="user"):(console.warn("[RegisterLayout] No token found in URL:",e),this.showError("Invalid registration link. Please use the link provided in your email."))}togglePasswordVisibility(e){e.preventDefault(),this.passwordInput&&(this.passwordInput.type==="password"?this.passwordInput.type="text":this.passwordInput.type="password")}togglePasswordConfirmVisibility(e){e.preventDefault(),this.passwordConfirmInput&&(this.passwordConfirmInput.type==="password"?this.passwordConfirmInput.type="text":this.passwordConfirmInput.type="password")}async handleSubmit(e){var l,c,u,h;e.preventDefault(),this.hideError();let t=(l=this.nameInput)==null?void 0:l.value.trim(),s=(c=this.emailInput)==null?void 0:c.value.trim(),i=(u=this.passwordInput)==null?void 0:u.value,d=(h=this.passwordConfirmInput)==null?void 0:h.value;if(!t){this.showError(r("registerErrorNameRequired"));return}if(!this.isValidEmail(s)){this.showError(r("authErrorInvalidEmail"));return}if(i.length<10){this.showError(r("authErrorPasswordLength"));return}if(i!==d){this.showError(r("registerErrorPasswordsMismatch"));return}if(!this.token){this.showError(r("registerErrorMissingToken"));return}if(!window.crypto||!window.crypto.subtle){this.showError(r("authErrorCryptoUnsupported"));return}this.submitButton&&(this.submitButton.disabled=!0,this.setSubmitLabel("registerSubmitting"));let o,n;try{console.log("[RegisterLayout] Deriving credentials"),o=C();let a,m;try{({seed:n,publicKey:a,encryptionPublicKey:m}=await S(i,o,w))}finally{this.passwordInput.value="",this.passwordConfirmInput.value=""}let p=_(o),k=y(a),L=y(m),P=T(w);console.log("[RegisterLayout] Sending registration request");let B=this.registerType==="admin"?"/register/admin":"/register/user",g=await fetch(B,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:this.token,name:t,email:s,salt:p,public_key:k,encryption_public_key:L,kdf:P})});if(!g.ok){let I="";try{I=await g.text()}catch{}throw console.error("[RegisterLayout] Registration request failed",g.status,I),new Error(r("registerErrorGeneric"))}let E=await g.json();console.log("[RegisterLayout] Registration successful",{userId:E.id,email:E.email}),this.showSuccess(t)}catch(a){console.error("[RegisterLayout] Registration failed",a),this.showError(a.message||r("registerErrorGeneric")),this.submitButton&&(this.submitButton.disabled=!1,this.setSubmitLabel("registerSubmitButton"))}finally{n&&n.fill(0),o&&o.fill(0)}}async showSuccess(e){let t=this.querySelector("section > div");if(!t)return;let s=document.getElementById("register-success");if(!s){console.error("Template #register-success not found");return}t.innerHTML="";let i=s.content.cloneNode(!0),{translate:d,translateElement:o}=await import("./utils.O3BZCJ62.js"),n=i.querySelector('[data-role="success-message"]');n&&(n.textContent=d("registerSuccessMessage",{name:e}));let l=i.querySelector('[data-action="go-home"]');l&&l.addEventListener("click",()=>{window.location.href="/"}),t.appendChild(i),o(t)}validateForm(){var h,a,m,p;let e=(h=this.nameInput)==null?void 0:h.value.trim(),t=(a=this.emailInput)==null?void 0:a.value.trim(),s=(m=this.passwordInput)==null?void 0:m.value,i=(p=this.passwordConfirmInput)==null?void 0:p.value,d=e&&e.length>0,o=t&&this.isValidEmail(t),n=s&&s.length>=10,l=s===i,c=i&&i.length>=10,u=d&&o&&n&&l&&c;return this.submitButton&&(this.submitButton.disabled=!u),u}async setPlaceholders(){try{let{translate:e}=await import("./utils.O3BZCJ62.js"),t=this.querySelector('[data-placeholder-key="registerNamePlaceholder"]'),s=this.querySelector('[data-placeholder-key="registerEmailPlaceholder"]');t&&(t.placeholder=e("registerNamePlaceholder")),s&&(s.placeholder=e("registerEmailPlaceholder"))}catch(e){console.warn("Could not translate placeholders",e)}}isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}showError(e){this.errorElement&&(this.errorElement.textContent=e,this.errorElement.classList.remove("hidden"))}hideError(){this.errorElement&&(this.errorElement.textContent="",this.errorElement.classList.add("hidden"))}setSubmitLabel(e){if(!this.submitButton)return;let t=this.submitButton.querySelector('[data-type="lang"]'),s=r(e);t?t.textContent=s:this.submitButton.textContent=s}};customElements.define("register-layout",b);
