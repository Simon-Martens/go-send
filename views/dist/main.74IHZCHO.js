import{a as z,b as P,c as fe,d as Fe,e as y,f as N,g as me,h as De,i as Me,l as Pe,m as Ne,n as Oe}from"./chunks/chunk.B5PI22HI.js";function O(i){let e="";for(let r=0;r<i.length;r+=32768)e+=String.fromCharCode(...i.subarray(r,r+32768));return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function C(i){let e=i.replace(/-/g,"+").replace(/_/g,"/")+"===".slice((i.length+3)%4),t=atob(e),r=new Uint8Array(t.length);for(let n=0;n<t.length;n++)r[n]=t.charCodeAt(n);return r}function ee(i){let e=i.reduce((n,a)=>n+a.length,0),t=new Uint8Array(e),r=0;for(let n of i)t.set(n,r),r+=n.length;return t}function ge(i,e){return new DataView(i.buffer,i.byteOffset,i.byteLength).getUint32(e,!1)}function we(i,e,t){new DataView(i.buffer,i.byteOffset,i.byteLength).setUint32(e,t,!1)}function Ke(i,e){return i[e]}function $e(i,e,t){i[e]=t}function ye(i=100){return new Promise(e=>setTimeout(e,i))}function K(i,e={},t){let r=i.getReader(),n=e||{};return new ReadableStream({async start(a){n.start&&await n.start(a)},async pull(a){for(;;){let{value:o,done:l}=await r.read();if(l){n.flush&&await n.flush(a),r.releaseLock(),a.close();return}if(!n.transform){a.enqueue(o);return}let d=!1,m={enqueue(k){d=!0,a.enqueue(k)}};if(await n.transform(o,m),d)return}},cancel(a){r.cancel(a),n.cancel&&n.cancel(a),t&&t(a)}})}var be=class{constructor(e,t){this.blob=e,this.index=0,this.chunkSize=t||1024*64}pull(e){return new Promise((t,r)=>{let n=this.blob.size-this.index;if(n<=0)return e.close(),t();let a=Math.min(this.chunkSize,n),o=this.blob.slice(this.index,this.index+a),l=new FileReader;l.onload=()=>{e.enqueue(new Uint8Array(l.result)),t()},l.onerror=r,l.readAsArrayBuffer(o),this.index+=a})}};function te(i,e){return new ReadableStream(new be(i,e))}var xe=class{constructor(e){this.streams=e,this.index=0,this.reader=null,this.nextReader()}nextReader(){let e=this.streams[this.index++];this.reader=e&&e.getReader()}async pull(e){if(!this.reader)return e.close();let t=await this.reader.read();if(t.done)return this.nextReader(),this.pull(e);e.enqueue(t.value)}};function Be(i){return new ReadableStream(new xe(i))}var Ut=12,qe=16,$=16,ve="encrypt",Ve="decrypt",ne=1024*64,He=new TextEncoder;function Rt(i){let e=new Uint8Array(i);return crypto.getRandomValues(e),e.buffer}var re=class{constructor(e,t,r,n){this.mode=e,this.prevChunk,this.seq=0,this.firstchunk=!0,this.rs=r,this.ikm=t.buffer,this.salt=n}async generateKey(){let e=await crypto.subtle.importKey("raw",this.ikm,"HKDF",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"HKDF",salt:this.salt,info:He.encode("Content-Encoding: aes128gcm\0"),hash:"SHA-256"},e,{name:"AES-GCM",length:128},!0,["encrypt","decrypt"])}async generateNonceBase(){let e=await crypto.subtle.importKey("raw",this.ikm,"HKDF",!1,["deriveKey"]),t=await crypto.subtle.exportKey("raw",await crypto.subtle.deriveKey({name:"HKDF",salt:this.salt,info:He.encode("Content-Encoding: nonce\0"),hash:"SHA-256"},e,{name:"AES-GCM",length:128},!0,["encrypt","decrypt"]));return new Uint8Array(t.slice(0,Ut))}generateNonce(e){if(e>4294967295)throw new Error("record sequence number exceeds limit");let t=new Uint8Array(this.nonceBase),n=(ge(t,t.length-4)^e)>>>0;return we(t,t.length-4,n),t}pad(e,t){let r=e.length;if(r+qe>=this.rs)throw new Error("data too large for record size");if(t){let n=new Uint8Array(1);return n[0]=2,ee([e,n])}else{let n=new Uint8Array(this.rs-r-qe);return n[0]=1,ee([e,n])}}unpad(e,t){for(let r=e.length-1;r>=0;r--)if(e[r]){if(t){if(e[r]!==2)throw new Error("delimiter of final record is not 2")}else if(e[r]!==1)throw new Error("delimiter of not final record is not 1");return e.slice(0,r)}throw new Error("no delimiter found")}createHeader(){let e=new Uint8Array(5);return we(e,0,this.rs),$e(e,4,0),ee([new Uint8Array(this.salt),e])}readHeader(e){if(e.length<21)throw new Error("chunk too small for reading header");let t={};t.salt=e.buffer.slice(0,$),t.rs=ge(e,$);let r=Ke(e,$+4);return t.length=r+$+5,t}async encryptRecord(e,t,r){let n=this.generateNonce(t),a=await crypto.subtle.encrypt({name:"AES-GCM",iv:n},this.key,this.pad(e,r));return new Uint8Array(a)}async decryptRecord(e,t,r){let n=this.generateNonce(t),a=await crypto.subtle.decrypt({name:"AES-GCM",iv:n,tagLength:128},this.key,e);return this.unpad(new Uint8Array(a),r)}async start(e){if(this.mode===ve)this.key=await this.generateKey(),this.nonceBase=await this.generateNonceBase(),e.enqueue(this.createHeader());else if(this.mode!==Ve)throw new Error("mode must be either encrypt or decrypt")}async transformPrevChunk(e,t){if(this.mode===ve)t.enqueue(await this.encryptRecord(this.prevChunk,this.seq,e)),this.seq++;else{if(this.seq===0){let r=this.readHeader(this.prevChunk);this.salt=r.salt,this.rs=r.rs,this.key=await this.generateKey(),this.nonceBase=await this.generateNonceBase()}else t.enqueue(await this.decryptRecord(this.prevChunk,this.seq-1,e));this.seq++}}async transform(e,t){this.firstchunk||await this.transformPrevChunk(!1,t),this.firstchunk=!1,this.prevChunk=new Uint8Array(e.buffer)}async flush(e){this.prevChunk&&await this.transformPrevChunk(!0,e)}},ie=class{constructor(e,t){this.mode=t,this.rs=e,this.chunkSize=t===ve?e-17:21,this.partialChunk=new Uint8Array(this.chunkSize),this.offset=0}send(e,t){t.enqueue(e),this.chunkSize===21&&this.mode===Ve&&(this.chunkSize=this.rs),this.partialChunk=new Uint8Array(this.chunkSize),this.offset=0}transform(e,t){let r=0;if(this.offset>0){let n=Math.min(e.byteLength,this.chunkSize-this.offset);this.partialChunk.set(e.slice(0,n),this.offset),this.offset+=n,r+=n,this.offset===this.chunkSize&&this.send(this.partialChunk,t)}for(;r<e.byteLength;){let n=e.byteLength-r;if(n>=this.chunkSize){let a=e.slice(r,r+this.chunkSize);r+=this.chunkSize,this.send(a,t)}else{let a=e.slice(r,r+n);r+=a.byteLength,this.partialChunk.set(a),this.offset=a.byteLength}}}flush(e){this.offset>0&&e.enqueue(this.partialChunk.slice(0,this.offset))}};function We(i,e,t=ne,r=Rt($)){let n="encrypt",a=K(i,new ie(t,n));return K(a,new re(n,e,t,r))}function je(i,e,t=ne){let r="decrypt",n=K(i,new ie(t,r));return K(n,new re(r,e,t))}var B=new TextEncoder,zt=new TextDecoder,x=class{constructor(e,t){this._nonce=t||"yRCdyQ1EMSA3mo4rqSkuNQ==",e?this.rawSecret=C(e):this.rawSecret=crypto.getRandomValues(new Uint8Array(16)),this.secretKeyPromise=crypto.subtle.importKey("raw",this.rawSecret,"HKDF",!1,["deriveKey"]),this.metaKeyPromise=this.secretKeyPromise.then(function(r){return crypto.subtle.deriveKey({name:"HKDF",salt:new Uint8Array,info:B.encode("metadata"),hash:"SHA-256"},r,{name:"AES-GCM",length:128},!1,["encrypt","decrypt"])}),this.authKeyPromise=this.secretKeyPromise.then(function(r){return crypto.subtle.deriveKey({name:"HKDF",salt:new Uint8Array,info:B.encode("authentication"),hash:"SHA-256"},r,{name:"HMAC",hash:{name:"SHA-256"}},!0,["sign"])})}get nonce(){return this._nonce}set nonce(e){e&&e!==this._nonce&&(this._nonce=e)}setPassword(e,t){this.authKeyPromise=crypto.subtle.importKey("raw",B.encode(e),{name:"PBKDF2"},!1,["deriveKey"]).then(r=>crypto.subtle.deriveKey({name:"PBKDF2",salt:B.encode(t),iterations:100,hash:"SHA-256"},r,{name:"HMAC",hash:"SHA-256"},!0,["sign"]))}setAuthKey(e){this.authKeyPromise=crypto.subtle.importKey("raw",C(e),{name:"HMAC",hash:"SHA-256"},!0,["sign"])}async authKeyB64(){let e=await this.authKeyPromise,t=await crypto.subtle.exportKey("raw",e);return O(new Uint8Array(t))}async authHeader(){let e=await this.authKeyPromise,t=await crypto.subtle.sign({name:"HMAC"},e,C(this.nonce));return`send-v1 ${O(new Uint8Array(t))}`}async encryptMetadata(e){let t=await this.metaKeyPromise;return await crypto.subtle.encrypt({name:"AES-GCM",iv:new Uint8Array(12),tagLength:128},t,B.encode(JSON.stringify({name:e.name,size:e.size,type:e.type||"application/octet-stream",manifest:e.manifest||{}})))}encryptStream(e){return We(e,this.rawSecret)}decryptStream(e){return je(e,this.rawSecret)}async decryptMetadata(e){let t=await this.metaKeyPromise,r=await crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(12),tagLength:128},t,e);return JSON.parse(zt.decode(r))}};var ae=null;try{ae=localStorage.getItem("wssURL")}catch{}ae||(ae="wss://send.firefox.com/api/ws");var L=class extends Error{constructor(e,t,r){super(e?"0":"connection closed"),this.cancelled=e,this.duration=t,this.size=r}};var Ct="";function v(i){return Ct+i}function oe(i){let e={"Content-Type":"application/json"};return{method:"POST",headers:new Headers(e),body:JSON.stringify(i)}}function Xe(i){return i=i||"",i.split(" ")[1]}async function Ge(i,e,t){let r={};e=e||{};let n=await t.authHeader();e.headers=new Headers({Authorization:n,"Content-Type":"application/json"});let a=await fetch(i,e);r.response=a,r.ok=a.ok;let o=Xe(a.headers.get("WWW-Authenticate"));return r.shouldRetry=a.status===401&&o!==t.nonce,t.nonce=o,r}async function _t(i,e,t){let r=await Ge(i,e,t);return r.shouldRetry?Ge(i,e,t):r}async function Je(i,e){return(await fetch(v(`/api/delete/${i}`),oe({owner_token:e}))).ok}async function Ye(i,e,t){return(await fetch(v(`/api/params/${i}`),oe({owner_token:e,dlimit:t.dlimit}))).ok}async function Qe(i,e){let t=await fetch(v(`/api/info/${i}`),oe({owner_token:e}));if(t.ok)return await t.json();throw new Error(t.status)}async function et(i,e){let t=await _t(v(`/api/metadata/${i}`),{method:"GET"},e);if(t.ok){let r=await t.response.json(),n=await e.decryptMetadata(C(r.metadata));return{size:n.size,ttl:r.ttl,iv:n.iv,name:n.name,type:n.type,manifest:n.manifest}}throw new Error(t.response.status)}async function tt(i,e,t){let r=await t.authKeyB64();return(await fetch(v(`/api/password/${i}`),oe({owner_token:e,auth:r}))).ok}function Tt(i,e=1e4){return new Promise((t,r)=>{try{let n=new WebSocket(i),a=setTimeout(()=>{n.close(),r(new Error("WebSocket connection timeout"))},e);n.addEventListener("open",()=>{clearTimeout(a),t(n)},{once:!0}),n.addEventListener("error",o=>{clearTimeout(a),r(new L(!1))},{once:!0})}catch{r(new L(!1))}})}function Ze(i,e){return new Promise((t,r)=>{function n(o){i.removeEventListener("message",a),r(new L(e.cancelled))}function a(o){i.removeEventListener("close",n);try{let l=JSON.parse(o.data);if(l.error)throw new Error(l.error);t(l)}catch(l){r(l)}}i.addEventListener("message",a,{once:!0}),i.addEventListener("close",n,{once:!0})})}async function Ft(i,e,t,r,n,a,o){let l=0,d=Date.now(),m=window.location.hostname,k=window.location.port,T=window.location.protocol==="https:"?"wss:":"ws:",X=window.location.protocol==="file:"?ae:`${T}//${m}${k?":":""}${k}/api/ws`,p,J,Y=3;for(let g=0;g<Y;g++){if(o.cancelled)throw new L(!0);try{p=await Tt(X);break}catch(F){if(J=F,g<Y-1){let I=500*Math.pow(2,g);await ye(I)}}}if(!p)throw J||new L(!1);try{let F={fileMetadata:O(new Uint8Array(e)),authorization:`send-v1 ${t}`,timeLimit:r,dlimit:n},I=Ze(p,o);p.send(JSON.stringify(F));let D=await I,pe=Ze(p,o),Q=i.getReader(),U=await Q.read();for(;!U.done&&(o.cancelled&&p.close(),p.readyState===WebSocket.OPEN);){let R=U.value;for(p.send(R),a(l),l+=R.length,U=await Q.read();p.bufferedAmount>ne*2&&p.readyState===WebSocket.OPEN&&!o.cancelled;)await ye()}return p.readyState===WebSocket.OPEN&&p.send(new Uint8Array([0])),await pe,D.duration=Date.now()-d,D}catch(g){throw g.size=l,g.duration=Date.now()-d,g}finally{[WebSocket.CLOSED,WebSocket.CLOSING].includes(p.readyState)||p.close()}}function rt(i,e,t,r,n,a){let o={cancelled:!1};return{cancel:function(){o.cancelled=!0},result:Ft(i,e,t,r,n,a,o)}}async function Dt(i,e,t,r){let n=await e.authHeader(),a=new XMLHttpRequest;return r.oncancel=function(){a.abort()},new Promise(function(o,l){a.addEventListener("loadend",function(){r.oncancel=function(){};let d=a.getResponseHeader("WWW-Authenticate");if(d&&(e.nonce=Xe(d)),a.status!==200)return l(new Error(a.status));let m=new Blob([a.response]);o(m)}),a.addEventListener("progress",function(d){d.target.status===200&&t(d.loaded)}),a.open("get",v(`/api/download/blob/${i}`)),a.setRequestHeader("Authorization",n),a.responseType="blob",a.send(),t(0)})}async function it(i,e,t,r,n=2){try{return await Dt(i,e,t,r)}catch(a){if(a.message==="401"&&--n>0)return it(i,e,t,r,n);throw a}}function nt(i,e,t){let r={oncancel:function(){}};function n(){r.oncancel()}return{cancel:n,result:it(i,e,t,r)}}var ke=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117];typeof Int32Array<"u"&&(ke=new Int32Array(ke));var Mt=(i,e)=>{let t=e===0?0:~~e^-1;for(let r=0;r<i.length;r++)t=ke[(t^i[r])&255]^t>>>8;return t^-1},at=Mt;var Pt=new TextEncoder;function Nt(i=new Date){let e=i.getFullYear()-1980<<9,t=i.getMonth()+1<<5,r=i.getDate(),n=e|t|r,a=i.getHours()<<11,o=i.getMinutes()<<5,l=Math.floor(i.getSeconds()/2),d=a|o|l;return{date:n,time:d}}var Ee=class{constructor(e){this.name=Pt.encode(e.name),this.size=e.size,this.bytesRead=0,this.crc=null,this.dateTime=Nt()}get header(){let e=new ArrayBuffer(30+this.name.byteLength),t=new DataView(e);t.setUint32(0,67324752,!0),t.setUint16(4,20,!0),t.setUint16(6,2056,!0),t.setUint16(8,0,!0),t.setUint16(10,this.dateTime.time,!0),t.setUint16(12,this.dateTime.date,!0),t.setUint32(14,0,!0),t.setUint32(18,0,!0),t.setUint32(22,0,!0),t.setUint16(26,this.name.byteLength,!0),t.setUint16(28,0,!0);for(let r=0;r<this.name.byteLength;r++)t.setUint8(30+r,this.name[r]);return new Uint8Array(e)}get dataDescriptor(){let e=new ArrayBuffer(16),t=new DataView(e);return t.setUint32(0,134695760,!0),t.setUint32(4,this.crc,!0),t.setUint32(8,this.size,!0),t.setUint32(12,this.size,!0),new Uint8Array(e)}directoryRecord(e){let t=new ArrayBuffer(46+this.name.byteLength),r=new DataView(t);r.setUint32(0,33639248,!0),r.setUint16(4,20,!0),r.setUint16(6,20,!0),r.setUint16(8,2056,!0),r.setUint16(10,0,!0),r.setUint16(12,this.dateTime.time,!0),r.setUint16(14,this.dateTime.date,!0),r.setUint32(16,this.crc,!0),r.setUint32(20,this.size,!0),r.setUint32(24,this.size,!0),r.setUint16(28,this.name.byteLength,!0),r.setUint16(30,0,!0),r.setUint16(32,0,!0),r.setUint16(34,0,!0),r.setUint16(36,0,!0),r.setUint32(38,0,!0),r.setUint32(42,e,!0);for(let n=0;n<this.name.byteLength;n++)r.setUint8(46+n,this.name[n]);return new Uint8Array(t)}get byteLength(){return this.size+this.name.byteLength+30+16}append(e,t){this.bytesRead+=e.byteLength;let r=e.byteLength-Math.max(this.bytesRead-this.size,0),n=e.slice(0,r);if(this.crc=at(n,this.crc),t.enqueue(n),r<e.byteLength)return e.slice(r,e.byteLength)}};function Ot(i,e){let t=0,r=0;for(let n=0;n<i.length;n++){let a=i[n],o=a.directoryRecord(t);t+=a.byteLength,e.enqueue(o),r+=o.byteLength}e.enqueue(Kt(i.length,r,t))}function Kt(i,e,t){let r=new ArrayBuffer(22),n=new DataView(r);return n.setUint32(0,101010256,!0),n.setUint16(4,0,!0),n.setUint16(6,0,!0),n.setUint16(8,i,!0),n.setUint16(10,i,!0),n.setUint32(12,e,!0),n.setUint32(16,t,!0),n.setUint16(20,0,!0),new Uint8Array(r)}var Se=class{constructor(e,t){this.files=e,this.fileIndex=0,this.file=null,this.reader=t.getReader(),this.nextFile(),this.extra=null}nextFile(){this.file=this.files[this.fileIndex++]}async pull(e){if(!this.file)return Ot(this.files,e),e.close();if(this.file.bytesRead===0&&(e.enqueue(this.file.header),this.extra&&(this.extra=this.file.append(this.extra,e))),this.file.bytesRead>=this.file.size)return e.enqueue(this.file.dataDescriptor),this.nextFile(),this.pull(e);let t=await this.reader.read();if(t.done)return this.nextFile(),this.pull(e);this.extra=this.file.append(t.value,e)}},q=class{constructor(e,t){this.files=e.files.map(r=>new Ee(r)),this.source=t}get stream(){return new ReadableStream(new Se(this.files,this.source))}get size(){return this.files.reduce((r,n)=>r+n.byteLength*2-n.size,0)+22}};var H=class extends EventTarget{constructor(e){super(),this.keychain=new x(e.secretKey,e.nonce),e.requiresPassword&&this.keychain.setPassword(e.password,e.url),this.fileInfo=e,this.reset()}get progressRatio(){return this.progress[0]/this.progress[1]}get progressIndefinite(){return this.state!=="downloading"}get sizes(){return{partialSize:y(this.progress[0]),totalSize:y(this.progress[1])}}cancel(){this.downloadRequest&&this.downloadRequest.cancel()}reset(){this.msg="fileSizeProgress",this.state="initialized",this.progress=[0,1]}async getMetadata(){let e=await et(this.fileInfo.id,this.keychain);this.fileInfo.name=e.name,this.fileInfo.type=e.type,this.fileInfo.iv=e.iv,this.fileInfo.size=+e.size,this.fileInfo.manifest=e.manifest,this.state="ready"}sendMessageToSw(e){return new Promise((t,r)=>{let n=new MessageChannel;n.port1.onmessage=function(a){a.data===void 0?r("bad response from serviceWorker"):a.data.error!==void 0?r(a.data.error):t(a.data)},navigator.serviceWorker.controller.postMessage(e,[n.port2])})}async downloadBlob(e=!1){this.state="downloading",this.downloadRequest=await nt(this.fileInfo.id,this.keychain,t=>{this.progress=[t,this.fileInfo.size],this.dispatchEvent(new Event("progress"))});try{let t=await this.downloadRequest.result;this.downloadRequest=null,this.msg="decryptingFile",this.state="decrypting",this.dispatchEvent(new Event("decrypting"));let r=this.fileInfo.size,n=this.keychain.decryptStream(te(t));if(this.fileInfo.type==="send-archive"){let o=new q(this.fileInfo.manifest,n);n=o.stream,r=o.size}let a=await Me(n,r);e||await $t({plaintext:a,name:decodeURIComponent(this.fileInfo.name),type:this.fileInfo.type}),this.msg="downloadFinish",this.dispatchEvent(new Event("complete")),this.state="complete"}catch(t){throw this.downloadRequest=null,t}}async downloadStream(e=!1){if(!navigator.serviceWorker.controller)return console.log("Service worker NA, switching to legacy download"),this.downloadBlob(e);let t=Date.now(),r=n=>{this.progress=[n,this.fileInfo.size],this.dispatchEvent(new Event("progress"))};this.downloadRequest={cancel:()=>{this.sendMessageToSw({request:"cancel",id:this.fileInfo.id})}};try{this.state="downloading";let n={request:"init",id:this.fileInfo.id,filename:this.fileInfo.name,type:this.fileInfo.type,manifest:this.fileInfo.manifest,key:this.fileInfo.secretKey,requiresPassword:this.fileInfo.requiresPassword,password:this.fileInfo.password,url:this.fileInfo.url,size:this.fileInfo.size,nonce:this.keychain.nonce,noSave:e};if(await this.sendMessageToSw(n),r(0),e){let l=await fetch(v(`/api/download/${this.fileInfo.id}`));if(l.status!==200)throw new Error(l.status)}else{let l=`/api/download/${this.fileInfo.id}`,d=v(l);d===l&&(d=`${location.protocol}//${location.host}${l}`);let m=document.createElement("a");m.href=d,document.body.appendChild(m),m.click()}let a=0,o=0;for(;a<this.fileInfo.size;){let l=await this.sendMessageToSw({request:"progress",id:this.fileInfo.id});if(l.progress===a?o++:o=0,o>30){let d=new Error("hung download");throw d.duration=Date.now()-t,d.size=this.fileInfo.size,d.progress=a,d}a=l.progress,r(a),await N(1e3)}this.downloadRequest=null,this.msg="downloadFinish",this.dispatchEvent(new Event("complete")),this.state="complete"}catch(n){throw this.downloadRequest=null,n==="cancelled"||n.message==="400"?new Error(0):n}}download(e){return e.stream?this.downloadStream(e.noSave):this.downloadBlob(e.noSave)}};async function $t(i){return new Promise(function(e,t){let r=new DataView(i.plaintext),n=new Blob([r],{type:i.type});if(navigator.msSaveBlob)return navigator.msSaveBlob(n,i.name),e();{let a=URL.createObjectURL(n),o=document.createElement("a");o.href=a,o.download=i.name,document.body.appendChild(o),o.click(),URL.revokeObjectURL(a),setTimeout(e,100)}})}var E=class{constructor(e){if(!e.manifest)throw new Error("invalid file object");this.id=e.id,this.url=e.url,this.name=e.name,this.size=e.size,this.manifest=e.manifest,this.time=e.time,this.speed=e.speed,this.createdAt=e.createdAt,this.expiresAt=e.expiresAt,this.ownerToken=e.ownerToken,this.dlimit=e.dlimit||1,this.dtotal=e.dtotal||0,this.keychain=new x(e.secretKey,e.nonce),this._hasPassword=!!e.hasPassword,this.timeLimit=e.timeLimit}get hasPassword(){return!!this._hasPassword}get expired(){return this.dlimit===this.dtotal||Date.now()>this.expiresAt}async setPassword(e){try{return this.password=e,this._hasPassword=!0,this.keychain.setPassword(e,this.url),await tt(this.id,this.ownerToken,this.keychain)}catch(t){throw this.password=null,this._hasPassword=!1,t}}del(){return Je(this.id,this.ownerToken)}changeLimit(e){return this.dlimit!==e?(this.dlimit=e,Ye(this.id,this.ownerToken,{dlimit:e})):Promise.resolve(!0)}async updateDownloadCount(){let e=this.dtotal,t=this.dlimit;try{let r=await Qe(this.id,this.ownerToken);this.dtotal=r.dtotal,this.dlimit=r.dlimit}catch(r){r.message==="404"&&(this.dtotal=this.dlimit)}return e!==this.dtotal||t!==this.dlimit}toJSON(){return{id:this.id,url:this.url,name:this.name,size:this.size,manifest:this.manifest,time:this.time,speed:this.speed,createdAt:this.createdAt,expiresAt:this.expiresAt,secretKey:z(this.keychain.rawSecret),ownerToken:this.ownerToken,dlimit:this.dlimit,dtotal:this.dtotal,hasPassword:this.hasPassword,timeLimit:this.timeLimit}}};var V=class extends EventTarget{constructor(){super(),this.keychain=new x,this.reset()}get progressRatio(){return this.progress[0]/this.progress[1]}get progressIndefinite(){return["fileSizeProgress","notifyUploadEncryptDone"].indexOf(this.msg)===-1}get sizes(){return{partialSize:y(this.progress[0]),totalSize:y(this.progress[1])}}reset(){this.uploadRequest=null,this.msg="importingFile",this.progress=[0,1],this.cancelled=!1}cancel(){this.cancelled=!0,this.uploadRequest&&this.uploadRequest.cancel()}async upload(e){if(this.cancelled)throw new Error(0);this.msg="encryptingFile",this.dispatchEvent(new Event("encrypting"));let t=Pe(e.size),r=await this.keychain.encryptStream(e.stream),n=await this.keychain.encryptMetadata(e),a=await this.keychain.authKeyB64();if(this.uploadRequest=rt(r,n,a,e.timeLimit,e.dlimit,o=>{this.progress=[o,t],this.dispatchEvent(new Event("progress"))}),this.cancelled)throw new Error(0);this.msg="fileSizeProgress",this.dispatchEvent(new Event("progress"));try{let o=await this.uploadRequest.result;this.msg="notifyUploadEncryptDone",this.uploadRequest=null,this.progress=[1,1];let l=z(this.keychain.rawSecret);return new E({id:o.id,url:`${o.url}#${l}`,name:e.name,size:e.size,manifest:e.manifest,time:o.duration,speed:e.size/(o.duration/1e3),createdAt:Date.now(),expiresAt:Date.now()+e.timeLimit*1e3,secretKey:l,nonce:this.keychain.nonce,ownerToken:o.ownerToken,dlimit:e.dlimit,timeLimit:e.timeLimit})}catch(o){throw this.msg="errorPageHeader",this.uploadRequest=null,o}}};async function Bt(){try{let i=await crypto.subtle.generateKey({name:"AES-GCM",length:128},!0,["encrypt","decrypt"]);return await crypto.subtle.exportKey("raw",i),await crypto.subtle.encrypt({name:"AES-GCM",iv:crypto.getRandomValues(new Uint8Array(12)),tagLength:128},i,new ArrayBuffer(8)),await crypto.subtle.importKey("raw",crypto.getRandomValues(new Uint8Array(16)),"PBKDF2",!1,["deriveKey"]),await crypto.subtle.importKey("raw",crypto.getRandomValues(new Uint8Array(16)),"HKDF",!1,["deriveKey"]),await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveBits"]),!0}catch{return!1}}function qt(){try{return new ReadableStream({pull(){}}),!0}catch{return!1}}async function Ae(){let i=De(),e=/mobi|android/i.test(navigator.userAgent),t="serviceWorker"in navigator&&i!=="edge",r=await Bt(),n=qt(),a=e&&typeof navigator.share=="function"&&P().startsWith("en"),o=window.matchMedia("(display-mode: standalone)").matches||navigator.standalone;return{crypto:r,serviceWorker:t,streamUpload:n,streamDownload:n&&t&&i!=="safari"&&!(i==="firefox"&&e),multifile:n,share:a,standalone:o}}var se=class{constructor(){this.items=new Map}get length(){return this.items.size}getItem(e){return this.items.get(e)}setItem(e,t){return this.items.set(e,t)}removeItem(e){return this.items.delete(e)}key(e){return this.items.keys()[e]}},Le=class{constructor(){try{this.engine=localStorage||new se}catch{this.engine=new se}this._files=this.loadFiles()}loadFiles(){let e=new Map;for(let t=0;t<this.engine.length;t++){let r=this.engine.key(t);if(fe(r))try{let n=new E(JSON.parse(this.engine.getItem(r)));n.id||(n.id=n.fileId),e.set(n.id,n)}catch{this.engine.removeItem(r)}}return e}get id(){let e=this.engine.getItem("device_id");return e||(e=z(crypto.getRandomValues(new Uint8Array(16))),this.engine.setItem("device_id",e)),e}get totalDownloads(){return Number(this.engine.getItem("totalDownloads"))}set totalDownloads(e){this.engine.setItem("totalDownloads",e)}get totalUploads(){return Number(this.engine.getItem("totalUploads"))}set totalUploads(e){this.engine.setItem("totalUploads",e)}get referrer(){return this.engine.getItem("referrer")}set referrer(e){this.engine.setItem("referrer",e)}get enrolled(){return JSON.parse(this.engine.getItem("ab_experiments")||"{}")}enroll(e,t){let r={};r[e]=t,this.engine.setItem("ab_experiments",JSON.stringify(r))}get files(){return Array.from(this._files.values()).sort((e,t)=>e.createdAt-t.createdAt)}getFileById(e){return this._files.get(e)}get(e){return this.engine.getItem(e)}set(e,t){return this.engine.setItem(e,t)}remove(e){fe(e)&&this._files.delete(e),this.engine.removeItem(e)}addFile(e){this._files.set(e.id,e),this.writeFile(e)}writeFile(e){this.engine.setItem(e.id,JSON.stringify(e))}writeFiles(){this._files.forEach(e=>this.writeFile(e))}clearLocalFiles(){this._files.forEach(e=>this.engine.removeItem(e.id)),this._files=new Map}async merge(e=[]){let t=!1,r=!1,n=!1;for(let o of e)this.getFileById(o.id)||(this.addFile(new E(o)),t=!0);let a=this.files.slice();for(let o of a){let l=await o.updateDownloadCount();l&&await this.writeFile(o),n=n||l,r=r||o.expired,o.expired?this.remove(o.id):e.find(d=>d.id===o.id)||(r=!0)}return{incoming:t,outgoing:r,downloadCount:n}}},ot=new Le;var S=class{constructor(e){this.value=e}valueOf(){return this.value}},h=class extends S{constructor(e="???"){super(e)}toString(e){return`{${this.value}}`}},f=class extends S{constructor(e,t={}){super(e),this.opts=t}toString(e){try{return e.memoizeIntlObject(Intl.NumberFormat,this.opts).format(this.value)}catch(t){return e.reportError(t),this.value.toString(10)}}},b=class extends S{constructor(e,t={}){super(e),this.opts=t}toString(e){try{return e.memoizeIntlObject(Intl.DateTimeFormat,this.opts).format(this.value)}catch(t){return e.reportError(t),new Date(this.value).toISOString()}}};var st=100,Ht="\u2068",Vt="\u2069";function Wt(i,e,t){if(t===e||t instanceof f&&e instanceof f&&t.value===e.value)return!0;if(e instanceof f&&typeof t=="string"){let r=i.memoizeIntlObject(Intl.PluralRules,e.opts).select(e.value);if(t===r)return!0}return!1}function lt(i,e,t){return e[t]?_(i,e[t].value):(i.reportError(new RangeError("No default")),new h)}function Ie(i,e){let t=[],r=Object.create(null);for(let n of e)n.type==="narg"?r[n.name]=W(i,n.value):t.push(W(i,n));return{positional:t,named:r}}function W(i,e){switch(e.type){case"str":return e.value;case"num":return new f(e.value,{minimumFractionDigits:e.precision});case"var":return jt(i,e);case"mesg":return Gt(i,e);case"term":return Zt(i,e);case"func":return Xt(i,e);case"select":return Jt(i,e);default:return new h}}function jt(i,{name:e}){let t;if(i.params)if(Object.prototype.hasOwnProperty.call(i.params,e))t=i.params[e];else return new h(`$${e}`);else if(i.args&&Object.prototype.hasOwnProperty.call(i.args,e))t=i.args[e];else return i.reportError(new ReferenceError(`Unknown variable: $${e}`)),new h(`$${e}`);if(t instanceof S)return t;switch(typeof t){case"string":return t;case"number":return new f(t);case"object":if(t instanceof Date)return new b(t.getTime());default:return i.reportError(new TypeError(`Variable type not supported: $${e}, ${typeof t}`)),new h(`$${e}`)}}function Gt(i,{name:e,attr:t}){let r=i.bundle._messages.get(e);if(!r)return i.reportError(new ReferenceError(`Unknown message: ${e}`)),new h(e);if(t){let n=r.attributes[t];return n?_(i,n):(i.reportError(new ReferenceError(`Unknown attribute: ${t}`)),new h(`${e}.${t}`))}return r.value?_(i,r.value):(i.reportError(new ReferenceError(`No value: ${e}`)),new h(e))}function Zt(i,{name:e,attr:t,args:r}){let n=`-${e}`,a=i.bundle._terms.get(n);if(!a)return i.reportError(new ReferenceError(`Unknown term: ${n}`)),new h(n);if(t){let l=a.attributes[t];if(l){i.params=Ie(i,r).named;let d=_(i,l);return i.params=null,d}return i.reportError(new ReferenceError(`Unknown attribute: ${t}`)),new h(`${n}.${t}`)}i.params=Ie(i,r).named;let o=_(i,a.value);return i.params=null,o}function Xt(i,{name:e,args:t}){let r=i.bundle._functions[e];if(!r)return i.reportError(new ReferenceError(`Unknown function: ${e}()`)),new h(`${e}()`);if(typeof r!="function")return i.reportError(new TypeError(`Function ${e}() is not callable`)),new h(`${e}()`);try{let n=Ie(i,t);return r(n.positional,n.named)}catch(n){return i.reportError(n),new h(`${e}()`)}}function Jt(i,{selector:e,variants:t,star:r}){let n=W(i,e);if(n instanceof h)return lt(i,t,r);for(let a of t){let o=W(i,a.key);if(Wt(i,n,o))return _(i,a.value)}return lt(i,t,r)}function Ue(i,e){if(i.dirty.has(e))return i.reportError(new RangeError("Cyclic reference")),new h;i.dirty.add(e);let t=[],r=i.bundle._useIsolating&&e.length>1;for(let n of e){if(typeof n=="string"){t.push(i.bundle._transform(n));continue}if(i.placeables++,i.placeables>st)throw i.dirty.delete(e),new RangeError(`Too many placeables expanded: ${i.placeables}, max allowed is ${st}`);r&&t.push(Ht),t.push(W(i,n).toString(i)),r&&t.push(Vt)}return i.dirty.delete(e),t.join("")}function _(i,e){return typeof e=="string"?i.bundle._transform(e):Ue(i,e)}var le=class{constructor(e,t,r){this.dirty=new WeakSet,this.params=null,this.placeables=0,this.bundle=e,this.errors=t,this.args=r}reportError(e){if(!this.errors||!(e instanceof Error))throw e;this.errors.push(e)}memoizeIntlObject(e,t){let r=this.bundle._intls.get(e);r||(r={},this.bundle._intls.set(e,r));let n=JSON.stringify(t);return r[n]||(r[n]=new e(this.bundle.locales,t)),r[n]}};function ce(i,e){let t=Object.create(null);for(let[r,n]of Object.entries(i))e.includes(r)&&(t[r]=n.valueOf());return t}var ct=["unitDisplay","currencyDisplay","useGrouping","minimumIntegerDigits","minimumFractionDigits","maximumFractionDigits","minimumSignificantDigits","maximumSignificantDigits"];function ht(i,e){let t=i[0];if(t instanceof h)return new h(`NUMBER(${t.valueOf()})`);if(t instanceof f)return new f(t.valueOf(),{...t.opts,...ce(e,ct)});if(t instanceof b)return new f(t.valueOf(),{...ce(e,ct)});throw new TypeError("Invalid argument to NUMBER")}var dt=["dateStyle","timeStyle","fractionalSecondDigits","dayPeriod","hour12","weekday","era","year","month","day","hour","minute","second","timeZoneName"];function ut(i,e){let t=i[0];if(t instanceof h)return new h(`DATETIME(${t.valueOf()})`);if(t instanceof b)return new b(t.valueOf(),{...t.opts,...ce(e,dt)});if(t instanceof f)return new b(t.valueOf(),{...ce(e,dt)});throw new TypeError("Invalid argument to DATETIME")}var pt=new Map;function ft(i){let e=Array.isArray(i)?i.join(" "):i,t=pt.get(e);return t===void 0&&(t=new Map,pt.set(e,t)),t}var j=class{constructor(e,{functions:t,useIsolating:r=!0,transform:n=a=>a}={}){this._terms=new Map,this._messages=new Map,this.locales=Array.isArray(e)?e:[e],this._functions={NUMBER:ht,DATETIME:ut,...t},this._useIsolating=r,this._transform=n,this._intls=ft(e)}hasMessage(e){return this._messages.has(e)}getMessage(e){return this._messages.get(e)}addResource(e,{allowOverrides:t=!1}={}){let r=[];for(let n=0;n<e.body.length;n++){let a=e.body[n];if(a.id.startsWith("-")){if(t===!1&&this._terms.has(a.id)){r.push(new Error(`Attempt to override an existing term: "${a.id}"`));continue}this._terms.set(a.id,a)}else{if(t===!1&&this._messages.has(a.id)){r.push(new Error(`Attempt to override an existing message: "${a.id}"`));continue}this._messages.set(a.id,a)}}return r}formatPattern(e,t=null,r=null){if(typeof e=="string")return this._transform(e);let n=new le(this,r,t);try{return Ue(n,e).toString(n)}catch(a){if(n.errors&&a instanceof Error)return n.errors.push(a),new h().toString(n);throw a}}};var Re=/^(-?[a-zA-Z][\w-]*) *= */gm,mt=/\.([a-zA-Z][\w-]*) *= */y,Yt=/\*?\[/y,ze=/(-?[0-9]+(?:\.([0-9]+))?)/y,Qt=/([a-zA-Z][\w-]*)/y,gt=/([$-])?([a-zA-Z][\w-]*)(?:\.([a-zA-Z][\w-]*))?/y,er=/^[A-Z][A-Z0-9_-]*$/,de=/([^{}\n\r]+)/y,tr=/([^\\"\n\r]*)/y,wt=/\\([\\"])/y,yt=/\\u([a-fA-F0-9]{4})|\\U([a-fA-F0-9]{6})/y,rr=/^\n+/,bt=/ +$/,ir=/ *\r?\n/g,nr=/( *)$/,ar=/{\s*/y,xt=/\s*}/y,or=/\[\s*/y,sr=/\s*] */y,lr=/\s*\(\s*/y,cr=/\s*->\s*/y,dr=/\s*:\s*/y,hr=/\s*,?\s*/y,ur=/\s+/y,G=class{constructor(e){this.body=[],Re.lastIndex=0;let t=0;for(;;){let s=Re.exec(e);if(s===null)break;t=Re.lastIndex;try{this.body.push(d(s[1]))}catch(c){if(c instanceof SyntaxError)continue;throw c}}function r(s){return s.lastIndex=t,s.test(e)}function n(s,c){if(e[t]===s)return t++,!0;if(c)throw new c(`Expected ${s}`);return!1}function a(s,c){if(r(s))return t=s.lastIndex,!0;if(c)throw new c(`Expected ${s.toString()}`);return!1}function o(s){s.lastIndex=t;let c=s.exec(e);if(c===null)throw new SyntaxError(`Expected ${s.toString()}`);return t=s.lastIndex,c}function l(s){return o(s)[1]}function d(s){let c=k(),u=m();if(c===null&&Object.keys(u).length===0)throw new SyntaxError("Expected message value or attributes");return{id:s,value:c,attributes:u}}function m(){let s=Object.create(null);for(;r(mt);){let c=l(mt),u=k();if(u===null)throw new SyntaxError("Expected attribute value");s[c]=u}return s}function k(){let s;if(r(de)&&(s=l(de)),e[t]==="{"||e[t]==="}")return T(s?[s]:[],1/0);let c=U();return c?s?T([s,c],c.length):(c.value=R(c.value,rr),T([c],c.length)):s?R(s,bt):null}function T(s=[],c){for(;;){if(r(de)){s.push(l(de));continue}if(e[t]==="{"){s.push(X());continue}if(e[t]==="}")throw new SyntaxError("Unbalanced closing brace");let w=U();if(w){s.push(w),c=Math.min(c,w.length);continue}break}let u=s.length-1,A=s[u];typeof A=="string"&&(s[u]=R(A,bt));let M=[];for(let w of s)w instanceof he&&(w=w.value.slice(0,w.value.length-c)),w&&M.push(w);return M}function X(){a(ar,SyntaxError);let s=p();if(a(xt))return s;if(a(cr)){let c=g();return a(xt,SyntaxError),{type:"select",selector:s,...c}}throw new SyntaxError("Unclosed placeable")}function p(){if(e[t]==="{")return X();if(r(gt)){let[,s,c,u=null]=o(gt);if(s==="$")return{type:"var",name:c};if(a(lr)){let A=J();if(s==="-")return{type:"term",name:c,attr:u,args:A};if(er.test(c))return{type:"func",name:c,args:A};throw new SyntaxError("Function names must be all upper-case")}return s==="-"?{type:"term",name:c,attr:u,args:[]}:{type:"mesg",name:c,attr:u}}return I()}function J(){let s=[];for(;;){switch(e[t]){case")":return t++,s;case void 0:throw new SyntaxError("Unclosed argument list")}s.push(Y()),a(hr)}}function Y(){let s=p();return s.type!=="mesg"?s:a(dr)?{type:"narg",name:s.name,value:I()}:s}function g(){let s=[],c=0,u;for(;r(Yt);){n("*")&&(u=c);let A=F(),M=k();if(M===null)throw new SyntaxError("Expected variant value");s[c++]={key:A,value:M}}if(c===0)return null;if(u===void 0)throw new SyntaxError("Expected default variant");return{variants:s,star:u}}function F(){a(or,SyntaxError);let s;return r(ze)?s=D():s={type:"str",value:l(Qt)},a(sr,SyntaxError),s}function I(){if(r(ze))return D();if(e[t]==='"')return pe();throw new SyntaxError("Invalid expression")}function D(){let[,s,c=""]=o(ze),u=c.length;return{type:"num",value:parseFloat(s),precision:u}}function pe(){n('"',SyntaxError);let s="";for(;;){if(s+=l(tr),e[t]==="\\"){s+=Q();continue}if(n('"'))return{type:"str",value:s};throw new SyntaxError("Unclosed string literal")}}function Q(){if(r(wt))return l(wt);if(r(yt)){let[,s,c]=o(yt),u=parseInt(s||c,16);return u<=55295||57344<=u?String.fromCodePoint(u):"\uFFFD"}throw new SyntaxError("Unknown escape sequence")}function U(){let s=t;switch(a(ur),e[t]){case".":case"[":case"*":case"}":case void 0:return!1;case"{":return Te(e.slice(s,t))}return e[t-1]===" "?Te(e.slice(s,t)):!1}function R(s,c){return s.replace(c,"")}function Te(s){let c=s.replace(ir,`
`),u=nr.exec(s)[1].length;return new he(c,u)}}},he=class{constructor(e,t){this.value=e,this.length=t}};function vt(i,e){let t=new j(i,{useIsolating:!1});return t.addResource(new G(e)),t}var kt={an:()=>import("./chunks/an.VL7HZ7PU.js"),ar:()=>import("./chunks/ar.MDNNFNXM.js"),ast:()=>import("./chunks/ast.YTXCVFUK.js"),az:()=>import("./chunks/az.L2OFYBBD.js"),azz:()=>import("./chunks/azz.IALL55UW.js"),be:()=>import("./chunks/be.YHHVM6U3.js"),bn:()=>import("./chunks/bn.6ANL23BK.js"),br:()=>import("./chunks/br.RHRWHKGW.js"),bs:()=>import("./chunks/bs.JYMHKGB4.js"),ca:()=>import("./chunks/ca.3DLRFYVP.js"),cak:()=>import("./chunks/cak.OUITYPSY.js"),ckb:()=>import("./chunks/ckb.HTXFR3PC.js"),cs:()=>import("./chunks/cs.PUNUP5X2.js"),cy:()=>import("./chunks/cy.23LSYTO7.js"),da:()=>import("./chunks/da.QA3RJMVB.js"),de:()=>import("./chunks/de.IQ54KXRN.js"),dsb:()=>import("./chunks/dsb.3A4VSJ5P.js"),el:()=>import("./chunks/el.M73WT67K.js"),"en-CA":()=>import("./chunks/en-CA.NWDHCPBJ.js"),"en-GB":()=>import("./chunks/en-GB.M7KJVTII.js"),"en-US":()=>import("./chunks/en-US.ZOLKFVYY.js"),"es-AR":()=>import("./chunks/es-AR.ZEG7JODC.js"),"es-CL":()=>import("./chunks/es-CL.RQ7QKQPB.js"),"es-ES":()=>import("./chunks/es-ES.YGVGFCYT.js"),"es-MX":()=>import("./chunks/es-MX.U2EL5WVZ.js"),et:()=>import("./chunks/et.COFMYXN4.js"),eu:()=>import("./chunks/eu.EHANPHUK.js"),fa:()=>import("./chunks/fa.LKISU2V3.js"),fi:()=>import("./chunks/fi.FXLLIVFK.js"),fr:()=>import("./chunks/fr.YMV2DFLP.js"),"fy-NL":()=>import("./chunks/fy-NL.KD4PWHBM.js"),gn:()=>import("./chunks/gn.IKQFK6AI.js"),gor:()=>import("./chunks/gor.VKRLBEBI.js"),he:()=>import("./chunks/he.QPZVDRG4.js"),hr:()=>import("./chunks/hr.5SNKHSMK.js"),hsb:()=>import("./chunks/hsb.6556SIM7.js"),hu:()=>import("./chunks/hu.ULDJOTUH.js"),hus:()=>import("./chunks/hus.EAL7DY5F.js"),"hy-AM":()=>import("./chunks/hy-AM.H7PXNKGB.js"),ia:()=>import("./chunks/ia.42V4KM32.js"),id:()=>import("./chunks/id.2XJIIECZ.js"),ig:()=>import("./chunks/ig.4UXJ6CFZ.js"),it:()=>import("./chunks/it.VW6J4TOG.js"),ixl:()=>import("./chunks/ixl.N5QNJF4J.js"),ja:()=>import("./chunks/ja.QKV52SFX.js"),ka:()=>import("./chunks/ka.35LJMWCE.js"),kab:()=>import("./chunks/kab.UCO5I6UV.js"),ko:()=>import("./chunks/ko.SEAEINGI.js"),lt:()=>import("./chunks/lt.2O2LBL3Z.js"),lus:()=>import("./chunks/lus.YMAHHB3E.js"),meh:()=>import("./chunks/meh.SJZFVRJW.js"),mix:()=>import("./chunks/mix.AKGUN3DE.js"),ml:()=>import("./chunks/ml.ZXTF7R5Y.js"),ms:()=>import("./chunks/ms.I6EXNGCF.js"),"nb-NO":()=>import("./chunks/nb-NO.7PRU3OCJ.js"),nl:()=>import("./chunks/nl.YHBWICF7.js"),"nn-NO":()=>import("./chunks/nn-NO.ODDEKPCT.js"),oc:()=>import("./chunks/oc.L5FXW6HO.js"),"pa-IN":()=>import("./chunks/pa-IN.TFUQ44F7.js"),pai:()=>import("./chunks/pai.WSPC6FOQ.js"),pl:()=>import("./chunks/pl.HXBO4MXD.js"),ppl:()=>import("./chunks/ppl.NJJGNC3J.js"),"pt-BR":()=>import("./chunks/pt-BR.VPO37CSM.js"),"pt-PT":()=>import("./chunks/pt-PT.YU6AWRHQ.js"),quc:()=>import("./chunks/quc.EKTKJZN5.js"),ro:()=>import("./chunks/ro.5IA5LOOS.js"),ru:()=>import("./chunks/ru.C6MJ35K6.js"),sk:()=>import("./chunks/sk.WVSMSHVA.js"),sl:()=>import("./chunks/sl.SCHPPSRA.js"),sn:()=>import("./chunks/sn.INHEVR7A.js"),sq:()=>import("./chunks/sq.5YBBF37L.js"),sr:()=>import("./chunks/sr.H2L64XXX.js"),su:()=>import("./chunks/su.7LH6H3FE.js"),"sv-SE":()=>import("./chunks/sv-SE.5H6RRHRM.js"),te:()=>import("./chunks/te.HYNUI3TG.js"),th:()=>import("./chunks/th.ZQE3ZQBG.js"),tl:()=>import("./chunks/tl.YOUIEYGT.js"),tr:()=>import("./chunks/tr.NROE5YV7.js"),trs:()=>import("./chunks/trs.AUAGQ2WY.js"),uk:()=>import("./chunks/uk.3PL3RADY.js"),vi:()=>import("./chunks/vi.ELLRWA6J.js"),yo:()=>import("./chunks/yo.M34D572P.js"),yua:()=>import("./chunks/yua.DSKCH6LA.js"),zgh:()=>import("./chunks/zgh.BVWU7IGH.js"),"zh-CN":()=>import("./chunks/zh-CN.NWE6YPE4.js"),"zh-TW":()=>import("./chunks/zh-TW.ZB7Z2FY2.js")};async function Et(i){let e=[],{default:t}=await import("./chunks/en-US.ZOLKFVYY.js");if(i!=="en-US"&&kt[i]){let{default:r}=await kt[i]();e.push(vt(i,r))}return e.push(vt("en-US",t)),function(r,n){for(let a of e)if(a.hasMessage(r))return a.formatPattern(a.getMessage(r).value,n)}}function pr(i,e){for(let t of e)if(i.name===t.name&&i.size===t.size&&i.lastModified===t.lastModified)return!0;return!1}var Z=class{constructor(e=[],t=86400,r=1){this.files=Array.from(e),this.defaultTimeLimit=t,this.defaultDownloadLimit=r,this.timeLimit=t,this.dlimit=r,this.password=null,this.customArchiveName=null}get name(){if(this.files.length>1){let e=this.customArchiveName||"Send-Archive";return e.endsWith(".zip")?e:`${e}.zip`}return this.files[0].name}setArchiveName(e){this.files.length>1&&(this.customArchiveName=e)}get type(){return this.files.length>1?"send-archive":this.files[0].type}get size(){return this.files.reduce((e,t)=>e+t.size,0)}get numFiles(){return this.files.length}get manifest(){return{files:this.files.map(e=>({name:e.name,size:e.size,type:e.type}))}}get stream(){return Be(this.files.map(e=>te(e)))}addFiles(e,t,r){if(this.files.length+e.length>r)throw new Error("tooManyFiles");let n=e.filter(o=>o.size>0&&!pr(o,this.files)),a=n.reduce((o,l)=>o+l.size,0);if(this.size+a>t)throw new Error("fileTooBig");return this.files=this.files.concat(n),!0}remove(e){let t=this.files.indexOf(e);t>-1&&this.files.splice(t,1)}clear(){this.files=[],this.dlimit=this.defaultDownloadLimit,this.timeLimit=this.defaultTimeLimit,this.password=null,this.customArchiveName=null}};function St(i,e,t,r,n,a){i.width=i.height=n,e.translate(n*.5,n*.5),e.rotate(-Math.PI*.5);let o=(n-r)*.5;e.beginPath(),e.arc(0,0,o,0,Math.PI*2*a,!1),e.strokeStyle=t,e.lineCap="square",e.lineWidth=r,e.stroke()}function fr(i,e){let t=document.createElement("canvas"),r=t.getContext("2d");return St(t,r,"#efefef",5,32,1),St(t,r,e,5,32,i),t.toDataURL()}function Ce(i){var n,a,o,l;let e=document.querySelector("link[rel='icon'][sizes='32x32']");e||(e=document.createElement("link"),e.rel="icon",e.type="image/png",e.sizes="32x32",document.head.appendChild(e));let t=i*100;if(t===0||t===100){e.type="image/png";let d=(a=(n=window.WEB_UI)==null?void 0:n.CUSTOM_ASSETS)==null?void 0:a.favicon_32px;e.href=d||"/favicon.ico";return}let r=((l=(o=window.WEB_UI)==null?void 0:o.COLORS)==null?void 0:l.PRIMARY)||"#0A84FF";e.href=fr(i,r)}function mr(i){let e=Math.floor(i*100);document.title=`${e}% - Send`}function At(){document.title="Send"}function Lt(){let i=!1;return window.addEventListener("blur",()=>{i=!0}),window.addEventListener("focus",()=>{i=!1,At(),Ce(0)}),{update:e=>{i&&mr(e),Ce(e)},reset:()=>{At(),Ce(0)}}}var ue=class{constructor(e){this.root=e,this.state=null,this.handleAddFiles=this.handleAddFiles.bind(this),this.handleRemoveUpload=this.handleRemoveUpload.bind(this),this.handleUpload=this.handleUpload.bind(this),this.handleCancel=this.handleCancel.bind(this),this.handleDelete=this.handleDelete.bind(this),this.handleCopy=this.handleCopy.bind(this),this.handleShare=this.handleShare.bind(this),this.handleUpdateOptions=this.handleUpdateOptions.bind(this),this.handleMetadataRequest=this.handleMetadataRequest.bind(this),this.handleDownloadStart=this.handleDownloadStart.bind(this),this.intervals=[],this.lastRender=0,this.progressIndicators=Lt(),this.ready=this.initialize()}async initialize(){let e=await Ae();if(!e.crypto&&window.location.pathname!=="/unsupported/crypto")throw window.location.assign("/unsupported/crypto"),new Error("Crypto not supported");if(e.serviceWorker)try{await navigator.serviceWorker.register("/serviceWorker.js"),await navigator.serviceWorker.ready,console.log("[Controller] Service Worker registered")}catch(r){console.warn("[Controller] Service Worker registration failed:",r),e.streamDownload=!1}let t=await Et(P());return Ne(t),window.translate=t,this.state={LIMITS,DEFAULTS,WEB_UI,PREFS,archive:new Z([],DEFAULTS.EXPIRE_SECONDS,DEFAULTS.DOWNLOADS),capabilities:e,translate:t,storage:ot,transfer:null,fileInfo:null,locale:P()},window.appState=this.state,console.log("[Controller] Initialization complete"),this.state}async initializeUploadView(){console.log("[Controller] Initializing upload view"),await this.checkFiles()}hookupHandlers(){this.root.addEventListener("addfiles",this.handleAddFiles),this.root.addEventListener("removeupload",this.handleRemoveUpload),this.root.addEventListener("upload",this.handleUpload),this.root.addEventListener("cancel",this.handleCancel),this.root.addEventListener("delete",this.handleDelete),this.root.addEventListener("copy",this.handleCopy),this.root.addEventListener("share",this.handleShare),this.root.addEventListener("updateoptions",this.handleUpdateOptions),this.root.addEventListener("metadata-request",this.handleMetadataRequest),this.root.addEventListener("download-start",this.handleDownloadStart),this.intervals.push(setInterval(()=>this.checkFiles(),120*1e3)),this.intervals.push(setInterval(()=>this.rerenderCountdowns(),60*1e3)),console.log("[Controller] Event handlers attached")}destroyHandlers(){this.root.removeEventListener("addfiles",this.handleAddFiles),this.root.removeEventListener("removeupload",this.handleRemoveUpload),this.root.removeEventListener("upload",this.handleUpload),this.root.removeEventListener("cancel",this.handleCancel),this.root.removeEventListener("delete",this.handleDelete),this.root.removeEventListener("copy",this.handleCopy),this.root.removeEventListener("share",this.handleShare),this.root.removeEventListener("updateoptions",this.handleUpdateOptions),this.root.removeEventListener("metadata-request",this.handleMetadataRequest),this.root.removeEventListener("download-start",this.handleDownloadStart),this.intervals.forEach(e=>clearInterval(e)),this.intervals=[],console.log("[Controller] Event handlers destroyed")}async handleAddFiles(e){let{files:t}=e.detail;if(t.length<1)return;console.log("[Controller] Adding files:",t);let r=this.state.LIMITS.MAX_FILE_SIZE;try{this.state.archive.addFiles(t,r,this.state.LIMITS.MAX_FILES_PER_ARCHIVE),this._showUploadAreaError(null),this.root.currentLayout&&typeof this.root.currentLayout.refreshArchiveState=="function"&&this.root.currentLayout.refreshArchiveState()}catch(n){console.error("[Controller] Error adding files:",n),this._handleAddFilesError(n)}}handleRemoveUpload(e){let{file:t}=e.detail;console.log("[Controller] Removing upload:",t),this.state.archive.remove(t),this.state.archive.numFiles===0&&this.state.archive.clear(),this._showUploadAreaError(null),this.root.currentLayout&&typeof this.root.currentLayout.refreshArchiveState=="function"&&this.root.currentLayout.refreshArchiveState()}handleUpdateOptions(e){let{timeLimit:t,downloadLimit:r,password:n,archiveName:a}=e.detail,o=this.state.archive;o&&(typeof t=="number"&&!Number.isNaN(t)&&(o.timeLimit=t),typeof r=="number"&&!Number.isNaN(r)&&(o.dlimit=r),n!==void 0&&(o.password=n||null),a!==void 0&&(o.customArchiveName=a||null),console.log("[Controller] Updated archive options",{timeLimit:o.timeLimit,downloadLimit:o.dlimit,password:o.password?"***":null}))}async handleUpload(e){if(console.log("[Controller] Starting upload"),this.state.storage.files.length>=this.state.LIMITS.MAX_ARCHIVES_PER_USER){console.warn("[Controller] Too many archives");return}let t=this.state.archive,r=new V;r.addEventListener("progress",()=>this.updateProgress()),r.addEventListener("encrypting",()=>this.render()),r.addEventListener("complete",()=>this.render()),this.state.transfer=r,this.state.uploading=!0,this.render(),this.root.currentLayout&&typeof this.root.currentLayout.refreshArchiveState=="function"&&this.root.currentLayout.refreshArchiveState();let n=me();await N(200);try{let a=await r.upload(t);this.state.storage.totalUploads+=1,this.progressIndicators.reset(),this.state.storage.addFile(a),t.password&&await this.handlePassword({password:t.password,file:a}),console.log("[Controller] Upload complete:",a),this.state.uploading=!1,this.state.transfer=null,t.clear(),await this.state.storage.merge(),this.root.currentLayout&&this.root.currentLayout.setUploadComplete&&this.root.currentLayout.setUploadComplete(a)}catch(a){a.message==="0"?(console.log("[Controller] Upload cancelled"),me(n,!1),t.clear(),this.state.uploading=!1,this.state.transfer=null,await this.state.storage.merge(),this.render(),this.root.currentLayout&&typeof this.root.currentLayout.refreshArchiveState=="function"&&this.root.currentLayout.refreshArchiveState()):(console.error("[Controller] Upload error:",a),this.state.uploading=!1,this.state.transfer=null,this.render(),this._showUploadError(a.message||"An error occurred during upload"))}}handleCancel(e){console.log("[Controller] Cancelling upload"),this.state.transfer&&(this.state.transfer.cancel(),this.progressIndicators.reset()),this.root.currentLayout&&typeof this.root.currentLayout.refreshArchiveState=="function"&&this.root.currentLayout.refreshArchiveState()}async handleDelete(e){let{ownedFile:t}=e.detail;console.log("[Controller] Deleting file:",t);try{this.state.storage.remove(t.id),await t.del(),this.root.currentLayout&&typeof this.root.currentLayout.refreshUploadList=="function"&&this.root.currentLayout.refreshUploadList()}catch(r){console.error("[Controller] Error deleting file:",r)}}handleCopy(e){let{url:t}=e.detail;console.log("[Controller] Copying to clipboard:",t),Fe(t)}handleShare(e){let{url:t,name:r}=e.detail;console.log("[Controller] Sharing:",{url:t,name:r}),navigator.share?navigator.share({title:r,url:t}).catch(n=>console.log("[Controller] Share cancelled:",n)):this.handleCopy({detail:{url:t}})}async handlePassword({password:e,file:t}){try{this.state.settingPassword=!0,this.render(),await t.setPassword(e),this.state.storage.writeFile(t),await N(1e3)}catch(r){console.error("[Controller] Error setting password:",r),this.state.passwordSetError=r}finally{this.state.settingPassword=!1}this.render()}updateProgress(){if(!this.state.transfer)return;let e=this.state.transfer.progressRatio;if(this.root.currentLayout&&this.root.currentLayout.updateProgress){let t=this.state.transfer.progress[0],r=this.state.transfer.progress[1];this.root.currentLayout.updateProgress(e,t,r)}this.progressIndicators.update(e)}async checkFiles(){let e=await this.state.storage.merge();(e.downloadCount||e.outgoing)&&this.render()}rerenderCountdowns(){let e=Date.now(),t=this.state.storage&&this.state.storage.files.length>0,r=this.root.currentLayout&&this.root.currentLayout.tagName==="UPLOAD-LAYOUT",n=e-this.lastRender>3e4;t&&r&&n&&(console.log("[Controller] Updating countdown timers"),this.render())}render(){this.lastRender=Date.now();let e=this.root.currentLayout;e&&e.tagName==="UPLOAD-LAYOUT"&&typeof e.refreshUploadList=="function"&&e.refreshUploadList(),console.log("[Controller] Render requested")}_translate(e,t,r){let n=this.state.translate||window.translate;if(typeof n=="function")try{let a=n(e,r);if(a)return a}catch{}return t}_handleAddFilesError(e){let t="";e&&e.message==="tooManyFiles"?t=this._translate("tooManyFiles",`Too many files (max ${this.state.LIMITS.MAX_FILES_PER_ARCHIVE})`,{count:this.state.LIMITS.MAX_FILES_PER_ARCHIVE,size:y(this.state.LIMITS.MAX_FILE_SIZE)}):e&&e.message==="fileTooBig"&&(t=this._translate("fileTooBig",`That file is too big (max ${y(this.state.LIMITS.MAX_FILE_SIZE)})`,{size:y(this.state.LIMITS.MAX_FILE_SIZE)})),t?this._showUploadAreaError(t):this._showUploadAreaError(null)}_showUploadAreaError(e){let t=this.root.currentLayout;!t||!t.uploadArea||(e&&typeof t.uploadArea.showError=="function"?t.uploadArea.showError(e):e||(typeof t.uploadArea.clearError=="function"?t.uploadArea.clearError():typeof t.uploadArea.showError=="function"&&t.uploadArea.showError(null)))}_showUploadError(e){let t=this.root.currentLayout;!t||!t.uploadArea||typeof t.uploadArea.showErrorView=="function"&&t.uploadArea.showErrorView(e)}async handleMetadataRequest(e){let{fileInfo:t}=e.detail;console.log("[Controller] Metadata request for file:",t.id),this.state.fileInfo=t;let r=new H(t);try{await r.getMetadata(),this.state.transfer=r,Object.assign(this.state.fileInfo,{name:r.fileInfo.name,type:r.fileInfo.type,size:r.fileInfo.size,manifest:r.fileInfo.manifest,iv:r.fileInfo.iv}),console.log("[Controller] Metadata fetched successfully:",{name:r.fileInfo.name,size:r.fileInfo.size,type:r.fileInfo.type});let n=this.root.currentLayout;n&&typeof n.showOverviewView=="function"&&n.showOverviewView(this.state.fileInfo)}catch(n){if(console.error("[Controller] Error fetching metadata:",n),n.message==="401"){let a=this.root.currentLayout;if(a&&typeof a.showPasswordView=="function"){let o=this.state.translate||window.translate,l=o?o("passwordTryAgain"):"Incorrect password. Please try again.";a.showPasswordView(l)}}else if(n.message==="404"){let a=this.root.currentLayout;if(a&&typeof a.showErrorView=="function"){let o=this.state.translate||window.translate,l=o?o("notFoundDescription"):"File not found or expired.";a.showErrorView(l)}}else{let a=this.root.currentLayout;a&&typeof a.showErrorView=="function"&&a.showErrorView("An error occurred while fetching file information.")}}}async handleDownloadStart(e){if(console.log("[Controller] Download start"),!this.state.transfer){console.error("[Controller] No transfer (FileReceiver) in state");return}let t=this.state.transfer;t.addEventListener("progress",()=>{this.updateDownloadProgress()}),t.addEventListener("decrypting",()=>{console.log("[Controller] Decrypting file...")}),t.addEventListener("complete",()=>{console.log("[Controller] Download complete"),this.handleDownloadComplete()});try{let r=this.state.capabilities.streamDownload;await t.download({stream:r}),this.state.storage.totalDownloads+=1}catch(r){if(console.error("[Controller] Download error:",r),r.message==="0"){t.reset(),this.progressIndicators.reset();let n=this.root.currentLayout;n&&typeof n.showOverviewView=="function"&&n.showOverviewView(this.state.fileInfo)}else if(r.message==="404"){let n=this.root.currentLayout;if(n&&typeof n.showErrorView=="function"){let a=this.state.translate||window.translate,o=a?a("notFoundDescription"):"File not found or expired.";n.showErrorView(o)}}else{let n=this.root.currentLayout;n&&typeof n.showErrorView=="function"&&n.showErrorView("An error occurred during download.")}}}updateDownloadProgress(){if(!this.state.transfer)return;let e=this.state.transfer,t=e.progressRatio,r=e.progress[0],n=e.progress[1],a=this.root.currentLayout;a&&typeof a.updateProgress=="function"&&a.updateProgress(t,r,n),this.progressIndicators.update(t)}handleDownloadComplete(){console.log("[Controller] Download completed successfully"),this.progressIndicators.reset();let e=this.root.currentLayout;e&&typeof e.showFinishedView=="function"&&e.showFinishedView(),this.state.transfer=null}};var _e=class extends HTMLElement{constructor(){super(),this.currentView=null,this.currentLayout=null,this.controller=new ue(this),this._initFrame=null,this._templateMounted=!1}get state(){return this.controller?this.controller.state:null}connectedCallback(){if(!this._templateMounted){let e=document.getElementById("go-send");if(!e){console.error("Template #go-send not found");return}let t=e.content.cloneNode(!0);this.appendChild(t),this._templateMounted=!0}this._initFrame!==null&&cancelAnimationFrame(this._initFrame),this._initFrame=requestAnimationFrame(async()=>{this._initFrame=null,this.isConnected&&(await this.controller.ready,this.isConnected&&(Oe(this),this.controller.hookupHandlers()))})}disconnectedCallback(){this._initFrame!==null&&(cancelAnimationFrame(this._initFrame),this._initFrame=null),this.controller&&(this.controller.destroyHandlers(),this.controller=null)}showUploadLayout(){let e=this.querySelector("#app-content");if(!e){console.error("Slot #app-content not found in go-send template");return}e.innerHTML="";let t=document.createElement("upload-layout");e.appendChild(t),this.currentLayout=t,this.currentView="upload",this.controller&&typeof this.controller.initializeUploadView=="function"&&this.controller.initializeUploadView()}showDownloadLayout(){let e=this.querySelector("#app-content");if(!e){console.error("Slot #app-content not found in go-send template");return}e.innerHTML="";let t=document.createElement("download-layout");e.appendChild(t),this.currentLayout=t,this.currentView="download"}showErrorLayout(e){let t=this.querySelector("#app-content");if(!t){console.error("Slot #app-content not found in go-send template");return}t.innerHTML="";let r=document.createElement("error-layout");e&&r.setAttribute("message",e),t.appendChild(r),this.currentLayout=r,this.currentView="error"}};customElements.define("go-send",_e);(async function(){let e=document.querySelector("go-send");if(!e){console.warn("[Router] <go-send> element not found in DOM");return}let t=window.location.pathname;t==="/"||t.startsWith("/upload")?await It(e):t.match(/^\/download/)||t.match(/^\/[0-9a-fA-F]{10,16}/)?await gr(e):(console.warn(`[Router] Unknown route: ${t}, defaulting to upload`),await It(e)),console.log("[Router] Route initialized")})();async function It(i){console.log("[Route] Initializing upload page..."),await Promise.all([import("./chunks/upload-layout.SIDE6SWE.js"),import("./chunks/upload-area.Q5C4KB3W.js"),import("./chunks/upload-right.JFEWLAB3.js"),i.controller.ready]),i.showUploadLayout(),console.log("[Route] Upload page ready")}async function gr(i){console.log("[Route] Initializing download page..."),await Promise.all([import("./chunks/download-layout.MKQXD2B3.js"),import("./chunks/file-password.7Z7P3RM2.js"),import("./chunks/file-overview.L6TUX7I3.js"),import("./chunks/file-downloading.FUERDQ5M.js"),import("./chunks/file-finished.RNYHEDCT.js"),import("./chunks/file-error.C7CR5JEF.js"),i.controller.ready]),i.showDownloadLayout(),console.log("[Route] Download page ready")}export{gr as initDownloadRoute};
