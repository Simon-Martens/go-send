import{a as D}from"./chunk.XWW2D6K4.js";import{h as T}from"./chunk.EL6E2633.js";import{A as p,f as I,l as _,u as k,v as F}from"./chunk.NJSDOF6A.js";import"./chunk.XOPNHUSF.js";var y=class extends HTMLElement{constructor(){super(),this._afterFrame=null,this._fileInput=null,this._dragCounter=0,this._dropZone=null,this._boundFileSelect=this.handleFileSelect.bind(this),this._boundDragEnter=this.handleDragEnter.bind(this),this._boundDragOver=this.handleDragOver.bind(this),this._boundDragLeave=this.handleDragLeave.bind(this),this._boundDrop=this.handleDrop.bind(this),this._boundDropZoneClick=this.handleDropZoneClick.bind(this)}connectedCallback(){this.render()}disconnectedCallback(){this._afterFrame!==null&&(cancelAnimationFrame(this._afterFrame),this._afterFrame=null),this._fileInput&&(this._fileInput.removeEventListener("change",this._boundFileSelect),this._fileInput=null),this._removeDragListeners()}render(){let e=document.getElementById("upload-view-empty");if(!e){console.error("Template #upload-view-empty not found");return}let t=e.content.cloneNode(!0);this.innerHTML="",this.appendChild(t),this._fileInput=this.querySelector("#file-upload"),this._errorEl=this.querySelector('[data-role="error"]'),this._dropZone=this.querySelector(".border-2.border-dashed"),this._fileInput&&this._fileInput.addEventListener("change",this._boundFileSelect),this._setupDragListeners(),this._afterFrame!==null&&cancelAnimationFrame(this._afterFrame),this._afterFrame=requestAnimationFrame(()=>{this._afterFrame=null,p(this)})}setConfig({orClickText:e,addFilesLabel:t,noticeHTML:i}={}){if(typeof e=="string"){let n=this.querySelector("#orClickWithSize");n&&(n.textContent=e)}if(typeof t=="string"){let n=this.querySelector("#addFilesButton");n&&(n.textContent=t)}let s=this.querySelector("#upload-area-default-notice");s&&(i?(s.innerHTML=i,s.classList.remove("hidden")):(s.textContent="",s.classList.add("hidden")))}focusFileInput(){this._fileInput&&this._fileInput.focus()}handleFileSelect(e){let t=Array.from(e.target.files||[]);t.length!==0&&(this.dispatchEvent(new CustomEvent("addfiles",{bubbles:!0,detail:{files:t}})),e.target.value="")}setError(e){this._errorEl&&(e?(this._errorEl.textContent=e,this._errorEl.classList.remove("hidden")):(this._errorEl.textContent="",this._errorEl.classList.add("hidden")))}handleDropZoneClick(e){e.target.closest('label[for="file-upload"]')||this._fileInput&&this._fileInput.click()}_setupDragListeners(){this._dropZone&&(this._dropZone.addEventListener("dragenter",this._boundDragEnter),this._dropZone.addEventListener("dragover",this._boundDragOver),this._dropZone.addEventListener("dragleave",this._boundDragLeave),this._dropZone.addEventListener("drop",this._boundDrop),this._dropZone.addEventListener("click",this._boundDropZoneClick))}_removeDragListeners(){this._dropZone&&(this._dropZone.removeEventListener("dragenter",this._boundDragEnter),this._dropZone.removeEventListener("dragover",this._boundDragOver),this._dropZone.removeEventListener("dragleave",this._boundDragLeave),this._dropZone.removeEventListener("drop",this._boundDrop),this._dropZone.removeEventListener("click",this._boundDropZoneClick),this._dropZone=null)}handleDragEnter(e){e.preventDefault(),e.stopPropagation(),this._dragCounter++,e.dataTransfer&&e.dataTransfer.types.includes("Files")&&this._showDragFeedback()}handleDragOver(e){e.preventDefault(),e.stopPropagation()}handleDragLeave(e){e.preventDefault(),e.stopPropagation(),this._dragCounter--,this._dragCounter===0&&this._hideDragFeedback()}handleDrop(e){var i;e.preventDefault(),e.stopPropagation(),this._dragCounter=0,this._hideDragFeedback();let t=Array.from(((i=e.dataTransfer)==null?void 0:i.files)||[]);t.length>0&&this.dispatchEvent(new CustomEvent("addfiles",{bubbles:!0,detail:{files:t}}))}_showDragFeedback(){this._dropZone&&(this._dropZone.classList.remove("border-grey-transparent","dark:border-grey-60"),this._dropZone.classList.add("border-primary","bg-blue-10","dark:bg-blue-90","dark:border-blue-40"))}_hideDragFeedback(){this._dropZone&&(this._dropZone.classList.remove("border-primary","bg-blue-10","dark:bg-blue-90","dark:border-blue-40"),this._dropZone.classList.add("border-grey-transparent","dark:border-grey-60"))}};customElements.define("upload-empty-view",y);var E=class extends HTMLElement{constructor(){super(),this.elements={fileInput:null,fileList:null,uploadButton:null,totalSize:null,fileCount:null,addMoreLabel:null,expiryContainer:null,downloadLimit:null,timeLimit:null,orLabel:null,expiryLabelTop:null,expiryLabelBottom:null,passwordToggle:null,passwordToggleIcon:null,passwordField:null,passwordInput:null,passwordHint:null,passwordVisibilityButton:null,passwordVisibilityIcon:null,dropZone:null,archiveNameContainer:null,archiveNameInput:null,recipientSelect:null},this._afterFrame=null,this._users=[],this._recipientUserId=null,this._recipientPublicKey=null,this._recipientListenerAttached=!1,this._files=[],this._limits=null,this._defaults=null,this._maxFiles=0,this._translate=null,this._password="",this._passwordEnabled=!1,this._timeLimit=null,this._downloadLimit=null,this._errorMessage=null,this._dragCounter=0,this._boundFileSelect=this.handleFileSelect.bind(this),this._boundUploadClick=this.handleUploadClick.bind(this),this._boundTimeChange=this.handleTimeLimitChange.bind(this),this._boundDownloadChange=this.handleDownloadLimitChange.bind(this),this._boundPasswordInput=this.handlePasswordInput.bind(this),this._boundPasswordToggle=null,this._boundPasswordVisibility=null,this._boundDragEnter=this.handleDragEnter.bind(this),this._boundDragOver=this.handleDragOver.bind(this),this._boundDragLeave=this.handleDragLeave.bind(this),this._boundDrop=this.handleDrop.bind(this),this._boundArchiveNameInput=this.handleArchiveNameInput.bind(this),this._boundRecipientChange=this.handleRecipientChange.bind(this),this._archiveNameValid=!0}connectedCallback(){this.render()}disconnectedCallback(){this._detachListeners(),this._removeDragListeners(),this._afterFrame!==null&&(cancelAnimationFrame(this._afterFrame),this._afterFrame=null)}render(){let e=document.getElementById("upload-view-list");if(!e){console.error("Template #upload-view-list not found");return}this._detachListeners();let t=e.content.cloneNode(!0);this.innerHTML="",this.appendChild(t),this.elements.fileInput=this.querySelector("#file-upload"),this.elements.fileList=this.querySelector('[data-role="file-list"]'),this.elements.uploadButton=this.querySelector('[data-action="upload"]'),this.elements.totalSize=this.querySelector('[data-role="total-size-value"]'),this.elements.fileCount=this.querySelector('[data-role="file-count-value"]'),this.elements.addMoreLabel=this.querySelector('[data-role="add-more-label"]'),this.elements.error=this.querySelector('[data-role="error"]'),this.elements.dropZone=this.querySelector(".flex.flex-col");let i=this.querySelector("#upload-area-options-slot");if(i){let n=document.getElementById("upload-view-list-options");n&&i.childElementCount===0&&i.appendChild(n.content.cloneNode(!0)),this.elements.expiryContainer=i.querySelector('[data-role="expiry-container"]'),this.elements.downloadLimit=i.querySelector('select[data-role="download-limit"]'),this.elements.timeLimit=i.querySelector('select[data-role="time-limit"]'),this.elements.orLabel=i.querySelector('[data-role="or-label"]'),this.elements.expiryLabelTop=i.querySelector('[data-role="expiry-label-top"]'),this.elements.expiryLabelBottom=i.querySelector('[data-role="expiry-label-bottom"]'),this.elements.passwordToggle=i.querySelector('[data-role="password-toggle"]'),this.elements.passwordToggleIcon=i.querySelector('[data-role="password-toggle-icon"]'),this.elements.passwordField=i.querySelector('[data-role="password-field"]'),this.elements.passwordInput=i.querySelector('[data-role="password"]'),this.elements.passwordHint=i.querySelector('[data-role="password-hint"]'),this.elements.passwordVisibilityButton=i.querySelector('[data-role="password-visibility"]'),this.elements.passwordVisibilityIcon=i.querySelector('[data-role="password-visibility-icon"]'),this.elements.archiveNameContainer=i.querySelector('[data-role="archive-name-container"]'),this.elements.archiveNameInput=i.querySelector('[data-role="archive-name"]')}let s=this.querySelector("#upload-recipient-slot");if(s){let n=document.getElementById("upload-view-recipient");n&&s.childElementCount===0&&s.appendChild(n.content.cloneNode(!0)),this.elements.recipientSelect=s.querySelector('[data-role="recipient-select"]')}this._loadUsers(),this._attachBaseListeners(),this._setupDragListeners(),this._afterFrame!==null&&cancelAnimationFrame(this._afterFrame),this._afterFrame=requestAnimationFrame(()=>{this._afterFrame=null,p(this),this.applyPasswordState()})}setState({files:e=[],totalSize:t=0,maxFiles:i=0,limits:s=null,defaults:n=null,translate:r=null,timeLimit:o=null,downloadLimit:a=null,password:d=""}={}){this._files=Array.from(e),this._maxFiles=i||0,this._limits=s,this._defaults=n,this._translate=r,typeof o=="number"&&!Number.isNaN(o)&&(this._timeLimit=o),typeof a=="number"&&!Number.isNaN(a)&&(this._downloadLimit=a);let h=typeof d=="string"&&d.length>0;this._files.length===0?(this._passwordEnabled=!1,this._password=""):h?(this._passwordEnabled=!0,this._password=d):d===null&&!this._passwordEnabled&&(this._password="");let l=t||this._files.reduce((c,m)=>c+(m.size||0),0);this._renderFileList(),this._updateFileCount(),this._updateTotalSize(l),this._renderExpiryControls(),this._updateOptionValues(),this._updateStaticLabels(l),this._updateArchiveNameVisibility(),this.applyPasswordState(),this.updatePasswordHint(this._password.length),this.setError(this._errorMessage),this._updateUploadButtonState()}updateTotalSize(e){this._updateTotalSize(e)}setUploadEnabled(e){this.elements.uploadButton&&(this.elements.uploadButton.disabled=!e)}updateProgress(){}updateProgressText(){}_renderFileList(){if(!this.elements.fileList)return;this.elements.fileList.innerHTML="";let e=document.getElementById("upload-view-list-item");if(!e){console.error("Template #upload-view-list-item not found");return}this._files.forEach((t,i)=>{let s=e.content.cloneNode(!0),n=s.querySelector("li"),r=s.querySelector('[data-role="file-name"]'),o=s.querySelector('[data-role="file-meta"]'),a=s.querySelector('[data-action="remove"]'),d=s.querySelector('[data-role="remove-label"]'),h=s.querySelector('[data-role="file-icon"]');if(r&&(r.textContent=t.name||"Untitled"),o){let l=t.webkitRelativePath||"",c=_(t.size||0);o.textContent=l?`${c} \u2022 ${l}`:c}h&&t.name&&t.name.toLowerCase().endsWith(".zip")&&(h.className="ri-folder-6-line h-8 w-8 flex-shrink-0 text-primary mr-3 text-3xl leading-8"),d&&(d.textContent=this._translateText("deleteButtonHover","Remove file")),a&&(a.dataset.index=String(i),a.addEventListener("click",l=>this.handleRemoveClick(l))),n&&this.elements.fileList.appendChild(s)})}_renderExpiryControls(){var f,v;let e=this.elements.expiryContainer,t=this.elements.downloadLimit,i=this.elements.timeLimit;if(!e||!t||!i)return;this._detachOptionListeners();let s="__DOWNLOAD__",n="__TIMESPAN__",r=`Expires after ${s} ${this._translateText("or","or")} ${n} ends`,a=this._translateText("archiveExpiryInfo",r,{downloadCount:s,timespan:n}).split(s),d=a[0]||"",l=(a[1]||"").split(n),c=l[0]||"",m=l[1]||"";if(this.elements.expiryLabelTop){let u=d.trim()||this._translateText("expiresAfterLabel","Expires after");this.elements.expiryLabelTop.textContent=u}if(this.elements.orLabel){let u=c.trim()||this._translateText("or","or");this.elements.orLabel.textContent=u}if(this.elements.expiryLabelBottom){let u=m.trim()||this._translateText("expiresAfterSuffix","");this.elements.expiryLabelBottom.textContent=u}this._downloadLimit=this._populateSelect(t,(((f=this._defaults)==null?void 0:f.DOWNLOAD_COUNTS)||[]).filter(u=>{var w;let g=(w=this._limits)==null?void 0:w.MAX_DOWNLOADS;return g?u<=g:!0}),this._downloadLimit,u=>this._translateText("downloadCount",`${u}`,{num:u})),this._timeLimit=this._populateSelect(i,(((v=this._defaults)==null?void 0:v.EXPIRE_TIMES_SECONDS)||[]).filter(u=>{var w;let g=(w=this._limits)==null?void 0:w.MAX_EXPIRE_SECONDS;return g?u<=g:!0}),this._timeLimit,u=>this._formatExpireOption(u)),this._attachOptionListeners()}_populateSelect(e,t,i,s){if(!e)return i;let n=i!=null?String(i):null;return e.innerHTML="",t.forEach(r=>{let o=document.createElement("option");o.value=String(r),o.textContent=s(r),e.appendChild(o)}),n&&Array.from(e.options).some(r=>r.value===n)?e.value=n:e.options.length>0&&(e.selectedIndex=0),e.options.length>0?Number(e.value):i}_updateOptionValues(){if(this.elements.downloadLimit&&this._downloadLimit!==null&&this._downloadLimit!==void 0){let e=String(this._downloadLimit);Array.from(this.elements.downloadLimit.options).some(t=>t.value===e)&&(this.elements.downloadLimit.value=e)}if(this.elements.timeLimit&&this._timeLimit!==null&&this._timeLimit!==void 0){let e=String(this._timeLimit);Array.from(this.elements.timeLimit.options).some(t=>t.value===e)&&(this.elements.timeLimit.value=e)}this.elements.passwordInput&&(this.elements.passwordInput.value=this._password||"")}_updateFileCount(){if(!this.elements.fileCount)return;let e=this._files.length,t=this._translateText("fileCount",e===1?"1 file":`${e} files`,{num:e}),i=this._maxFiles?this._translateText("maxFilesPerArchive",`Max ${this._maxFiles}`,{num:this._maxFiles}):"";this.elements.fileCount.textContent=i?`${t} \u2022 ${i}`:t}_updateTotalSize(e){if(!this.elements.totalSize)return;let t=_(e||0),i=this._translateText("totalSize",`${t}`,{size:t});this.elements.totalSize.textContent=i}_updateStaticLabels(e){if(this.elements.addMoreLabel&&(this.elements.addMoreLabel.textContent=this._translateText("addFilesButton","Add more files")),this.elements.uploadButton){let t=this._translateText("uploadButton","Upload"),i=this.elements.uploadButton.querySelector("#uploadButton");i?i.textContent=t:this.elements.uploadButton.textContent=t}this._updateTotalSize(e)}_updateArchiveNameVisibility(){if(this.elements.archiveNameContainer)if(this._files.length>1){let e=this.elements.archiveNameContainer.classList.contains("hidden");this.elements.archiveNameContainer.classList.remove("hidden"),e&&p(this.elements.archiveNameContainer),this.elements.archiveNameInput&&!this.elements.archiveNameInput.value&&(this.elements.archiveNameInput.value="Send-Archive")}else this.elements.archiveNameContainer.classList.add("hidden"),this._archiveNameValid=!0,this._showArchiveNameError(null)}_attachBaseListeners(){this.elements.fileInput&&this.elements.fileInput.addEventListener("change",this._boundFileSelect),this.elements.uploadButton&&this.elements.uploadButton.addEventListener("click",this._boundUploadClick),this.elements.passwordToggle&&(this._boundPasswordToggle=this._boundPasswordToggle||this.handlePasswordToggle.bind(this),this.elements.passwordToggle.addEventListener("click",this._boundPasswordToggle)),this.elements.passwordVisibilityButton&&(this._boundPasswordVisibility=this._boundPasswordVisibility||this.togglePasswordVisibility.bind(this),this.elements.passwordVisibilityButton.addEventListener("click",this._boundPasswordVisibility)),this.elements.passwordInput&&this.elements.passwordInput.addEventListener("input",this._boundPasswordInput),this.elements.archiveNameInput&&this.elements.archiveNameInput.addEventListener("input",this._boundArchiveNameInput)}_attachOptionListeners(){this.elements.downloadLimit&&this.elements.downloadLimit.addEventListener("change",this._boundDownloadChange),this.elements.timeLimit&&this.elements.timeLimit.addEventListener("change",this._boundTimeChange)}_detachOptionListeners(){this.elements.downloadLimit&&this.elements.downloadLimit.removeEventListener("change",this._boundDownloadChange),this.elements.timeLimit&&this.elements.timeLimit.removeEventListener("change",this._boundTimeChange)}_detachListeners(){this.elements.fileInput&&this.elements.fileInput.removeEventListener("change",this._boundFileSelect),this.elements.uploadButton&&this.elements.uploadButton.removeEventListener("click",this._boundUploadClick),this.elements.passwordToggle&&this._boundPasswordToggle&&this.elements.passwordToggle.removeEventListener("click",this._boundPasswordToggle),this.elements.passwordVisibilityButton&&this._boundPasswordVisibility&&this.elements.passwordVisibilityButton.removeEventListener("click",this._boundPasswordVisibility),this.elements.passwordInput&&this.elements.passwordInput.removeEventListener("input",this._boundPasswordInput),this.elements.archiveNameInput&&this.elements.archiveNameInput.removeEventListener("input",this._boundArchiveNameInput),this._detachRecipientListener(),this._detachOptionListeners()}_formatExpireOption(e){let t=k(e),i=this._formatDuration(e);return this._translateText(t.id,i,t)}_formatDuration(e){if(e%86400===0){let n=e/86400;return n===1?"1 day":`${n} days`}if(e%3600===0){let n=e/3600;return n===1?"1 hour":`${n} hours`}if(e%60===0){let n=e/60;return n===1?"1 minute":`${n} minutes`}return`${e} seconds`}_translateText(e,t,i){try{if(typeof this._translate=="function"){let s=this._translate(e,i);if(s)return s}else if(typeof window.translate=="function"){let s=window.translate(e,i);if(s)return s}}catch{}return t}updatePasswordHint(e){this.elements.passwordHint&&(e>=4096?this.elements.passwordHint.textContent=this._translateText("maxPasswordLength","Maximum password length",{length:4096}):this.elements.passwordHint.textContent="")}handleFileSelect(e){let t=Array.from(e.target.files||[]);t.length!==0&&(this.dispatchEvent(new CustomEvent("addfiles",{bubbles:!0,detail:{files:t}})),e.target.value="")}handleUploadClick(e){if(e.preventDefault(),this._files.length>1&&this.elements.archiveNameInput){let t=this.elements.archiveNameInput.value,i=this._validateArchiveName(t);if(i){this._archiveNameValid=!1,this._showArchiveNameError(i),this._updateUploadButtonState();return}}this.dispatchEvent(new CustomEvent("upload",{bubbles:!0}))}handleRemoveClick(e){e.preventDefault(),e.stopPropagation();let t=Number.parseInt(e.currentTarget.dataset.index,10);if(Number.isNaN(t)||t<0||t>=this._files.length)return;let[i]=this._files.splice(t,1);this._renderFileList();let s=this._files.reduce((n,r)=>n+(r.size||0),0);this._updateFileCount(),this._updateTotalSize(s),this._updateArchiveNameVisibility(),this._updateUploadButtonState(),this.dispatchEvent(new CustomEvent("removeupload",{bubbles:!0,detail:{file:i,index:t}}))}handleTimeLimitChange(e){let t=Number.parseInt(e.target.value,10);Number.isNaN(t)||(this._timeLimit=t,this.dispatchEvent(new CustomEvent("updateoptions",{bubbles:!0,detail:{timeLimit:t}})))}handleDownloadLimitChange(e){let t=Number.parseInt(e.target.value,10);Number.isNaN(t)||(this._downloadLimit=t,this.dispatchEvent(new CustomEvent("updateoptions",{bubbles:!0,detail:{downloadLimit:t}})))}handlePasswordInput(e){this._password=e.target.value,this._passwordEnabled=!0,this.updatePasswordHint(this._password.length),this.dispatchEvent(new CustomEvent("updateoptions",{bubbles:!0,detail:{password:this._password||null}}))}handleArchiveNameInput(e){let t=e.target.value,i=this._validateArchiveName(t);if(i){this._archiveNameValid=!1,this._showArchiveNameError(i),this._updateUploadButtonState();return}this._archiveNameValid=!0,this._showArchiveNameError(null),this._updateUploadButtonState();let s=t.trim();this.dispatchEvent(new CustomEvent("updateoptions",{bubbles:!0,detail:{archiveName:s||null}}))}_validateArchiveName(e){if(!e||!e.trim())return null;let t=e.trim();if(/[<>:"/\\|?*]/.test(t))return"archiveNameInvalidChars";if(/[.\s]$/.test(t))return"archiveNameInvalidEnd";let s=/^(CON|PRN|AUX|NUL|COM[1-9]|LPT[1-9])$/i,n=t.replace(/\.zip$/i,"");return s.test(n)?"archiveNameReserved":null}_showArchiveNameError(e){var i;if(!this.elements.archiveNameInput)return;let t=(i=this.elements.archiveNameContainer)==null?void 0:i.querySelector('[data-role="archive-name-error"]');if(t)if(e){let s="Invalid filename";try{let n=window.translate||this._translate;if(typeof n=="function"){let r=n(e);r&&r!==e&&(s=r)}}catch(n){console.warn(`Translation failed for key: ${e}`,n)}t.textContent=s,t.classList.remove("hidden"),this.elements.archiveNameInput.classList.add("border-red-500","dark:border-red-500")}else t.textContent="",t.classList.add("hidden"),this.elements.archiveNameInput.classList.remove("border-red-500","dark:border-red-500")}_updateUploadButtonState(){if(!this.elements.uploadButton)return;let e=this._files.length>1&&!this._archiveNameValid;this.elements.uploadButton.disabled=e}setError(e){this._errorMessage=e,this.elements.error&&(e?(this.elements.error.textContent=e,this.elements.error.classList.remove("hidden")):(this.elements.error.textContent="",this.elements.error.classList.add("hidden")))}handlePasswordToggle(e){e.preventDefault(),!(!this.elements.passwordField||!this.elements.passwordToggleIcon)&&(this._passwordEnabled=!this._passwordEnabled,this._passwordEnabled||(this._password="",this.updatePasswordHint(0),this.dispatchEvent(new CustomEvent("updateoptions",{bubbles:!0,detail:{password:null}}))),this.applyPasswordState(),this._passwordEnabled&&this.elements.passwordInput&&this.elements.passwordInput.focus())}togglePasswordVisibility(e){if(e.preventDefault(),!this.elements.passwordInput||!this.elements.passwordVisibilityIcon)return;let t=this.elements.passwordInput,i=t.type==="password";t.type=i?"text":"password",this.elements.passwordVisibilityIcon.src=i?"/eye-off.svg":"/eye.svg",t.focus()}applyPasswordState(){if(!this.elements.passwordField||!this.elements.passwordToggleIcon)return;let e=this.elements.passwordToggleIcon.querySelector('[data-role="lock-icon"]');this._passwordEnabled?(this.elements.passwordField.removeAttribute("hidden"),e&&e.classList.remove("hidden"),this.elements.passwordToggleIcon.classList.add("bg-primary"),this.elements.passwordInput&&(this.elements.passwordInput.value=this._password||"",this.elements.passwordInput.type="password"),this.elements.passwordVisibilityIcon&&(this.elements.passwordVisibilityIcon.src="/eye.svg")):(this.elements.passwordField.setAttribute("hidden","hidden"),e&&e.classList.add("hidden"),this.elements.passwordToggleIcon.classList.remove("bg-primary"),this.elements.passwordInput&&(this.elements.passwordInput.value="",this.elements.passwordInput.type="password"),this.elements.passwordVisibilityIcon&&(this.elements.passwordVisibilityIcon.src="/eye.svg"))}_setupDragListeners(){this.elements.dropZone&&(this.elements.dropZone.addEventListener("dragenter",this._boundDragEnter),this.elements.dropZone.addEventListener("dragover",this._boundDragOver),this.elements.dropZone.addEventListener("dragleave",this._boundDragLeave),this.elements.dropZone.addEventListener("drop",this._boundDrop))}_removeDragListeners(){this.elements.dropZone&&(this.elements.dropZone.removeEventListener("dragenter",this._boundDragEnter),this.elements.dropZone.removeEventListener("dragover",this._boundDragOver),this.elements.dropZone.removeEventListener("dragleave",this._boundDragLeave),this.elements.dropZone.removeEventListener("drop",this._boundDrop),this.elements.dropZone=null)}handleDragEnter(e){e.preventDefault(),e.stopPropagation(),this._dragCounter++,e.dataTransfer&&e.dataTransfer.types.includes("Files")&&this._showDragFeedback()}handleDragOver(e){e.preventDefault(),e.stopPropagation()}handleDragLeave(e){e.preventDefault(),e.stopPropagation(),this._dragCounter--,this._dragCounter===0&&this._hideDragFeedback()}handleDrop(e){var i;e.preventDefault(),e.stopPropagation(),this._dragCounter=0,this._hideDragFeedback();let t=Array.from(((i=e.dataTransfer)==null?void 0:i.files)||[]);t.length>0&&this.dispatchEvent(new CustomEvent("addfiles",{bubbles:!0,detail:{files:t}}))}_showDragFeedback(){this.elements.dropZone&&this.elements.dropZone.classList.add("ring-2","ring-primary","ring-inset","bg-blue-10","dark:bg-blue-90")}_hideDragFeedback(){this.elements.dropZone&&this.elements.dropZone.classList.remove("ring-2","ring-primary","ring-inset","bg-blue-10","dark:bg-blue-90")}async _loadUsers(){if(this.elements.recipientSelect)try{let e=await T();this._users=e||[],this._populateRecipientSelect()}catch(e){console.warn("[UploadListView] Failed to load users for recipient selection",e),this._users=[]}}_populateRecipientSelect(){if(!this.elements.recipientSelect)return;let e=this.elements.recipientSelect.querySelector('[data-role="recipient-unspecified"]');if(this.elements.recipientSelect.innerHTML="",e&&this.elements.recipientSelect.appendChild(e.cloneNode(!0)),this._users.forEach(t=>{let i=document.createElement("option");i.value=String(t.id),i.textContent=t.name||t.email,i.dataset.publicKey=t.encryption_public_key,this.elements.recipientSelect.appendChild(i)}),this._users.length===1){let t=this._users[0];this.elements.recipientSelect.value=String(t.id),this.elements.recipientSelect.disabled=!0,this._recipientUserId=t.id,this._recipientPublicKey=t.encryption_public_key,this._updateRecipientHint(!0,t.name||t.email),this.dispatchEvent(new CustomEvent("updateoptions",{bubbles:!0,detail:{recipientUserId:t.id,recipientPublicKey:t.encryption_public_key,recipientName:t.name||t.email}}))}else this.elements.recipientSelect.disabled=!1;this._attachRecipientListener()}_attachRecipientListener(){this.elements.recipientSelect&&!this._recipientListenerAttached&&(this.elements.recipientSelect.addEventListener("change",this._boundRecipientChange),this._recipientListenerAttached=!0)}_detachRecipientListener(){this.elements.recipientSelect&&this._recipientListenerAttached&&(this.elements.recipientSelect.removeEventListener("change",this._boundRecipientChange),this._recipientListenerAttached=!1)}handleRecipientChange(e){var o;let t=e.target.value;if(!t){this._recipientUserId=null,this._recipientPublicKey=null,this._updateRecipientHint(!1),this.dispatchEvent(new CustomEvent("updateoptions",{bubbles:!0,detail:{recipientUserId:null,recipientPublicKey:null,recipientName:null}}));return}let i=Number.parseInt(t,10);if(Number.isNaN(i)){console.warn("[UploadListView] Invalid recipient user ID",t);return}let s=e.target.selectedOptions[0],n=s==null?void 0:s.dataset.publicKey,r=((o=s==null?void 0:s.textContent)==null?void 0:o.trim())||"";if(!n){console.warn("[UploadListView] Selected user has no public key",i);return}this._recipientUserId=i,this._recipientPublicKey=n,this._updateRecipientHint(!0),this.dispatchEvent(new CustomEvent("updateoptions",{bubbles:!0,detail:{recipientUserId:i,recipientPublicKey:n,recipientName:r}}))}_updateRecipientHint(e,t=null){let i=this.querySelector("#upload-recipient-slot");if(!i)return;let s=i.querySelector("#recipientHint");if(s)if(e){let n=s.querySelector('[data-type="lang"]');n&&(t&&this.elements.recipientSelect&&this.elements.recipientSelect.disabled?n.textContent=this._translateText("recipientLockedHint",`This upload link is restricted to uploads for ${t}`,{userName:t}):n.textContent=this._translateText("recipientHintSelected","The recipient can see, download and decrypt the file.")),s.classList.remove("hidden")}else s.classList.add("hidden")}};customElements.define("upload-list-view",E);var L=class extends HTMLElement{constructor(){super(),this._afterFrame=null,this._progressBar=null,this._progressPercent=null,this._boundHandleCancel=this.handleCancel.bind(this)}connectedCallback(){this.render(),this.addEventListener("click",this._boundHandleCancel)}disconnectedCallback(){this.removeEventListener("click",this._boundHandleCancel),this._afterFrame!==null&&(cancelAnimationFrame(this._afterFrame),this._afterFrame=null)}render(){let e=document.getElementById("upload-view-uploading");if(!e){console.error("Template #upload-view-uploading not found");return}let t=e.content.cloneNode(!0);this.innerHTML="",this.appendChild(t),this._progressBar=this.querySelector('[data-role="progress-bar"]'),this._progressPercent=this.querySelector('[data-role="progress-percent"]'),this._afterFrame!==null&&cancelAnimationFrame(this._afterFrame),this._afterFrame=requestAnimationFrame(()=>{this._afterFrame=null,p(this)})}handleCancel(e){e.target.closest('[data-action="cancel"]')&&(e.preventDefault(),e.stopPropagation(),this.dispatchEvent(new CustomEvent("cancel",{bubbles:!0,composed:!0})))}updateProgress(e,t,i){if(this._progressBar&&(this._progressBar.value=e),this._progressPercent){let s=Math.round(e*100);this._progressPercent.textContent=`${s}%`}}setFileInfo(e,t){let i=this.querySelector('[data-role="file-name"]'),s=this.querySelector('[data-role="file-size"]');i&&(i.textContent=e),s&&(s.textContent=_(t))}setExpiryInfo(e){let t=this.querySelector('[data-role="expiry-info"]');t&&(t.textContent=e)}};customElements.define("upload-uploading-view",L);var C=class extends HTMLElement{constructor(){super(),this._afterFrame=null,this._ownedFile=null,this._boundCopy=this.handleCopy.bind(this),this._boundOk=this.handleOk.bind(this),this._boundLinkClick=this.handleLinkClick.bind(this)}connectedCallback(){this.render()}disconnectedCallback(){this._afterFrame!==null&&(cancelAnimationFrame(this._afterFrame),this._afterFrame=null),this.unbindEventHandlers()}render(){let e=document.getElementById("upload-view-complete");if(!e){console.error("Template #upload-view-complete not found");return}let t=e.content.cloneNode(!0);this.innerHTML="",this.appendChild(t),this.bindEventHandlers(),this._afterFrame!==null&&cancelAnimationFrame(this._afterFrame),this._afterFrame=requestAnimationFrame(()=>{this._afterFrame=null,p(this),this._ownedFile&&this.setUploadedFile(this._ownedFile)})}bindEventHandlers(){let e=this.querySelector('[data-action="copy"]'),t=this.querySelector('[data-action="ok"]'),i=this.querySelector('[data-role="download-link"]');e&&e.addEventListener("click",this._boundCopy),t&&t.addEventListener("click",this._boundOk),i&&i.addEventListener("click",this._boundLinkClick)}unbindEventHandlers(){let e=this.querySelector('[data-action="copy"]'),t=this.querySelector('[data-action="ok"]'),i=this.querySelector('[data-role="download-link"]');e&&e.removeEventListener("click",this._boundCopy),t&&t.removeEventListener("click",this._boundOk),i&&i.removeEventListener("click",this._boundLinkClick)}setUploadedFile(e){if(!e){console.warn("No ownedFile provided to setUploadedFile");return}this._ownedFile=e;let t=this.querySelector('[data-role="filename"]');t&&e.name&&(t.textContent=e.name);let i=this.querySelector('[data-role="download-link"]');i&&e.url&&(i.value=e.url,requestAnimationFrame(()=>{i.select(),i.focus()})),this.generateQRCode(e.url);let s=this.querySelector('[data-role="copy-section"]'),n=this.querySelector('[data-role="recipient-notice-complete"]');e.recipients&&e.recipients.length>0?(s&&s.classList.add("hidden"),n&&n.classList.remove("hidden")):(s&&s.classList.remove("hidden"),n&&n.classList.add("hidden"))}generateQRCode(e){if(!e)return;let t=this.querySelector('[data-role="qr-container"]');if(t)try{let i=D(0,"L");i.addData(e),i.make();let s=i.createSvgTag({scalable:!0,cellSize:4,margin:4});t.innerHTML=s;let n=t.querySelector("svg");n&&(n.style.maxWidth="200px",n.style.height="auto")}catch(i){console.error("Error generating QR code:",i),t.innerHTML='<p class="text-sm text-grey-60">QR code unavailable</p>'}}handleCopy(e){e.preventDefault();let t=this.querySelector('[data-role="download-link"]');if(!t||!t.value)return;let i=t.value;if(I(i)){this.dispatchEvent(new CustomEvent("copy",{bubbles:!0,detail:{url:i}}));let r=e.currentTarget.querySelector('[data-role="copy-icon"]');if(r){let o=r.className;r.className="ri-check-line text-lg leading-4",setTimeout(()=>{r.className=o},2e3)}}}handleOk(e){e.preventDefault(),this.dispatchEvent(new CustomEvent("complete-acknowledged",{bubbles:!0,detail:{file:this._ownedFile}}))}handleLinkClick(e){e.currentTarget.select()}};customElements.define("upload-complete-view",C);var S=class extends HTMLElement{constructor(){super(),this._afterFrame=null,this._errorMessage=null,this._boundRetry=this.handleRetry.bind(this),this._boundOk=this.handleOk.bind(this)}connectedCallback(){this.render()}disconnectedCallback(){this._afterFrame!==null&&(cancelAnimationFrame(this._afterFrame),this._afterFrame=null),this.unbindEventHandlers()}render(){let e=document.getElementById("upload-view-error");if(!e){console.error("Template #upload-view-error not found");return}let t=e.content.cloneNode(!0);this.innerHTML="",this.appendChild(t),this.bindEventHandlers(),this._afterFrame!==null&&cancelAnimationFrame(this._afterFrame),this._afterFrame=requestAnimationFrame(()=>{this._afterFrame=null,p(this),this._errorMessage&&this.setErrorMessage(this._errorMessage)})}bindEventHandlers(){let e=this.querySelector('[data-action="retry"]'),t=this.querySelector('[data-action="ok"]');console.log("[UploadErrorView] Binding event handlers",{retryBtn:e,okBtn:t}),e&&e.addEventListener("click",this._boundRetry),t&&t.addEventListener("click",this._boundOk)}unbindEventHandlers(){let e=this.querySelector('[data-action="retry"]'),t=this.querySelector('[data-action="ok"]');e&&e.removeEventListener("click",this._boundRetry),t&&t.removeEventListener("click",this._boundOk)}setErrorMessage(e){this._errorMessage=e;let t=this.querySelector('[data-role="error-message"]');t&&e&&(t.textContent=e)}handleRetry(e){console.log("[UploadErrorView] Retry button clicked"),e.preventDefault(),this.dispatchEvent(new CustomEvent("retry",{bubbles:!0})),console.log("[UploadErrorView] Retry event dispatched")}handleOk(e){console.log("[UploadErrorView] OK button clicked"),e.preventDefault(),this.dispatchEvent(new CustomEvent("error-dismiss",{bubbles:!0})),console.log("[UploadErrorView] Error-dismiss event dispatched")}};customElements.define("upload-error-view",S);var N={empty:"upload-empty-view",list:"upload-list-view",uploading:"upload-uploading-view",complete:"upload-complete-view",error:"upload-error-view"},x=class extends HTMLElement{constructor(){super(),this._currentView=null,this._currentViewKey=null,this._app=null,this._errorMessage=null,this._isComplete=!1,this._isError=!1,this._uploadedFile=null,this._boundPaste=this.handlePaste.bind(this)}connectedCallback(){this._app||(this._app=this.closest("go-send")),window.addEventListener("paste",this._boundPaste),this.refresh()}disconnectedCallback(){window.removeEventListener("paste",this._boundPaste),this._currentView=null}refresh(){let e=this._getAppState();if(!e)return;if(this._isError){this._ensureView("error"),this._configureErrorView();return}if(this._isComplete){this._ensureView("complete"),this._configureCompleteView();return}let t=e.archive,i=!!(e.uploading&&e.transfer),s=!!(t&&t.files&&t.files.length>0),n="empty";switch(i?n="uploading":s&&(n="list"),this._ensureView(n),n){case"empty":this._configureEmptyView(e);break;case"list":this._configureListView(e);break;case"uploading":this._configureUploadingView(e);break;default:break}this._applyErrorMessage()}setUploadButtonEnabled(e){this._currentViewKey==="list"&&this._currentView&&typeof this._currentView.setUploadEnabled=="function"&&this._currentView.setUploadEnabled(e)}updateProgress(e,t,i){this._currentViewKey==="uploading"&&this._currentView&&typeof this._currentView.updateProgress=="function"?this._currentView.updateProgress(e,t,i):this._currentViewKey==="list"&&this._currentView&&typeof this._currentView.updateProgress=="function"&&this._currentView.updateProgress(e,t,i)}updateProgressText(e){this._currentViewKey==="uploading"&&this._currentView&&typeof this._currentView.setStatus=="function"?this._currentView.setStatus(e):this._currentViewKey==="list"&&this._currentView&&typeof this._currentView.updateProgressText=="function"&&this._currentView.updateProgressText(e)}ensureView(e){this._ensureView(e)}setUploadedFile(e){this._isComplete=!0,this._uploadedFile=e,this._currentViewKey==="complete"&&this._currentView&&typeof this._currentView.setUploadedFile=="function"&&this._currentView.setUploadedFile(e)}clearComplete(){this._isComplete=!1,this._uploadedFile=null,this.refresh()}showErrorView(e){console.log("[UploadArea] showErrorView() called with message:",e),this._errorMessage=e,this._isComplete=!1,this._isError=!0,this._ensureView("error"),this._configureErrorView(),console.log("[UploadArea] Error view displayed")}clearError(){console.log("[UploadArea] clearError() called"),this._isError=!1,this._errorMessage=null,console.log("[UploadArea] Error state cleared, calling refresh()"),this.refresh()}_configureErrorView(){let e=this._currentView;!e||typeof e.setErrorMessage!="function"||this._errorMessage&&e.setErrorMessage(this._errorMessage)}_ensureView(e){if(this._currentViewKey===e&&this._currentView&&this._currentView.parentElement===this)return;this.innerHTML="";let t=N[e]||N.empty,i=document.createElement(t);this.appendChild(i),this._currentView=i,this._currentViewKey=e,this._applyErrorMessage()}_configureEmptyView(e){var a;let t=this._currentView;if(!t||typeof t.setConfig!="function")return;let i=e.LIMITS||{},s=_(i.MAX_FILE_SIZE||0),n=this._translate("orClickWithSize",`or click to select files (max ${s})`,{size:s},e),r=this._translate("addFilesButton","Select files",null,e),o=((a=e.WEB_UI)==null?void 0:a.UPLOAD_AREA_NOTICE_HTML)||"";t.setConfig({orClickText:n,addFilesLabel:r,noticeHTML:o})}_configureListView(e){let t=this._currentView;if(!t||typeof t.setState!="function")return;let i=e.archive,s=e.LIMITS||{},n=e.DEFAULTS||{};t.setState({files:(i==null?void 0:i.files)||[],totalSize:(i==null?void 0:i.size)||0,maxFiles:s.MAX_FILES_PER_ARCHIVE||0,limits:s,defaults:n,translate:e.translate,timeLimit:(i==null?void 0:i.timeLimit)??null,downloadLimit:(i==null?void 0:i.dlimit)??null,password:(i==null?void 0:i.password)??""})}showError(e){this._errorMessage=e||null,this._applyErrorMessage()}_applyErrorMessage(){this._currentView&&typeof this._currentView.setError=="function"&&this._currentView.setError(this._errorMessage)}_configureUploadingView(e){let t=this._currentView;if(!t)return;let i=e.archive;if(i&&typeof t.setFileInfo=="function"&&t.setFileInfo(i.name||"File",i.size||0),i&&typeof t.setExpiryInfo=="function"){let n=Date.now()+500+(i.timeLimit||0)*1e3,r=i.dlimit||1,o=n-Date.now(),a=F(o),d=window.translate||(m=>m),h=d("downloadCount",{num:r}),l=d(a.id,a),c=d("archiveExpiryInfo",{downloadCount:h,timespan:l});t.setExpiryInfo(c)}let s=e.transfer;if(s&&typeof t.updateProgress=="function"){let n=s.progressRatio||0,[r=0,o=0]=s.progress||[];t.updateProgress(n,r,o)}}_configureCompleteView(){let e=this._currentView;!e||!this._uploadedFile||typeof e.setUploadedFile=="function"&&e.setUploadedFile(this._uploadedFile)}_getAppState(){var e;return(!this._app||!this._app.state)&&(this._app=this.closest("go-send")),((e=this._app)==null?void 0:e.state)||null}_translate(e,t,i,s){let n=(s==null?void 0:s.translate)||window.translate;if(typeof n=="function")try{let r=n(e,i);if(r)return r}catch{}return t}async handlePaste(e){var o,a,d;let t=this._getAppState();if(!t||t.uploading||this._isComplete)return;let i=(o=e.target)==null?void 0:o.type;if(["password","text","email","textarea"].includes(i)||((a=e.target)==null?void 0:a.tagName)==="TEXTAREA")return;let s=Array.from(((d=e.clipboardData)==null?void 0:d.items)||[]),n=s.filter(h=>h.kind==="file"),r=s.filter(h=>h.kind==="string");if(n.length>0){let h=n.map(async(c,m)=>{let f=c.getAsFile();if(!f)return null;let v=await this._getStringFromItem(r[m]);return new File([f],v||f.name||"file",{type:f.type})}),l=(await Promise.all(h)).filter(c=>!!c);l.length>0&&(e.preventDefault(),this.dispatchEvent(new CustomEvent("addfiles",{bubbles:!0,detail:{files:l}})))}else if(r.length>0){let h=await this._getStringFromItem(r[0]);if(h){e.preventDefault();let l=new File([h],"pasted.txt",{type:"text/plain"});this.dispatchEvent(new CustomEvent("addfiles",{bubbles:!0,detail:{files:[l]}}))}}}_getStringFromItem(e){return e?new Promise(t=>{e.getAsString(t)}):Promise.resolve("")}};customElements.define("upload-area",x);
