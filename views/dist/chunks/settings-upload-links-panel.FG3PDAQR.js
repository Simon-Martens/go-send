import{g as m,i as b}from"./chunk.RASS3VP2.js";import"./chunk.EL6E2633.js";import{A as _,f as S,y as n}from"./chunk.NJSDOF6A.js";import"./chunk.XOPNHUSF.js";var f=class extends HTMLElement{constructor(){super(),this._templateMounted=!1,this._isAdmin=!1,this._uploadLinksAdminSection=null,this._uploadLinksPlaceholder=null,this._uploadLinksForm=null,this._uploadLinksLabelInput=null,this._uploadLinksDescriptionInput=null,this._uploadLinksGeneralCheckbox=null,this._uploadLinksGeneralOption=null,this._uploadLinksSubmitButton=null,this._uploadLinksStatusEl=null,this._uploadLinksStatusIcon=null,this._uploadLinksStatusText=null,this._uploadLinksDetail=null,this._uploadLinksDetailLabel=null,this._uploadLinksDetailInput=null,this._uploadLinksDetailCopyButton=null,this._uploadLinksDetailCopyIcon=null,this._uploadLinksDetailStatus=null,this._uploadLinksTableBody=null,this._uploadLinksEmpty=null,this._uploadLinks=[],this._uploadLinksLoading=!1,this._uploadLinksSubmitting=!1,this._uploadLinksCopyResetTimeout=null,this._uploadLinksDetailLinkId=null,this._boundUploadLinksSubmit=this._handleUploadLinksSubmit.bind(this),this._boundUploadLinksAction=this._handleUploadLinksAction.bind(this),this._boundUploadLinksCopy=this._handleUploadLinksCopy.bind(this)}connectedCallback(){if(!this._templateMounted){let t=document.getElementById("settings-upload-links-panel");if(!t){console.error("Template #settings-upload-links-panel not found");return}let e=t.content.cloneNode(!0);this.appendChild(e),this._templateMounted=!0}this._isAdmin=this._checkIsAdmin(),this._cacheElements(),this._configureAccess(),_(this),this._attachListeners(),this._loadUploadLinks()}disconnectedCallback(){this._detachListeners(),this._uploadLinksCopyResetTimeout&&(clearTimeout(this._uploadLinksCopyResetTimeout),this._uploadLinksCopyResetTimeout=null),this._uploadLinksAdminSection=null,this._uploadLinksPlaceholder=null,this._uploadLinksForm=null,this._uploadLinksLabelInput=null,this._uploadLinksDescriptionInput=null,this._uploadLinksGeneralCheckbox=null,this._uploadLinksSubmitButton=null,this._uploadLinksStatusEl=null,this._uploadLinksStatusIcon=null,this._uploadLinksStatusText=null,this._uploadLinksDetail=null,this._uploadLinksDetailLabel=null,this._uploadLinksDetailInput=null,this._uploadLinksDetailCopyButton=null,this._uploadLinksDetailCopyIcon=null,this._uploadLinksDetailStatus=null,this._uploadLinksTableBody=null,this._uploadLinksEmpty=null}_checkIsAdmin(){let t=b.user;if(!t||t.role===void 0||t.role===null)return!1;let e=t.role;if(typeof e=="number")return e===m.ADMIN;if(typeof e=="string"){let a=e.trim();if(!a)return!1;let i=Number.parseInt(a,10);return Number.isNaN(i)?a.toLowerCase()==="admin":i===m.ADMIN}return!1}_cacheElements(){this._uploadLinksAdminSection=this.querySelector('[data-role="upload-links-admin"]'),this._uploadLinksPlaceholder=this.querySelector('[data-role="upload-links-placeholder"]'),this._uploadLinksForm=this.querySelector('[data-role="upload-links-form"]'),this._uploadLinksLabelInput=this.querySelector('[data-role="upload-links-label"]'),this._uploadLinksDescriptionInput=this.querySelector('[data-role="upload-links-description"]'),this._uploadLinksGeneralCheckbox=this.querySelector('[data-role="upload-links-general"]'),this._uploadLinksGeneralOption=this.querySelector('[data-role="general-option"]'),this._uploadLinksSubmitButton=this.querySelector('[data-role="upload-links-submit"]'),this._uploadLinksStatusEl=this.querySelector('[data-role="upload-links-status"]'),this._uploadLinksStatusIcon=this.querySelector('[data-role="upload-links-status-icon"]'),this._uploadLinksStatusText=this.querySelector('[data-role="upload-links-status-text"]'),this._uploadLinksDetail=this.querySelector('[data-role="upload-links-detail"]'),this._uploadLinksDetailLabel=this.querySelector('[data-role="upload-links-detail-label"]'),this._uploadLinksDetailInput=this.querySelector('[data-role="upload-links-detail-input"]'),this._uploadLinksDetailCopyButton=this.querySelector('[data-role="upload-links-copy"]'),this._uploadLinksDetailCopyIcon=this.querySelector('[data-role="upload-links-copy-icon"]'),this._uploadLinksDetailStatus=this.querySelector('[data-role="upload-links-detail-status"]'),this._uploadLinksTableBody=this.querySelector('[data-role="upload-links-table"]'),this._uploadLinksEmpty=this.querySelector('[data-role="upload-links-empty"]')}_configureAccess(){this._uploadLinksAdminSection&&this._uploadLinksAdminSection.classList.remove("hidden"),this._uploadLinksPlaceholder&&this._uploadLinksPlaceholder.classList.add("hidden"),this._uploadLinksGeneralOption&&(this._isAdmin?this._uploadLinksGeneralOption.classList.remove("hidden"):this._uploadLinksGeneralOption.classList.add("hidden"))}_attachListeners(){this._uploadLinksForm&&this._uploadLinksForm.addEventListener("submit",this._boundUploadLinksSubmit),this._uploadLinksTableBody&&this._uploadLinksTableBody.addEventListener("click",this._boundUploadLinksAction),this._uploadLinksDetailCopyButton&&this._uploadLinksDetailCopyButton.addEventListener("click",this._boundUploadLinksCopy)}_detachListeners(){this._uploadLinksForm&&this._uploadLinksForm.removeEventListener("submit",this._boundUploadLinksSubmit),this._uploadLinksTableBody&&this._uploadLinksTableBody.removeEventListener("click",this._boundUploadLinksAction),this._uploadLinksDetailCopyButton&&this._uploadLinksDetailCopyButton.removeEventListener("click",this._boundUploadLinksCopy)}async _handleUploadLinksSubmit(t){var u,r,k;if(t.preventDefault(),this._uploadLinksSubmitting)return;let e=(((u=this._uploadLinksLabelInput)==null?void 0:u.value)||"").trim(),a=(((r=this._uploadLinksDescriptionInput)==null?void 0:r.value)||"").trim(),d=this._isAdmin&&(((k=this._uploadLinksGeneralCheckbox)==null?void 0:k.checked)||!1)?2:3;if(!e){this._setUploadLinksStatus(n("settingsUploadLinksStatusLabelRequired"),"error");return}this._uploadLinksSubmitting=!0,this._uploadLinksSubmitButton&&(this._uploadLinksSubmitButton.disabled=!0,this._uploadLinksSubmitButton.classList.add("opacity-60")),this._setUploadLinksStatus(n("settingsUploadLinksStatusCreating"),"info");try{let o=await fetch("/api/upload-links",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({label:e,description:a,type:d})});if(!o.ok)throw new Error(`upload_link_create_failed_${o.status}`);let s=await o.json(),L=(s==null?void 0:s.link)||"";this._uploadLinksLabelInput&&(this._uploadLinksLabelInput.value=""),this._uploadLinksDescriptionInput&&(this._uploadLinksDescriptionInput.value=""),this._uploadLinksGeneralCheckbox&&(this._uploadLinksGeneralCheckbox.checked=!1);let p={id:Number.parseInt(s==null?void 0:s.id,10)||(s==null?void 0:s.id)||Date.now(),label:(s==null?void 0:s.label)||e,description:(s==null?void 0:s.description)||a,preview:(s==null?void 0:s.preview)||"",active:(s==null?void 0:s.active)!==void 0?!!s.active:!0,type:Number.parseInt(s==null?void 0:s.type,10)||d,user_name:(s==null?void 0:s.user_name)||"",created:Number.parseInt(s==null?void 0:s.created,10)||Math.floor(Date.now()/1e3),created_by:Number.parseInt(s==null?void 0:s.created_by,10)||(s==null?void 0:s.created_by)||null};this._uploadLinks=[p,...this._uploadLinks.filter(h=>h.id!==p.id)].sort((h,c)=>(c.created||0)-(h.created||0)),this._renderUploadLinks(),this._showUploadLinkDetail(p,L),this._setUploadLinksStatus(n("settingsUploadLinksStatusCreated"),"success")}catch(o){console.error("[SettingsUploadLinksPanel] Failed to create upload link",o),this._setUploadLinksStatus(n("settingsUploadLinksStatusError"),"error")}finally{this._uploadLinksSubmitting=!1,this._uploadLinksSubmitButton&&(this._uploadLinksSubmitButton.disabled=!1,this._uploadLinksSubmitButton.classList.remove("opacity-60"))}}_handleUploadLinksAction(t){let e=t.target.closest("button[data-action]");if(!e)return;let a=e.dataset.action,i=Number.parseInt(e.dataset.tokenId,10);!Number.isFinite(i)||i<=0||a==="revoke"&&this._revokeUploadLink(i,e)}async _revokeUploadLink(t,e){e&&(e.disabled=!0,e.classList.add("opacity-60")),this._setUploadLinksStatus(n("settingsUploadLinksStatusRevoking"),"info");try{let a=await fetch(`/api/upload-links/${t}`,{method:"DELETE"});if(!a.ok)throw new Error(`upload_link_revoke_failed_${a.status}`);this._uploadLinks=this._uploadLinks.map(i=>i.id===t?{...i,active:!1}:i),this._renderUploadLinks(),this._setUploadLinksStatus(n("settingsUploadLinksStatusRevoked"),"success"),this._uploadLinksDetailLinkId===t&&this._hideUploadLinkDetail()}catch(a){console.error("[SettingsUploadLinksPanel] Failed to revoke upload link",a),this._setUploadLinksStatus(n("settingsUploadLinksStatusRevokeError"),"error")}finally{e&&document.body.contains(e)&&(e.disabled=!1,e.classList.remove("opacity-60"))}}_showUploadLinkDetail(t,e){if(!this._uploadLinksDetail||!this._uploadLinksDetailInput)return;this._uploadLinksCopyResetTimeout&&(clearTimeout(this._uploadLinksCopyResetTimeout),this._uploadLinksCopyResetTimeout=null);let a=(t==null?void 0:t.label)||n("settingsUploadLinksLabelFallback");if(this._uploadLinksDetailLabel&&(this._uploadLinksDetailLabel.textContent=a),this._uploadLinksDetailInput.value=e||"",this._uploadLinksDetailLinkId=(t==null?void 0:t.id)??null,this._uploadLinksDetail.classList.remove("hidden"),this._uploadLinksDetailCopyIcon){let i=this._uploadLinksDetailCopyIcon.dataset.originalClass||this._uploadLinksDetailCopyIcon.className;this._uploadLinksDetailCopyIcon.dataset.originalClass=i,this._uploadLinksDetailCopyIcon.className=i}this._setUploadLinkDetailStatus(e?n("settingsUploadLinksDetailHint"):"","info")}_hideUploadLinkDetail(){this._uploadLinksDetail&&(this._uploadLinksDetail.classList.add("hidden"),this._uploadLinksDetailLinkId=null,this._uploadLinksDetailInput&&(this._uploadLinksDetailInput.value=""),this._uploadLinksDetailLabel&&(this._uploadLinksDetailLabel.textContent="\u2014"),this._setUploadLinkDetailStatus("","info"),this._uploadLinksDetailCopyIcon&&this._uploadLinksDetailCopyIcon.dataset.originalClass&&(this._uploadLinksDetailCopyIcon.className=this._uploadLinksDetailCopyIcon.dataset.originalClass))}_setUploadLinkDetailStatus(t,e="info"){if(!this._uploadLinksDetailStatus)return;let a="text-sm min-h-[1.25rem]";this._uploadLinksDetailStatus.className=`${a} text-grey-60 dark:text-grey-30`,this._uploadLinksDetailStatus.textContent=t||"",t&&(e==="success"?this._uploadLinksDetailStatus.className=`${a} text-green-600 dark:text-green-400`:e==="error"&&(this._uploadLinksDetailStatus.className=`${a} text-red-600 dark:text-red-400`))}_handleUploadLinksCopy(t){if(t.preventDefault(),!this._uploadLinksDetailInput)return;let e=this._uploadLinksDetailInput.value||"";if(!e){this._setUploadLinkDetailStatus(n("settingsUploadLinksCopyError"),"error");return}try{if(!S(e))throw new Error("clipboard_failed");if(this._setUploadLinkDetailStatus(n("settingsUploadLinksCopySuccess"),"success"),this._uploadLinksDetailCopyIcon){let i=this._uploadLinksDetailCopyIcon.dataset.originalClass||this._uploadLinksDetailCopyIcon.className;this._uploadLinksDetailCopyIcon.dataset.originalClass=i,this._uploadLinksDetailCopyIcon.className="ri-check-line text-base leading-4 text-green-600 dark:text-green-400",this._uploadLinksCopyResetTimeout&&clearTimeout(this._uploadLinksCopyResetTimeout),this._uploadLinksCopyResetTimeout=setTimeout(()=>{this._uploadLinksDetailCopyIcon&&this._uploadLinksDetailCopyIcon.dataset.originalClass&&(this._uploadLinksDetailCopyIcon.className=this._uploadLinksDetailCopyIcon.dataset.originalClass)},2e3)}}catch(a){console.error("[SettingsUploadLinksPanel] Failed to copy upload link",a),this._setUploadLinkDetailStatus(n("settingsUploadLinksCopyError"),"error"),this._uploadLinksDetailCopyIcon&&this._uploadLinksDetailCopyIcon.dataset.originalClass&&(this._uploadLinksDetailCopyIcon.className=this._uploadLinksDetailCopyIcon.dataset.originalClass)}}_setUploadLinksStatus(t,e="info"){if(!this._uploadLinksStatusEl)return;let a="text-sm min-h-[1.5rem] flex items-center gap-2";if(this._uploadLinksStatusEl.className=`${a} text-grey-60 dark:text-grey-40`,this._uploadLinksStatusText?this._uploadLinksStatusText.textContent=t||"":this._uploadLinksStatusEl.textContent=t||"",this._uploadLinksStatusIcon&&(this._uploadLinksStatusIcon.className="hidden"),!t)return;let i="ri-information-line text-grey-60 dark:text-grey-40";e==="success"?(this._uploadLinksStatusEl.className=`${a} text-green-600 dark:text-green-400`,i="ri-check-line text-green-600 dark:text-green-400"):e==="error"&&(this._uploadLinksStatusEl.className=`${a} text-red-600 dark:text-red-400`,i="ri-error-warning-line text-red-600 dark:text-red-400"),this._uploadLinksStatusIcon&&(this._uploadLinksStatusIcon.className=i)}async _loadUploadLinks(){if(!this._uploadLinksLoading){this._uploadLinksLoading=!0,this._setUploadLinksStatus(n("settingsUploadLinksStatusLoading"),"info");try{let t=await fetch("/api/upload-links",{method:"GET",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error(`upload_link_list_failed_${t.status}`);let e=await t.json(),a=Array.isArray(e==null?void 0:e.links)?e.links:[];this._uploadLinks=a.map(i=>({id:Number.parseInt(i.id,10)||i.id,label:i.label||"",description:i.description||"",preview:i.preview||"",active:!!i.active,type:Number.parseInt(i.type,10)||0,user_name:i.user_name||"",created:Number.parseInt(i.created,10)||0,created_by:Number.parseInt(i.created_by,10)||i.created_by||null})).sort((i,d)=>(d.created||0)-(i.created||0)),this._renderUploadLinks(),this._setUploadLinksStatus("","info")}catch(t){console.error("[SettingsUploadLinksPanel] Failed to load upload links",t),this._setUploadLinksStatus(n("settingsUploadLinksStatusLoadingError"),"error")}finally{this._uploadLinksLoading=!1}}}_renderUploadLinks(){if(this._uploadLinksTableBody){if(!Array.isArray(this._uploadLinks)||this._uploadLinks.length===0){this._uploadLinksTableBody.innerHTML="",this._uploadLinksEmpty&&this._uploadLinksEmpty.classList.remove("hidden");return}this._uploadLinksEmpty&&this._uploadLinksEmpty.classList.add("hidden"),this._uploadLinksTableBody.innerHTML="",this._uploadLinks.forEach(t=>{let e=this._createUploadLinkRow(t);e&&this._uploadLinksTableBody.appendChild(e)}),this._uploadLinksDetailLinkId!==null&&!this._uploadLinks.some(t=>t.id===this._uploadLinksDetailLinkId&&t.active)&&this._hideUploadLinkDetail()}}_createUploadLinkRow(t){let e=document.getElementById("settings-upload-link-item");if(!e)return console.error("Template #settings-upload-link-item not found"),null;let i=e.content.cloneNode(!0).querySelector('[data-role="upload-link-row"]');if(!i)return null;i.dataset.tokenId=String(t.id);let d=i.querySelector('[data-role="label"]');d&&(d.textContent=t.label||n("settingsUploadLinksLabelFallback"));let u=i.querySelector('[data-role="description"]');if(u){let l=(t.description||"").trim();l?(u.textContent=l,u.classList.remove("hidden")):u.classList.add("hidden")}let r=i.querySelector('[data-role="preview-badge"]'),k=i.querySelector('[data-role="preview-none"]');if(r&&k){let l=(t.preview||"").trim();l?(r.textContent=l,r.classList.remove("hidden"),k.classList.add("hidden")):(r.classList.add("hidden"),k.classList.remove("hidden"))}let o=i.querySelector('[data-role="type-user"]');if(o){let l=t.type||0,C=(t.user_name||"").trim();l===2?o.textContent=n("settingsUploadLinksTypeGeneral"):l===3?o.textContent=C||n("settingsUploadLinksTypeUserFallback"):o.textContent="\u2014"}let s=i.querySelector('[data-role="status"]'),L=s==null?void 0:s.querySelector('[data-role="status-icon"]'),p=s==null?void 0:s.querySelector('[data-role="status-text"]');if(s&&L&&p){let l="inline-flex items-center gap-2 text-xs font-medium";t.active?(s.className=`${l} text-green-600 dark:text-green-400`,L.className="ri-shield-check-line text-sm leading-4",p.textContent=n("settingsUploadLinksStatusActive")):(s.className=`${l} text-grey-60 dark:text-grey-40`,L.className="ri-forbid-2-line text-sm leading-4",p.textContent=n("settingsUploadLinksStatusRevokedLabel"))}let h=i.querySelector('[data-role="created"]');h&&(h.textContent=this._formatUploadLinkTimestamp(t.created));let c=i.querySelector('[data-role="revoke-button"]'),y=i.querySelector('[data-role="revoked-indicator"]');return c&&y&&(c.dataset.action="revoke",c.dataset.tokenId=String(t.id),t.active?c.classList.remove("hidden"):(c.remove(),y.classList.remove("hidden"))),_(i),i}_formatUploadLinkTimestamp(t){let e=Number(t);if(!Number.isFinite(e)||e<=0)return n("settingsUploadLinksCreatedUnknown");try{return new Date(e*1e3).toLocaleString(void 0,{dateStyle:"medium",timeStyle:"short"})}catch{return n("settingsUploadLinksCreatedUnknown")}}};customElements.define("settings-upload-links-panel",f);
