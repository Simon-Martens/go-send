import{A as l}from"./chunk.NJSDOF6A.js";import"./chunk.XOPNHUSF.js";var s=class extends HTMLElement{constructor(){super(),this.currentView=null,this.currentViewElement=null,this.fileInfo=null,this.app=null,this._templateMounted=!1,this._postMountFrame=null,this._boundHandlers={passwordSubmit:this.handlePasswordSubmit.bind(this),downloadStart:this.handleDownloadStart.bind(this)},this._handlersBound=!1}connectedCallback(){if(!this._templateMounted){let t=document.getElementById("download-layout");if(!t){console.error("Template #download-layout not found");return}let e=t.content.cloneNode(!0);this.appendChild(e),this._templateMounted=!0}this._postMountFrame!==null&&cancelAnimationFrame(this._postMountFrame),this._postMountFrame=requestAnimationFrame(()=>{if(this._postMountFrame=null,!!this.isConnected){if(l(this),this.app=this.closest("go-send"),this._handlersBound||(this.addEventListener("password-submit",this._boundHandlers.passwordSubmit),this.addEventListener("download-start",this._boundHandlers.downloadStart),this._handlersBound=!0),this.initializeFileInfo(),!this.fileInfo){this.showErrorView("File not found");return}this.fileInfo.requiresPassword&&!this.fileInfo.password?this.showPasswordView():this.dispatchMetadataRequest()}})}disconnectedCallback(){this._postMountFrame!==null&&(cancelAnimationFrame(this._postMountFrame),this._postMountFrame=null),this._handlersBound&&(this.removeEventListener("password-submit",this._boundHandlers.passwordSubmit),this.removeEventListener("download-start",this._boundHandlers.downloadStart),this._handlersBound=!1)}initializeFileInfo(){let t=window.downloadMetadata;if(!t||t.status===404){this.fileInfo=null;return}let{id:e,key:n}=this.parseURL();if(!e||!n){console.error("[download-layout] Invalid URL: missing file ID or secret key"),this.fileInfo=null;return}let o=window.location.href.replace(/\?.+#/,"#");this.fileInfo={id:e,secretKey:n,nonce:t.nonce,requiresPassword:t.pwd||!1,password:null,url:o,name:null,type:null,size:null,manifest:null,iv:null},console.log("[download-layout] Initialized fileInfo:",{id:this.fileInfo.id,requiresPassword:this.fileInfo.requiresPassword})}parseURL(){let t=window.location.pathname,e=window.location.hash,n=t.match(/\/(?:download\/)?([0-9a-fA-F]{10,16})/),o=n?n[1]:null,i=e?e.substring(1):null;return{id:o,key:i}}dispatchMetadataRequest(){let t=new CustomEvent("metadata-request",{detail:{fileInfo:this.fileInfo},bubbles:!0});this.dispatchEvent(t)}handlePasswordSubmit(t){let{password:e}=t.detail;console.log("[download-layout] Password submitted"),t.stopPropagation(),this.fileInfo.password=e,this.dispatchMetadataRequest()}handleDownloadStart(t){console.log("[download-layout] Download start requested"),this.showDownloadingView()}showPasswordView(t=null){this._switchView("password","file-password-view",e=>{t&&typeof e.setError=="function"&&e.setError(t)})}showOverviewView(t){t&&(this.fileInfo={...this.fileInfo,...t}),this._switchView("overview","file-overview-view",e=>{typeof e.setFileInfo=="function"&&e.setFileInfo(this.fileInfo)})}showDownloadingView(){this._switchView("downloading","file-downloading-view",t=>{this.fileInfo&&typeof t.setFileInfo=="function"&&t.setFileInfo(this.fileInfo.name||"File",this.fileInfo.size||0)})}showFinishedView(){this._switchView("finished","file-finished-view")}showErrorView(t){this._switchView("error","file-error-view",e=>{typeof e.setError=="function"?e.setError(t):e.textContent=t})}updateProgress(t,e,n){this.currentView==="downloading"&&this.currentViewElement&&typeof this.currentViewElement.updateProgress=="function"&&this.currentViewElement.updateProgress(t,e,n)}_switchView(t,e,n=null){let o=this.querySelector("#download-content");if(!o){console.error("[download-layout] Container #download-content not found");return}o.innerHTML="";let i=document.createElement(e);o.appendChild(i),this.currentView=t,this.currentViewElement=i,n&&n(i),console.log(`[download-layout] Switched to view: ${t}`)}};customElements.define("download-layout",s);
