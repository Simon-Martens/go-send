function $(r){let e="";for(let n=0;n<r.length;n+=32768)e+=String.fromCharCode(...r.subarray(n,n+32768));return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function D(r){let e=r.replace(/-/g,"+").replace(/_/g,"/")+"===".slice((r.length+3)%4),t=atob(e),n=new Uint8Array(t.length);for(let s=0;s<t.length;s++)n[s]=t.charCodeAt(s);return n}function g(r){let e=r.reduce((s,o)=>s+o.length,0),t=new Uint8Array(e),n=0;for(let s of r)t.set(s,n),n+=s.length;return t}function U(r,e){return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint32(e,!1)}function C(r,e,t){new DataView(r.buffer,r.byteOffset,r.byteLength).setUint32(e,t,!1)}function O(r,e){return r[e]}function M(r,e,t){r[e]=t}function R(r=100){return new Promise(e=>setTimeout(e,r))}function p(r,e={},t){let n=r.getReader(),s=e||{};return new ReadableStream({async start(o){s.start&&await s.start(o)},async pull(o){for(;;){let{value:c,done:i}=await n.read();if(i){s.flush&&await s.flush(o),n.releaseLock(),o.close();return}if(!s.transform){o.enqueue(c);return}let a=!1,d={enqueue(m){a=!0,o.enqueue(m)}};if(await s.transform(c,d),a)return}},cancel(o){n.cancel(o),s.cancel&&s.cancel(o),t&&t(o)}})}var P=class{constructor(e,t){this.blob=e,this.index=0,this.chunkSize=t||1024*64}pull(e){return new Promise((t,n)=>{let s=this.blob.size-this.index;if(s<=0)return e.close(),t();let o=Math.min(this.chunkSize,s),c=this.blob.slice(this.index,this.index+o),i=new FileReader;i.onload=()=>{e.enqueue(new Uint8Array(i.result)),t()},i.onerror=n,i.readAsArrayBuffer(c),this.index+=o})}};function ae(r,e){return new ReadableStream(new P(r,e))}var L=class{constructor(e){this.streams=e,this.index=0,this.reader=null,this.nextReader()}nextReader(){let e=this.streams[this.index++];this.reader=e&&e.getReader()}async pull(e){if(!this.reader)return e.close();let t=await this.reader.read();if(t.done)return this.nextReader(),this.pull(e);e.enqueue(t.value)}};function ce(r){return new ReadableStream(new L(r))}var Q=12,I=16,y=16,z="encrypt",G="decrypt",x=1024*64,F=new TextEncoder;function ee(r){let e=new Uint8Array(r);return crypto.getRandomValues(e),e.buffer}var b=class{constructor(e,t,n,s){this.mode=e,this.prevChunk,this.seq=0,this.firstchunk=!0,this.rs=n,this.ikm=t.buffer,this.salt=s}async generateKey(){let e=await crypto.subtle.importKey("raw",this.ikm,"HKDF",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"HKDF",salt:this.salt,info:F.encode("Content-Encoding: aes128gcm\0"),hash:"SHA-256"},e,{name:"AES-GCM",length:128},!0,["encrypt","decrypt"])}async generateNonceBase(){let e=await crypto.subtle.importKey("raw",this.ikm,"HKDF",!1,["deriveKey"]),t=await crypto.subtle.exportKey("raw",await crypto.subtle.deriveKey({name:"HKDF",salt:this.salt,info:F.encode("Content-Encoding: nonce\0"),hash:"SHA-256"},e,{name:"AES-GCM",length:128},!0,["encrypt","decrypt"]));return new Uint8Array(t.slice(0,Q))}generateNonce(e){if(e>4294967295)throw new Error("record sequence number exceeds limit");let t=new Uint8Array(this.nonceBase),s=(U(t,t.length-4)^e)>>>0;return C(t,t.length-4,s),t}pad(e,t){let n=e.length;if(n+I>=this.rs)throw new Error("data too large for record size");if(t){let s=new Uint8Array(1);return s[0]=2,g([e,s])}else{let s=new Uint8Array(this.rs-n-I);return s[0]=1,g([e,s])}}unpad(e,t){for(let n=e.length-1;n>=0;n--)if(e[n]){if(t){if(e[n]!==2)throw new Error("delimiter of final record is not 2")}else if(e[n]!==1)throw new Error("delimiter of not final record is not 1");return e.slice(0,n)}throw new Error("no delimiter found")}createHeader(){let e=new Uint8Array(5);return C(e,0,this.rs),M(e,4,0),g([new Uint8Array(this.salt),e])}readHeader(e){if(e.length<21)throw new Error("chunk too small for reading header");let t={};t.salt=e.buffer.slice(0,y),t.rs=U(e,y);let n=O(e,y+4);return t.length=n+y+5,t}async encryptRecord(e,t,n){let s=this.generateNonce(t),o=await crypto.subtle.encrypt({name:"AES-GCM",iv:s},this.key,this.pad(e,n));return new Uint8Array(o)}async decryptRecord(e,t,n){let s=this.generateNonce(t),o=await crypto.subtle.decrypt({name:"AES-GCM",iv:s,tagLength:128},this.key,e);return this.unpad(new Uint8Array(o),n)}async start(e){if(this.mode===z)this.key=await this.generateKey(),this.nonceBase=await this.generateNonceBase(),e.enqueue(this.createHeader());else if(this.mode!==G)throw new Error("mode must be either encrypt or decrypt")}async transformPrevChunk(e,t){if(this.mode===z)t.enqueue(await this.encryptRecord(this.prevChunk,this.seq,e)),this.seq++;else{if(this.seq===0){let n=this.readHeader(this.prevChunk);this.salt=n.salt,this.rs=n.rs,this.key=await this.generateKey(),this.nonceBase=await this.generateNonceBase()}else t.enqueue(await this.decryptRecord(this.prevChunk,this.seq-1,e));this.seq++}}async transform(e,t){this.firstchunk||await this.transformPrevChunk(!1,t),this.firstchunk=!1,this.prevChunk=new Uint8Array(e.buffer)}async flush(e){this.prevChunk&&await this.transformPrevChunk(!0,e)}},S=class{constructor(e,t){this.mode=t,this.rs=e,this.chunkSize=t===z?e-17:21,this.partialChunk=new Uint8Array(this.chunkSize),this.offset=0}send(e,t){t.enqueue(e),this.chunkSize===21&&this.mode===G&&(this.chunkSize=this.rs),this.partialChunk=new Uint8Array(this.chunkSize),this.offset=0}transform(e,t){let n=0;if(this.offset>0){let s=Math.min(e.byteLength,this.chunkSize-this.offset);this.partialChunk.set(e.slice(0,s),this.offset),this.offset+=s,n+=s,this.offset===this.chunkSize&&this.send(this.partialChunk,t)}for(;n<e.byteLength;){let s=e.byteLength-n;if(s>=this.chunkSize){let o=e.slice(n,n+this.chunkSize);n+=this.chunkSize,this.send(o,t)}else{let o=e.slice(n,n+s);n+=o.byteLength,this.partialChunk.set(o),this.offset=o.byteLength}}}flush(e){this.offset>0&&e.enqueue(this.partialChunk.slice(0,this.offset))}};function fe(r,e,t=x,n=ee(y)){let s="encrypt",o=p(r,new S(t,s));return p(o,new b(s,e,t,n))}function de(r,e,t=x){let n="decrypt",s=p(r,new S(t,n));return p(s,new b(n,e,t))}var E=null;try{E=localStorage.getItem("wssURL")}catch{}E||(E="wss://send.firefox.com/api/ws");var w=class extends Error{constructor(e,t,n){super(e?"0":"connection closed"),this.cancelled=e,this.duration=t,this.size=n}};var te="";function f(r){return te+r}function k(r){let e={"Content-Type":"application/json"};return{method:"POST",headers:new Headers(e),body:JSON.stringify(r)}}async function me(){let r=await fetch(f("/api/users"));if(r.ok)return(await r.json()).users||[];throw new Error(r.status)}async function ge(r=1){let e=await fetch(f(`/api/logs?page=${r}`));if(e.ok){let t=await e.json();return{logs:t.logs||[],currentPage:t.currentPage||r,totalCount:t.totalCount||0}}throw new Error(e.status)}function V(r){return r=r||"",r.split(" ")[1]}async function _(r,e,t){let n={};e=e||{};let s=await t.authHeader();e.headers=new Headers({Authorization:s,"Content-Type":"application/json"});let o=await fetch(r,e);n.response=o,n.ok=o.ok;let c=V(o.headers.get("WWW-Authenticate"));return n.shouldRetry=o.status===401&&c!==t.nonce,t.nonce=c,n}async function ne(r,e,t){let n=await _(r,e,t);return n.shouldRetry?_(r,e,t):n}async function be(r,e){return(await fetch(f(`/api/delete/${r}`),k({owner_token:e}))).ok}async function Se(r,e,t){return(await fetch(f(`/api/params/${r}`),k({owner_token:e,dlimit:t.dlimit}))).ok}async function xe(r,e){let t=await fetch(f(`/api/info/${r}`),k({owner_token:e}));if(t.ok)return await t.json();throw new Error(t.status)}async function Ee(r,e){let t=await ne(f(`/api/metadata/${r}`),{method:"GET"},e);if(t.ok){let n=await t.response.json(),s=await e.decryptMetadata(D(n.metadata));return{size:s.size,ttl:n.ttl,iv:s.iv,name:s.name,type:s.type,manifest:s.manifest}}throw new Error(t.response.status)}async function ke(r,e,t){let n=await t.authKeyB64();return(await fetch(f(`/api/password/${r}`),k({owner_token:e,auth:n}))).ok}function re(r,e=1e4){return new Promise((t,n)=>{try{let s=new WebSocket(r),o=setTimeout(()=>{s.close(),n(new Error("WebSocket connection timeout"))},e);s.addEventListener("open",()=>{clearTimeout(o),t(s)},{once:!0}),s.addEventListener("error",c=>{clearTimeout(o),n(new w(!1))},{once:!0})}catch{n(new w(!1))}})}function j(r,e){return new Promise((t,n)=>{function s(c){r.removeEventListener("message",o),n(new w(e.cancelled))}function o(c){r.removeEventListener("close",s);try{let i=JSON.parse(c.data);if(i.error)throw new Error(i.error);t(i)}catch(i){n(i)}}r.addEventListener("message",o,{once:!0}),r.addEventListener("close",s,{once:!0})})}async function se(r,e,t,n,s,o,c,i,a){let d=0,m=Date.now(),J=window.location.hostname,H=window.location.port,Y=window.location.protocol==="https:"?"wss:":"ws:",Z=window.location.protocol==="file:"?E:`${Y}//${J}${H?":":""}${H}/api/ws`,u,T,K=3;for(let l=0;l<K;l++){if(c.cancelled)throw new w(!0);try{u=await re(Z);break}catch(h){if(T=h,l<K-1){let A=500*Math.pow(2,l);await R(A)}}}if(!u)throw T||new w(!1);try{let h={fileMetadata:$(new Uint8Array(e)),authorization:`send-v1 ${t}`,timeLimit:n,dlimit:s};i&&i.ciphertext&&i.nonce&&i.ephemeralPublicKey&&(h.ownerSecretCiphertext=i.ciphertext,h.ownerSecretNonce=i.nonce,h.ownerSecretEphemeralPub=i.ephemeralPublicKey,i.version!=null&&(h.ownerSecretVersion=i.version)),a&&a.userId&&a.ciphertext&&a.nonce&&a.ephemeralPublicKey&&(h.recipientUserId=a.userId,h.recipientSecretCiphertext=a.ciphertext,h.recipientSecretNonce=a.nonce,h.recipientSecretEphemeralPub=a.ephemeralPublicKey,a.version!=null&&(h.recipientSecretVersion=a.version));let A=j(u,c);u.send(JSON.stringify(h));let N=await A,X=j(u,c),q=r.getReader(),v=await q.read();for(;!v.done&&(c.cancelled&&u.close(),u.readyState===WebSocket.OPEN);){let B=v.value;for(u.send(B),o(d),d+=B.length,v=await q.read();u.bufferedAmount>x*2&&u.readyState===WebSocket.OPEN&&!c.cancelled;)await R()}return u.readyState===WebSocket.OPEN&&u.send(new Uint8Array([0])),await X,N.duration=Date.now()-m,N}catch(l){throw l.size=d,l.duration=Date.now()-m,l}finally{[WebSocket.CLOSED,WebSocket.CLOSING].includes(u.readyState)||u.close()}}function Ae(r,e,t,n,s,o,c=null,i=null){let a={cancelled:!1};return{cancel:function(){a.cancelled=!0},result:se(r,e,t,n,s,o,a,c,i)}}async function oe(r,e,t,n){let s=await e.authHeader(),o=new XMLHttpRequest;return n.oncancel=function(){o.abort()},new Promise(function(c,i){o.addEventListener("loadend",function(){n.oncancel=function(){};let a=o.getResponseHeader("WWW-Authenticate");if(a&&(e.nonce=V(a)),o.status!==200)return i(new Error(o.status));let d=new Blob([o.response]);c(d)}),o.addEventListener("progress",function(a){a.target.status===200&&t(a.loaded)}),o.open("get",f(`/api/download/blob/${r}`)),o.setRequestHeader("Authorization",s),o.responseType="blob",o.send(),t(0)})}async function W(r,e,t,n,s=2){try{return await oe(r,e,t,n)}catch(o){if(o.message==="401"&&--s>0)return W(r,e,t,n,s);throw o}}function ve(r,e,t){let n={oncancel:function(){}};function s(){n.oncancel()}return{cancel:s,result:W(r,e,t,n)}}export{$ as a,D as b,ae as c,ce as d,fe as e,de as f,f as g,me as h,ge as i,be as j,Se as k,xe as l,Ee as m,ke as n,Ae as o,ve as p};
