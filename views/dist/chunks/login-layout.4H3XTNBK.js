import{d as E,g as C,j as S,k as _}from"./chunk.GRDFA2OT.js";import{a as y}from"./chunk.T4UV54CI.js";import{h as w,i as n}from"./chunk.RASS3VP2.js";import"./chunk.EL6E2633.js";import{A as b,a as p,y as o}from"./chunk.NJSDOF6A.js";import"./chunk.XOPNHUSF.js";var m=class extends HTMLElement{constructor(){super(),this.form=null,this.emailInput=null,this.passwordInput=null,this.errorElement=null,this.submitButton=null,this.passwordToggle=null,this.trustCheckbox=null,this._frame=null,this._templateMounted=!1,this._storageCleared=!1,this._boundHandlers={submit:this.handleSubmit.bind(this),togglePassword:this.togglePasswordVisibility.bind(this),trustChanged:this.handleTrustChanged.bind(this)}}connectedCallback(){if(this._storageCleared||(n.clearAll(),this._storageCleared=!0),!this._templateMounted){let e=document.getElementById("login-layout");if(!e){console.error("Template #login-layout not found");return}let t=e.content.cloneNode(!0);this.appendChild(t),this._templateMounted=!0}this._frame!==null&&cancelAnimationFrame(this._frame),this._frame=requestAnimationFrame(()=>{this._frame=null,this.isConnected&&(b(this),this.form=this.querySelector('[data-role="login-form"]'),this.emailInput=this.querySelector('[data-role="email-input"]'),this.passwordInput=this.querySelector('[data-role="password-input"]'),this.errorElement=this.querySelector('[data-role="error"]'),this.submitButton=this.querySelector('[data-role="submit"]'),this.passwordToggle=this.querySelector('[data-role="toggle-password"]'),this.trustCheckbox=this.querySelector('[data-role="trust-checkbox"]'),this.trustCheckbox&&(this.trustCheckbox.checked=n.getTrustPreference()),this.form&&this.form.addEventListener("submit",this._boundHandlers.submit),this.passwordToggle&&this.passwordToggle.addEventListener("click",this._boundHandlers.togglePassword),this.trustCheckbox&&this.trustCheckbox.addEventListener("change",this._boundHandlers.trustChanged))})}disconnectedCallback(){this._frame!==null&&(cancelAnimationFrame(this._frame),this._frame=null),this.form&&this.form.removeEventListener("submit",this._boundHandlers.submit),this.passwordToggle&&this.passwordToggle.removeEventListener("click",this._boundHandlers.togglePassword),this.trustCheckbox&&this.trustCheckbox.removeEventListener("change",this._boundHandlers.trustChanged)}togglePasswordVisibility(e){e.preventDefault(),this.passwordInput&&(this.passwordInput.type=this.passwordInput.type==="password"?"text":"password")}handleTrustChanged(e){let t=e.target.checked;n.switchStorageEngine(t)}async handleSubmit(e){var i,l,c,g,f;e.preventDefault(),this.hideError();let t=(i=this.emailInput)==null?void 0:i.value.trim(),s=(l=this.passwordInput)==null?void 0:l.value;if(!t||!this.isValidEmail(t)){this.showError(o("authErrorInvalidEmail"));return}if(!s||s.length<10){this.showError(o("authErrorPasswordLength"));return}if(!window.crypto||!window.crypto.subtle){this.showError(o("authErrorCryptoUnsupported"));return}this.submitButton&&(this.submitButton.disabled=!0,this.setSubmitLabel("loginSubmitting"));try{let a=await this.requestChallenge(t),h=S(a.salt),v=C(a.kdf),r;try{try{r=await E(s,h,v)}finally{this.passwordInput&&(this.passwordInput.value="")}let x=await _(r.edSeed,a.nonce),u=await this.submitLogin(t,a.challenge_id,x);n.getTrustPreference()?sessionStorage.removeItem("session_valid"):sessionStorage.setItem("session_valid","true");let d=null;try{d=w.fromKeyMaterial({email:t,name:(c=u.user)==null?void 0:c.name,role:(g=u.user)==null?void 0:g.role,settings:(f=u.user)==null?void 0:f.settings,salt:p(h),x25519Seed:r.x25519Seed,version:u.app_version}),n.clearUser(),n.setUser(d)}catch(L){console.warn("[LoginLayout] Failed to persist user secrets",L)}d&&await y(d,{clearFirst:!0}),window.location.assign("/")}finally{r!=null&&r.edSeed&&r.edSeed.fill(0),r!=null&&r.x25519Seed&&r.x25519Seed.fill(0),h==null||h.fill(0)}}catch(a){console.error("[LoginLayout] Login failed",a),this.showError(a.message||o("loginErrorGeneric")),this.submitButton&&(this.submitButton.disabled=!1,this.setSubmitLabel("loginSubmitButton"))}}async requestChallenge(e){let t=await fetch("/auth/challenge",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})});if(!t.ok){let s="";try{s=await t.text()}catch{}throw console.error("[LoginLayout] Challenge request failed",t.status,s),new Error(o("loginErrorChallenge"))}return t.json()}async submitLogin(e,t,s){let i=await fetch("/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,challenge_id:t,signature:s,trust_computer:n.getTrustPreference()})});if(!i.ok){let l="";try{l=await i.text()}catch{}throw console.error("[LoginLayout] Login submission failed",i.status,l),new Error(o("loginErrorGeneric"))}return i.json()}showError(e){this.errorElement&&(this.errorElement.textContent=e,this.errorElement.classList.remove("hidden"))}hideError(){this.errorElement&&(this.errorElement.textContent="",this.errorElement.classList.add("hidden"))}setSubmitLabel(e){if(!this.submitButton)return;let t=this.submitButton.querySelector('[data-type="lang"]'),s=o(e);t?t.textContent=s:this.submitButton.textContent=s}isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}};customElements.define("login-layout",m);
