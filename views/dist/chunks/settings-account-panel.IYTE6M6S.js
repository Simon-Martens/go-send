import{a as N,b as v,c as F,d as K,f as D,g as U,h as A,i as R}from"./chunk.GRDFA2OT.js";import{d as P,e as T,h as q,i as S}from"./chunk.RASS3VP2.js";import"./chunk.EL6E2633.js";import{A as C,a as g,f as L,y as e}from"./chunk.NJSDOF6A.js";import"./chunk.XOPNHUSF.js";var B=class extends HTMLElement{constructor(){super(),this._templateMounted=!1,this._profileForm=null,this._profileSubmitButton=null,this._profileStatus=null,this._profileStatusIcon=null,this._profileStatusText=null,this._passwordForm=null,this._passwordSubmitButton=null,this._passwordStatus=null,this._passwordStatusIcon=null,this._passwordStatusText=null,this._accountStatus=null,this._accountStatusIcon=null,this._accountStatusText=null,this._clearSessionsButton=null,this._deactivateAccountButton=null,this._accountKeyValue=null,this._accountKeyCopyButton=null,this._accountKeyStatus=null,this._accountKeyStatusIcon=null,this._accountKeyStatusText=null,this._boundPasswordSubmit=this._handlePasswordSubmit.bind(this),this._boundProfileSubmit=this._handleProfileSubmit.bind(this),this._boundClearSessions=this._handleClearSessions.bind(this),this._boundDeactivateAccount=this._handleDeactivateAccount.bind(this),this._boundKeyCopy=this._handleAccountKeyCopy.bind(this)}connectedCallback(){if(!this._templateMounted){let s=document.getElementById("settings-account-panel");if(!s){console.error("Template #settings-account-panel not found");return}let t=s.content.cloneNode(!0);this.appendChild(t),this._templateMounted=!0}this._cacheElements(),C(this),this._attachListeners(),this._populateAccountForms()}disconnectedCallback(){this._detachListeners(),this._profileForm=null,this._profileSubmitButton=null,this._profileStatus=null,this._profileStatusIcon=null,this._profileStatusText=null,this._passwordForm=null,this._passwordSubmitButton=null,this._passwordStatus=null,this._passwordStatusIcon=null,this._passwordStatusText=null,this._accountStatus=null,this._accountStatusIcon=null,this._accountStatusText=null,this._clearSessionsButton=null,this._deactivateAccountButton=null,this._accountKeyValue=null,this._accountKeyCopyButton=null,this._accountKeyStatus=null,this._accountKeyStatusIcon=null,this._accountKeyStatusText=null}_cacheElements(){this._profileForm=this.querySelector('[data-role="profile-form"]'),this._profileSubmitButton=this.querySelector('[data-role="profile-submit"]'),this._profileStatus=this.querySelector('[data-role="profile-status"]'),this._profileStatusIcon=this.querySelector('[data-role="profile-status-icon"]'),this._profileStatusText=this.querySelector('[data-role="profile-status-text"]'),this._passwordForm=this.querySelector('[data-role="password-form"]'),this._passwordSubmitButton=this.querySelector('[data-role="password-submit"]'),this._passwordStatus=this.querySelector('[data-role="password-status"]'),this._passwordStatusIcon=this.querySelector('[data-role="password-status-icon"]'),this._passwordStatusText=this.querySelector('[data-role="password-status-text"]'),this._accountStatus=this.querySelector('[data-role="account-status"]'),this._accountStatusIcon=this.querySelector('[data-role="account-status-icon"]'),this._accountStatusText=this.querySelector('[data-role="account-status-text"]'),this._clearSessionsButton=this.querySelector('[data-role="account-clear-sessions"]'),this._deactivateAccountButton=this.querySelector('[data-role="account-deactivate"]'),this._accountKeyValue=this.querySelector('[data-role="account-key-value"]'),this._accountKeyCopyButton=this.querySelector('[data-role="account-key-copy"]'),this._accountKeyStatus=this.querySelector('[data-role="account-key-status"]'),this._accountKeyStatusIcon=this.querySelector('[data-role="account-key-status-icon"]'),this._accountKeyStatusText=this.querySelector('[data-role="account-key-status-text"]')}_attachListeners(){this._profileSubmitButton&&this._profileSubmitButton.addEventListener("click",this._boundProfileSubmit),this._passwordSubmitButton&&this._passwordSubmitButton.addEventListener("click",this._boundPasswordSubmit),this._clearSessionsButton&&this._clearSessionsButton.addEventListener("click",this._boundClearSessions),this._deactivateAccountButton&&this._deactivateAccountButton.addEventListener("click",this._boundDeactivateAccount),this._accountKeyCopyButton&&this._accountKeyCopyButton.addEventListener("click",this._boundKeyCopy)}_detachListeners(){this._profileSubmitButton&&this._profileSubmitButton.removeEventListener("click",this._boundProfileSubmit),this._passwordSubmitButton&&this._passwordSubmitButton.removeEventListener("click",this._boundPasswordSubmit),this._clearSessionsButton&&this._clearSessionsButton.removeEventListener("click",this._boundClearSessions),this._deactivateAccountButton&&this._deactivateAccountButton.removeEventListener("click",this._boundDeactivateAccount),this._accountKeyCopyButton&&this._accountKeyCopyButton.removeEventListener("click",this._boundKeyCopy)}_populateAccountForms(){var a,r;let s=S.user;if(!s)return;let t=(a=this._profileForm)==null?void 0:a.querySelector("#settings-account-name");t&&(t.value=s.name||"");let o=(r=this._profileForm)==null?void 0:r.querySelector("#settings-account-email");o&&(o.value=s.email||""),this._updateAccountKeySummary(s)}_updateAccountKeySummary(s){if(!this._accountKeyValue)return;let t=(s==null?void 0:s.x25519PrivateKey)||"";if(!t){this._accountKeyValue.textContent=e("settingsAccountKeyUnavailable"),this._accountKeyCopyButton&&(this._accountKeyCopyButton.disabled=!0),this._setKeyStatus("","");return}let o=t.length<=20?t:`${t.slice(0,12)}\u2026${t.slice(-6)}`;this._accountKeyValue.textContent=o,this._accountKeyCopyButton&&(this._accountKeyCopyButton.disabled=!1,this._accountKeyCopyButton.setAttribute("data-key-value",t)),this._setKeyStatus("","")}_setProfileStatus(s,t){this._profileStatus&&(this._profileStatusText&&(this._profileStatusText.textContent=t||""),this._profileStatus.className="text-sm flex items-center gap-2 min-h-[1.25rem]",this._profileStatusIcon&&(this._profileStatusIcon.className="hidden"),t&&(s==="error"?(this._profileStatus.classList.add("text-red-600","dark:text-red-400"),this._profileStatusIcon&&(this._profileStatusIcon.classList.remove("hidden"),this._profileStatusIcon.classList.add("ri-close-circle-fill","text-red-600","dark:text-red-400"))):s==="success"?(this._profileStatus.classList.add("text-green-600","dark:text-green-400"),this._profileStatusIcon&&(this._profileStatusIcon.classList.remove("hidden"),this._profileStatusIcon.classList.add("ri-check-line","text-green-600","dark:text-green-400"))):(this._profileStatus.classList.add("text-grey-70","dark:text-grey-40"),this._profileStatusIcon&&(this._profileStatusIcon.classList.remove("hidden"),this._profileStatusIcon.classList.add("ri-information-line","text-grey-60","dark:text-grey-40")))))}_setKeyStatus(s,t){this._accountKeyStatus&&(this._accountKeyStatusText&&(this._accountKeyStatusText.textContent=t||""),this._accountKeyStatus.className="text-xs flex items-center gap-2 min-h-[1.25rem] text-amber-900/80 dark:text-amber-200/80",this._accountKeyStatusIcon&&(this._accountKeyStatusIcon.className="hidden"),t&&(s==="error"?(this._accountKeyStatus.className="text-xs flex items-center gap-2 min-h-[1.25rem] text-red-600 dark:text-red-300",this._accountKeyStatusIcon&&(this._accountKeyStatusIcon.classList.remove("hidden"),this._accountKeyStatusIcon.className="ri-close-circle-fill text-red-600 dark:text-red-300")):s==="success"?(this._accountKeyStatus.className="text-xs flex items-center gap-2 min-h-[1.25rem] text-green-700 dark:text-green-300",this._accountKeyStatusIcon&&(this._accountKeyStatusIcon.classList.remove("hidden"),this._accountKeyStatusIcon.className="ri-check-line text-green-700 dark:text-green-300")):this._accountKeyStatusIcon&&(this._accountKeyStatusIcon.classList.remove("hidden"),this._accountKeyStatusIcon.className="ri-information-line text-amber-700 dark:text-amber-200")))}_setAccountStatus(s,t){this._accountStatus&&(this._accountStatusText&&(this._accountStatusText.textContent=t||""),this._accountStatus.className="text-xs flex items-center gap-2 min-h-[1.25rem]",this._accountStatusIcon&&(this._accountStatusIcon.className="hidden"),t&&(s==="error"?(this._accountStatus.classList.add("text-red-600","dark:text-red-400"),this._accountStatusIcon&&(this._accountStatusIcon.classList.remove("hidden"),this._accountStatusIcon.classList.add("ri-close-circle-fill","text-red-600","dark:text-red-400"))):s==="success"?(this._accountStatus.classList.add("text-green-600","dark:text-green-400"),this._accountStatusIcon&&(this._accountStatusIcon.classList.remove("hidden"),this._accountStatusIcon.classList.add("ri-check-line","text-green-600","dark:text-green-400"))):(this._accountStatus.classList.add("text-grey-70","dark:text-grey-40"),this._accountStatusIcon&&(this._accountStatusIcon.classList.remove("hidden"),this._accountStatusIcon.classList.add("ri-information-line","text-grey-60","dark:text-grey-40")))))}_handleAccountKeyCopy(s){if(s.preventDefault(),!this._accountKeyCopyButton)return;let t=this._accountKeyCopyButton.getAttribute("data-key-value")||"";if(!t){this._setKeyStatus("error",e("settingsAccountKeyStatusUnavailable"));return}if(L(t)){this._setKeyStatus("success",e("settingsAccountKeyStatusCopied"));let a=this._accountKeyCopyButton.querySelector("i");if(a){let r=a.dataset.originalClass||a.className;a.dataset.originalClass=r,a.className="ri-check-line text-base leading-4",setTimeout(()=>{a&&a.dataset.originalClass&&(a.className=a.dataset.originalClass)},2e3)}}else this._setKeyStatus("error",e("settingsAccountKeyStatusError"))}_setPasswordStatus(s,t){this._passwordStatus&&(this._passwordStatusText&&(this._passwordStatusText.textContent=t||""),this._passwordStatus.className="text-sm mt-4 flex items-center gap-2",this._passwordStatusIcon&&(this._passwordStatusIcon.className="hidden"),t&&(s==="error"?(this._passwordStatus.classList.add("text-red-600","dark:text-red-400"),this._passwordStatusIcon&&(this._passwordStatusIcon.classList.remove("hidden"),this._passwordStatusIcon.classList.add("ri-close-circle-fill","text-red-600","dark:text-red-400"))):s==="success"?(this._passwordStatus.classList.add("text-green-600","dark:text-green-400"),this._passwordStatusIcon&&(this._passwordStatusIcon.classList.remove("hidden"),this._passwordStatusIcon.classList.add("ri-check-line","text-green-600","dark:text-green-400"))):(this._passwordStatus.classList.add("text-grey-70","dark:text-grey-40"),this._passwordStatusIcon&&(this._passwordStatusIcon.classList.remove("hidden"),this._passwordStatusIcon.classList.add("ri-information-line","text-grey-60","dark:text-grey-40")))))}_isValidEmail(s){return s?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s):!1}_mapProfileError(s,t){switch(s){case"invalid_name":return e("settingsAccountProfileStatusNameRequired");case"invalid_email":return e("settingsAccountProfileStatusEmailInvalid");case"email_required":return e("settingsAccountProfileStatusEmailRequired");case"name_required":return e("settingsAccountProfileStatusNameRequired");case"email_in_use":return e("settingsAccountProfileStatusEmailInUse");case"not_active":return e("settingsAccountDangerStatusNotActive");case"forbidden":return e("settingsAccountProfileStatusError");default:break}return t===409?e("settingsAccountProfileStatusEmailInUse"):e("settingsAccountProfileStatusError")}_mapAccountActionError(s){switch(s){case"not_active":return e("settingsAccountDangerStatusNotActive");case"forbidden":return e("settingsAccountDangerStatusError");default:return e("settingsAccountDangerStatusError")}}async _handleProfileSubmit(s){if(s.preventDefault(),!this._profileForm)return;let t=this._profileForm.querySelector("#settings-account-name"),o=this._profileForm.querySelector("#settings-account-email"),a=(t==null?void 0:t.value.trim())||"",r=(o==null?void 0:o.value.trim())||"";if(!a){this._setProfileStatus("error",e("settingsAccountProfileStatusNameRequired"));return}if(!r){this._setProfileStatus("error",e("settingsAccountProfileStatusEmailRequired"));return}if(!this._isValidEmail(r)){this._setProfileStatus("error",e("settingsAccountProfileStatusEmailInvalid"));return}this._setProfileStatus("info",e("settingsAccountProfileStatusSaving")),this._profileSubmitButton&&(this._profileSubmitButton.disabled=!0);try{let c=await fetch("/api/me/profile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:a,email:r})});if(!c.ok){let f="";try{let m=await c.json();m&&typeof m.error=="string"&&(f=m.error)}catch{}let p=this._mapProfileError(f,c.status);throw new Error(p)}let d=null;if(c.status!==204)try{d=await c.json()}catch{d=null}let l=S.user;l&&(l.name=(d==null?void 0:d.name)??a,l.email=(d==null?void 0:d.email)??r,S.setUser(l)),this._populateAccountForms(),this._setProfileStatus("success",e("settingsAccountProfileStatusSuccess"))}catch(c){let d=(c==null?void 0:c.message)||e("settingsAccountProfileStatusError");this._setProfileStatus("error",d)}finally{this._profileSubmitButton&&(this._profileSubmitButton.disabled=!1)}}async _handleClearSessions(s){s.preventDefault(),this._setAccountStatus("info",e("settingsAccountDangerStatusClearing")),this._clearSessionsButton&&(this._clearSessionsButton.disabled=!0),this._deactivateAccountButton&&(this._deactivateAccountButton.disabled=!0);try{let t=await fetch("/api/me/clear-sessions",{method:"POST",headers:{"Content-Type":"application/json"}});if(!t.ok){let o="";try{let r=await t.json();r&&typeof r.error=="string"&&(o=r.error)}catch{}let a=this._mapAccountActionError(o);throw new Error(a)}this._redirectToLogout()}catch(t){let o=(t==null?void 0:t.message)||e("settingsAccountDangerStatusError");this._setAccountStatus("error",o),this._clearSessionsButton&&(this._clearSessionsButton.disabled=!1),this._deactivateAccountButton&&(this._deactivateAccountButton.disabled=!1)}}async _handleDeactivateAccount(s){if(s.preventDefault(),!!window.confirm(e("settingsAccountDeactivateConfirm"))){this._setAccountStatus("info",e("settingsAccountDangerStatusDeactivating")),this._deactivateAccountButton&&(this._deactivateAccountButton.disabled=!0),this._clearSessionsButton&&(this._clearSessionsButton.disabled=!0);try{let o=await fetch("/api/me/deactivate",{method:"POST",headers:{"Content-Type":"application/json"}});if(!o.ok){let a="";try{let c=await o.json();c&&typeof c.error=="string"&&(a=c.error)}catch{}let r=this._mapAccountActionError(a);throw new Error(r)}this._redirectToLogout()}catch(o){let a=(o==null?void 0:o.message)||e("settingsAccountDangerStatusError");this._setAccountStatus("error",a),this._deactivateAccountButton&&(this._deactivateAccountButton.disabled=!1),this._clearSessionsButton&&(this._clearSessionsButton.disabled=!1)}}}_redirectToLogout(){try{S.clearUser(),S.clearLocalFiles()}catch(s){console.warn("[SettingsAccountPanel] Failed to clear local storage on logout",s)}window.location.href="/logout"}async _handlePasswordSubmit(s){var E;if(s.preventDefault(),!this._passwordForm)return;let t=this._passwordForm.querySelector("#settings-current-password"),o=this._passwordForm.querySelector("#settings-new-password"),a=this._passwordForm.querySelector("#settings-confirm-password"),r=(t==null?void 0:t.value)||"",c=(o==null?void 0:o.value)||"",d=(a==null?void 0:a.value)||"";if(r.length<10){this._setPasswordStatus("error",e("settingsPasswordStatusErrorCurrent"));return}if(c.length<10){this._setPasswordStatus("error",e("settingsPasswordStatusErrorNewLength"));return}if(c!==d){this._setPasswordStatus("error",e("settingsPasswordStatusErrorMismatch"));return}let l=S.user;if(!l){this._setPasswordStatus("error",e("settingsPasswordStatusErrorNoSession"));return}let f=l.getSaltBytes();if(!f||!f.length){this._setPasswordStatus("error",e("settingsPasswordStatusErrorMissingKeys"));return}let p=l.settings||{},m=p.kdf||p||v,y=U(m),h=null,i=null,w=F(y.saltLength||v.saltLength);try{this._setPasswordStatus("info",e("settingsPasswordStatusInfoDeriving")),h=await K(r,f,y);let n=P.scalarMultBase(h.x25519Seed),u=l.getX25519PublicKey();if(u&&g(n)!==g(u)){this._setPasswordStatus("error",e("settingsPasswordStatusErrorIncorrect")),h.edSeed.fill(0),h.x25519Seed.fill(0);return}this._setPasswordStatus("info",e("settingsPasswordStatusInfoPreparing")),i=await K(c,w,y)}catch(n){console.error("[SettingsAccountPanel] Failed to derive key material",n),this._setPasswordStatus("error",e("settingsPasswordStatusErrorDerive"));return}finally{h!=null&&h.edSeed&&h.edSeed.fill(0),h!=null&&h.x25519Seed&&h.x25519Seed.fill(0)}let I,x;try{I=await N(i.edSeed),x=P.scalarMultBase(i.x25519Seed)}catch(n){console.error("[SettingsAccountPanel] Failed to compute public keys",n),i!=null&&i.edSeed&&i.edSeed.fill(0),i!=null&&i.x25519Seed&&i.x25519Seed.fill(0),this._setPasswordStatus("error",e("settingsPasswordStatusErrorPublicKeys"));return}let b;try{b=q.fromKeyMaterial({email:l.email,name:l.name,role:l.role,settings:p,salt:A(w),x25519Seed:i.x25519Seed,x25519PublicKey:x,version:l.version})}catch(n){console.error("[SettingsAccountPanel] Failed to prepare new user secrets",n),i!=null&&i.edSeed&&i.edSeed.fill(0),i!=null&&i.x25519Seed&&i.x25519Seed.fill(0),this._setPasswordStatus("error",e("settingsPasswordStatusErrorUserSecrets"));return}let k=[];try{let n=S.files||[];for(let u of n){if(!(u!=null&&u.id)||!((E=u.keychain)!=null&&E.rawSecret))continue;let _=await b.wrapSecret(u.keychain.rawSecret);k.push({id:u.id,ciphertext:_.ciphertext,nonce:_.nonce,ephemeral_pub:_.ephemeralPublicKey,version:_.version||T})}}catch(n){console.error("[SettingsAccountPanel] Failed to re-wrap secrets",n),i!=null&&i.edSeed&&i.edSeed.fill(0),i!=null&&i.x25519Seed&&i.x25519Seed.fill(0),this._setPasswordStatus("error",e("settingsPasswordStatusErrorWrap"));return}let V={current_password:r,new_salt:A(w),new_public_key:R(I),new_encryption_public_key:g(x),files:k,kdf:D(y)};this._setPasswordStatus("info",e("settingsPasswordStatusInfoUpdating")),this._passwordSubmitButton&&(this._passwordSubmitButton.disabled=!0);try{let n=await fetch("/api/passwordreset",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(V)});if(!n.ok){let u="";try{u=await n.text()}catch{}console.error("[SettingsAccountPanel] Password reset failed",n.status,u);let _=u||e("settingsPasswordStatusErrorRequest");throw new Error(_)}S.setUser(b),this._setPasswordStatus("success",e("settingsPasswordStatusSuccess")),t&&(t.value=""),o&&(o.value=""),a&&(a.value="")}catch(n){let u=e("settingsPasswordStatusErrorGeneric"),_=(n==null?void 0:n.message)||u;this._setPasswordStatus("error",_)}finally{i!=null&&i.edSeed&&i.edSeed.fill(0),i!=null&&i.x25519Seed&&i.x25519Seed.fill(0),this._passwordSubmitButton&&(this._passwordSubmitButton.disabled=!1)}}};customElements.define("settings-account-panel",B);
