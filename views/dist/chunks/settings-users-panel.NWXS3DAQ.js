import{a as q}from"./chunk.XWW2D6K4.js";import{g as D,i as I}from"./chunk.RASS3VP2.js";import"./chunk.EL6E2633.js";import{A as U,f as C,y as r}from"./chunk.NJSDOF6A.js";import"./chunk.XOPNHUSF.js";var x=class extends HTMLElement{constructor(){super(),this._templateMounted=!1,this._isAdmin=!1,this._signupSections=new Map,this._signupOverview=null,this._signupDetail=null,this._detailHeading=null,this._detailDescription=null,this._detailStatusEl=null,this._detailStatusIcon=null,this._detailStatusText=null,this._detailQrContainer=null,this._detailLinkInput=null,this._detailCopyButton=null,this._detailCopyIcon=null,this._detailBackButton=null,this._activeDetailType=null,this._activeDetailExpiresAt=null,this._usersHeader=null,this._usersListSection=null,this._usersListStatus=null,this._usersListEmpty=null,this._usersTableBody=null,this._usersStatusIcon=null,this._usersStatusText=null,this._usersData=[],this._usersLoading=!1,this._boundGenerateClick=this._handleGenerateClick.bind(this),this._boundRevokeClick=this._handleRevokeClick.bind(this),this._boundDetailBack=this._handleDetailBack.bind(this),this._boundDetailCopy=this._handleDetailCopy.bind(this),this._boundDetailLinkFocus=this._handleDetailLinkFocus.bind(this),this._boundUserAction=this._handleUserAction.bind(this)}connectedCallback(){if(!this._templateMounted){let t=document.getElementById("settings-users-panel");if(!t){console.error("Template #settings-users-panel not found");return}let e=t.content.cloneNode(!0);this.appendChild(e),this._templateMounted=!0}if(this._isAdmin=this._checkIsAdmin(),!this._isAdmin){console.warn("[SettingsUsersPanel] User is not admin, panel should not be visible");return}this._cacheElements(),U(this),this._attachListeners(),this._initSignupSections(),this._loadSignupOverview(),this._loadUsers()}disconnectedCallback(){this._detachListeners(),this._signupSections.clear(),this._signupOverview=null,this._signupDetail=null,this._detailHeading=null,this._detailDescription=null,this._detailStatusEl=null,this._detailStatusIcon=null,this._detailStatusText=null,this._detailQrContainer=null,this._detailLinkInput=null,this._detailCopyButton=null,this._detailCopyIcon=null,this._detailBackButton=null,this._activeDetailType=null,this._activeDetailExpiresAt=null,this._usersHeader=null,this._usersListSection=null,this._usersListStatus=null,this._usersListEmpty=null,this._usersTableBody=null,this._usersStatusIcon=null,this._usersStatusText=null,this._usersData=[]}_checkIsAdmin(){let t=I.user;if(!t||t.role===void 0||t.role===null)return!1;let e=t.role;if(typeof e=="number")return e===D.ADMIN;if(typeof e=="string"){let i=e.trim();if(!i)return!1;let s=Number.parseInt(i,10);return Number.isNaN(s)?i.toLowerCase()==="admin":s===D.ADMIN}return!1}_cacheElements(){this._signupOverview=this.querySelector('[data-role="signup-overview"]'),this._signupDetail=this.querySelector('[data-role="signup-detail"]'),this._detailHeading=this.querySelector('[data-role="detail-heading"]'),this._detailDescription=this.querySelector('[data-role="detail-description"]'),this._detailStatusEl=this.querySelector('[data-role="detail-status"]'),this._detailStatusIcon=this.querySelector('[data-role="detail-status-icon"]'),this._detailStatusText=this.querySelector('[data-role="detail-status-text"]'),this._detailQrContainer=this.querySelector('[data-role="detail-qr"]'),this._detailLinkInput=this.querySelector('[data-role="detail-link"]'),this._detailCopyButton=this.querySelector('[data-role="detail-copy"]'),this._detailCopyIcon=this.querySelector('[data-role="detail-copy-icon"]'),this._detailBackButton=this.querySelector('[data-role="detail-back"]'),this._usersHeader=this.querySelector('[data-role="users-header"]'),this._usersListSection=this.querySelector('[data-role="users-list"]'),this._usersListStatus=this.querySelector('[data-role="users-list-status"]'),this._usersStatusIcon=this.querySelector('[data-role="users-list-status-icon"]'),this._usersStatusText=this.querySelector('[data-role="users-list-status-text"]'),this._usersListEmpty=this.querySelector('[data-role="users-list-empty"]'),this._usersTableBody=this.querySelector('[data-role="users-table-body"]')}_attachListeners(){this.querySelectorAll('[data-role="generate"]').forEach(i=>{i.addEventListener("click",this._boundGenerateClick)}),this.querySelectorAll('[data-role="revoke"]').forEach(i=>{i.addEventListener("click",this._boundRevokeClick)}),this._detailBackButton&&this._detailBackButton.addEventListener("click",this._boundDetailBack),this._detailCopyButton&&this._detailCopyButton.addEventListener("click",this._boundDetailCopy),this._detailLinkInput&&this._detailLinkInput.addEventListener("focus",this._boundDetailLinkFocus),this._usersTableBody&&this._usersTableBody.addEventListener("click",this._boundUserAction)}_detachListeners(){this.querySelectorAll('[data-role="generate"]').forEach(i=>{i.removeEventListener("click",this._boundGenerateClick)}),this.querySelectorAll('[data-role="revoke"]').forEach(i=>{i.removeEventListener("click",this._boundRevokeClick)}),this._detailBackButton&&this._detailBackButton.removeEventListener("click",this._boundDetailBack),this._detailCopyButton&&this._detailCopyButton.removeEventListener("click",this._boundDetailCopy),this._detailLinkInput&&this._detailLinkInput.removeEventListener("focus",this._boundDetailLinkFocus),this._usersTableBody&&this._usersTableBody.removeEventListener("click",this._boundUserAction)}_initSignupSections(){this._signupSections.clear(),this.querySelectorAll('[data-role="signup-card"]').forEach(e=>{let i=e.getAttribute("data-token-type");if(!i)return;let s=i.toLowerCase(),n={container:e,countEl:e.querySelector('[data-role="active-count"]'),generateButton:e.querySelector('[data-role="generate"]'),revokeButton:e.querySelector('[data-role="revoke"]')};this._signupSections.set(s,n)})}_getSignupSection(t){return t&&this._signupSections.get(t.toLowerCase())||null}_setSignupCount(t,e){let i=this._getSignupSection(t);if(!i||!i.countEl)return;let s=Number.isFinite(e)?e:0;i.countEl.textContent=String(s)}_setSectionLoading(t,e){if(!t)return;let i=!!e;t.generateButton&&(t.generateButton.disabled=i,t.generateButton.classList.toggle("opacity-60",i)),t.revokeButton&&(t.revokeButton.disabled=i,t.revokeButton.classList.toggle("opacity-60",i))}_setDetailStatus(t,e="info"){if(!this._detailStatusEl)return;let i="text-sm flex items-center gap-2 min-h-[1.25rem]";if(this._detailStatusEl.className=`${i} text-grey-60 dark:text-grey-40`,this._detailStatusText?this._detailStatusText.textContent=t||"":this._detailStatusEl.textContent=t||"",this._detailStatusIcon&&(this._detailStatusIcon.className="hidden"),!t)return;let s="ri-information-line text-grey-60 dark:text-grey-40";e==="success"?(this._detailStatusEl.className=`${i} text-green-600 dark:text-green-400`,s="ri-check-line text-green-600 dark:text-green-400"):e==="error"&&(this._detailStatusEl.className=`${i} text-red-600 dark:text-red-400`,s="ri-error-warning-line text-red-600 dark:text-red-400"),this._detailStatusIcon&&(this._detailStatusIcon.className=s)}_showSignupDetail(t,e,i){if(!this._signupDetail||!this._signupOverview)return;this._activeDetailType=t,this._activeDetailExpiresAt=i||null;let s=t==="admin"?"settingsUsersDetailHeadingAdmin":"settingsUsersDetailHeadingUser";this._detailHeading&&(this._detailHeading.textContent=r(s));let n=this._formatExpiry(i);if(this._detailDescription&&(this._detailDescription.textContent=r("settingsUsersDetailDescription",{date:n})),this._setDetailStatus(""),this._detailLinkInput&&(this._detailLinkInput.value=e||"",requestAnimationFrame(()=>{this._detailLinkInput.select(),this._detailLinkInput.focus()})),this._detailQrContainer&&this._renderQRCode(this._detailQrContainer,e),this._detailCopyIcon){let a=this._detailCopyIcon.dataset.originalClass||this._detailCopyIcon.className;this._detailCopyIcon.dataset.originalClass=a,this._detailCopyIcon.className=a}this._signupOverview.classList.add("hidden"),this._signupDetail.classList.remove("hidden"),this._usersHeader&&this._usersHeader.classList.add("hidden"),this._usersListSection&&this._usersListSection.classList.add("hidden")}_clearSignupDetail(){!this._signupDetail||!this._signupOverview||(this._activeDetailType=null,this._activeDetailExpiresAt=null,this._detailLinkInput&&(this._detailLinkInput.value=""),this._detailQrContainer&&(this._detailQrContainer.innerHTML=""),this._detailCopyIcon&&this._detailCopyIcon.dataset.originalClass&&(this._detailCopyIcon.className=this._detailCopyIcon.dataset.originalClass),this._setDetailStatus(""),this._signupDetail.classList.add("hidden"),this._signupOverview.classList.remove("hidden"),this._usersHeader&&this._usersHeader.classList.remove("hidden"),this._usersListSection&&this._usersListSection.classList.remove("hidden"))}_renderQRCode(t,e){if(t){if(!e){t.innerHTML="";return}try{let i=q(0,"L");i.addData(e),i.make(),t.innerHTML=i.createSvgTag({scalable:!0,cellSize:4,margin:4});let s=t.querySelector("svg");s&&(s.style.maxWidth="200px",s.style.height="auto")}catch(i){console.error("[SettingsUsersPanel] QR generation failed",i),t.innerHTML=`<p class="text-sm text-grey-60 dark:text-grey-40 text-center">${r("settingsUsersQrError")}</p>`}}}_setUsersStatus(t,e="info"){if(!this._usersListStatus)return;let i="text-sm flex items-center gap-2 min-h-[1.25rem]";if(this._usersListStatus.className=`${i} text-grey-60 dark:text-grey-40`,this._usersStatusText?this._usersStatusText.textContent=t||"":this._usersListStatus.textContent=t||"",this._usersStatusIcon&&(this._usersStatusIcon.className="hidden"),!t)return;let s="ri-information-line text-grey-60 dark:text-grey-40";e==="success"?(this._usersListStatus.className=`${i} text-green-600 dark:text-green-400`,s="ri-check-line text-green-600 dark:text-green-400"):e==="error"&&(this._usersListStatus.className=`${i} text-red-600 dark:text-red-400`,s="ri-error-warning-line text-red-600 dark:text-red-400"),this._usersStatusIcon&&(this._usersStatusIcon.className=s)}async _handleGenerateClick(t){var n;t.preventDefault();let e=t.currentTarget,i=((n=e==null?void 0:e.getAttribute("data-token-type"))==null?void 0:n.toLowerCase())||"admin",s=this._getSignupSection(i);if(s){this._setSectionLoading(s,!0);try{let a=await fetch("/api/admin/signup-links",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:i})});if(!a.ok)throw new Error(`generate_failed_${a.status}`);let c=await a.json();typeof c.active_count=="number"&&this._setSignupCount(i,c.active_count);let l=typeof c.expires_at=="number"?c.expires_at:Number(c.expires_at||0);typeof c.link=="string"&&(this._showSignupDetail(i,c.link,l),this._setDetailStatus(r("settingsUsersGenerateSuccess"),"success"))}catch(a){console.error("[SettingsUsersPanel] Failed to create signup link",a),this._activeDetailType===i&&this._setDetailStatus(r("settingsUsersGenerateError"),"error")}finally{this._setSectionLoading(s,!1)}}}async _handleRevokeClick(t){var n;t.preventDefault();let e=t.currentTarget,i=((n=e==null?void 0:e.getAttribute("data-token-type"))==null?void 0:n.toLowerCase())||"admin",s=this._getSignupSection(i);if(s){this._setSectionLoading(s,!0);try{let a=await fetch(`/api/admin/signup-links?type=${encodeURIComponent(i)}`,{method:"DELETE",headers:{"Content-Type":"application/json"}});if(!a.ok)throw new Error(`revoke_failed_${a.status}`);let c=await a.json();typeof c.active_count=="number"?this._setSignupCount(i,c.active_count):this._setSignupCount(i,0),this._activeDetailType===i&&this._clearSignupDetail()}catch(a){console.error("[SettingsUsersPanel] Failed to revoke signup links",a),this._activeDetailType===i&&this._setDetailStatus(r("settingsUsersRevokeError"),"error")}finally{this._setSectionLoading(s,!1)}}}_handleDetailBack(t){t.preventDefault(),this._clearSignupDetail()}_handleDetailCopy(t){if(t.preventDefault(),!this._detailLinkInput)return;let e=this._detailLinkInput.value;if(!e)return;if(C(e)){if(this._setDetailStatus(r("settingsUsersDetailCopySuccess"),"success"),this._detailCopyIcon){let s=this._detailCopyIcon.dataset.originalClass||this._detailCopyIcon.className;this._detailCopyIcon.dataset.originalClass=s,this._detailCopyIcon.className="ri-check-line text-lg leading-4",setTimeout(()=>{this._detailCopyIcon&&(this._detailCopyIcon.className=this._detailCopyIcon.dataset.originalClass||s)},2e3)}}else this._setDetailStatus(r("settingsUsersDetailCopyError"),"error")}_handleDetailLinkFocus(t){let e=t.currentTarget;e&&typeof e.select=="function"&&e.select()}_formatExpiry(t){if(!t)return r("settingsUsersDetailExpiresUnknown");let e=Number(t)*1e3,i=new Date(e);if(Number.isNaN(i.getTime()))return r("settingsUsersDetailExpiresUnknown");let s=document.documentElement.lang||navigator.language||"en";return new Intl.DateTimeFormat(s,{dateStyle:"medium",timeStyle:"short"}).format(i)}async _loadSignupOverview(){try{let t=await fetch("/api/admin/signup-links",{method:"GET",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error(`overview_failed_${t.status}`);let e=await t.json();e!=null&&e.admin&&typeof e.admin.active_count=="number"&&this._setSignupCount("admin",e.admin.active_count),e!=null&&e.user&&typeof e.user.active_count=="number"&&this._setSignupCount("user",e.user.active_count)}catch(t){console.error("[SettingsUsersPanel] Failed to load signup overview",t),this._setSignupCount("admin",0),this._setSignupCount("user",0),this._activeDetailType&&this._setDetailStatus(r("settingsUsersOverviewError"),"error")}}async _loadUsers(){if(this._usersListSection&&!this._usersLoading){this._usersLoading=!0,this._setUsersStatus(r("settingsUsersListLoading"),"info");try{let t=await fetch("/api/admin/users",{method:"GET",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error(`users_list_failed_${t.status}`);let e=await t.json(),i=Array.isArray(e==null?void 0:e.users)?e.users:[];this._usersData=i.map(s=>({id:Number.parseInt(s.id,10)||s.id,name:s.name||"",email:s.email||"",role:s.role||"",active:!!s.active,public_key:s.public_key||"",encryption_public_key:s.encryption_public_key||"",active_sessions:Number.isFinite(s.active_sessions)?s.active_sessions:Number.parseInt(s.active_sessions??0,10)||0,is_current_user:!!s.is_current_user,created:s.created||0,updated:s.updated||0})),this._renderUsers(),this._setUsersStatus("","info")}catch(t){console.error("[SettingsUsersPanel] Failed to load users",t),this._setUsersStatus(r("settingsUsersListError"),"error")}finally{this._usersLoading=!1}}}_renderUsers(){if(this._usersTableBody){if(!Array.isArray(this._usersData)||!this._usersData.length){this._usersTableBody.innerHTML="",this._usersListEmpty&&this._usersListEmpty.classList.remove("hidden");return}this._usersListEmpty&&this._usersListEmpty.classList.add("hidden"),this._usersTableBody.innerHTML="";for(let t of this._usersData){let e=this._createUserRow(t);e&&this._usersTableBody.appendChild(e)}}}_createUserRow(t){var w;let e=document.getElementById("settings-user-item");if(!e)return console.error("Template #settings-user-item not found"),null;let s=e.content.cloneNode(!0).querySelector('[data-role="user-row"]');if(!s)return null;s.dataset.userId=String(t.id);let n=s.querySelector('[data-role="user-name"]');n&&(n.textContent=this._getDisplayName(t));let a=s.querySelector('[data-role="you-badge"]');a&&(t.is_current_user?a.classList.remove("hidden"):a.remove());let c=s.querySelector('[data-role="role-label"]'),l=s.querySelector('[data-role="status-label"]'),o=s.querySelector('[data-role="meta-separator"]'),u=this._formatUserRole(t.role),k=this._formatUserStatus(t.active);if(c&&u&&(c.textContent=u),l&&k){l.textContent=k;let d=t.active?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400";l.className=d,o&&o.classList.remove("hidden")}let A=s.querySelector('[data-role="user-email"]');if(A){let d=((w=t.email)==null?void 0:w.trim())||"";A.textContent=d||"\u2014"}let b=s.querySelector('[data-role="signing-key"]'),S=(t.public_key||"").trim(),N=this._formatKey(S);b&&(b.textContent=N,S&&(b.title=S));let L=s.querySelector('[data-role="encryption-key"]'),v=(t.encryption_public_key||"").trim(),$=this._formatKey(v);L&&(L.textContent=$,v&&(L.title=v));let _=s.querySelector('[data-role="copy-signing-key"]');if(_&&S){_.dataset.userAction="copy-key",_.dataset.userId=String(t.id),_.dataset.keyValue=S;let h=`${r("copyLinkButton")} \u2013 ${r("settingsUsersKeySigning")}`;_.setAttribute("aria-label",h),_.title=h;let f=_.querySelector(".sr-only");f&&(f.textContent=h),_.classList.remove("hidden")}let g=s.querySelector('[data-role="copy-encryption-key"]');if(g&&v){g.dataset.userAction="copy-key",g.dataset.userId=String(t.id),g.dataset.keyValue=v;let h=`${r("copyLinkButton")} \u2013 ${r("settingsUsersKeyEncryption")}`;g.setAttribute("aria-label",h),g.title=h;let f=g.querySelector(".sr-only");f&&(f.textContent=h),g.classList.remove("hidden")}let E=s.querySelector('[data-role="sessions-count"]');E&&(E.textContent=Number.isFinite(t.active_sessions)?String(t.active_sessions):"0");let p=s.querySelector('[data-role="toggle-button"]');if(p){let d=t.active?"deactivate":"activate",h=t.active?"ri-user-unfollow-line":"ri-user-follow-line",f=t.active?r("settingsUsersActionDeactivate"):r("settingsUsersActionActivate"),B="inline-flex items-center justify-center px-3 py-1.5 text-xs font-medium rounded border transition cursor-pointer disabled:opacity-40 disabled:cursor-not-allowed",H=`${B} text-yellow-700 dark:text-yellow-300 border-yellow-200 dark:border-yellow-400/40 bg-yellow-50/60 dark:bg-yellow-900/20 hover:bg-yellow-50 dark:hover:bg-yellow-900/30`,F=`${B} text-green-700 dark:text-green-300 border-green-200 dark:border-green-400/40 bg-green-50/60 dark:bg-green-900/20 hover:bg-green-50 dark:hover:bg-green-900/30`;p.className=t.active?H:F,p.dataset.userAction=d,p.dataset.userId=String(t.id),p.setAttribute("aria-label",f),t.active&&t.is_current_user&&(p.disabled=!0,p.title=r("settingsUsersActionDeactivateSelfError"));let T=p.querySelector('[data-role="toggle-icon"]');T&&(T.className=`${h} text-base leading-4`)}let y=s.querySelector('[data-role="clear-sessions-button"]');if(y){let d=t.active_sessions===0;y.dataset.userAction="clear-sessions",y.dataset.userId=String(t.id),y.setAttribute("aria-label",r("settingsUsersActionClearSessions")),d&&(y.disabled=!0,y.title=r("settingsUsersActionClearDisabledTooltip"))}let m=s.querySelector('[data-role="delete-button"]');if(m){let d=t.is_current_user;m.dataset.userAction="delete",m.dataset.userId=String(t.id),m.setAttribute("aria-label",r("settingsUsersActionDelete")),d&&(m.disabled=!0,m.title=r("settingsUsersActionDeleteSelfTooltip"))}return U(s),s}_getDisplayName(t){var s,n;if(!t)return r("settingsUsersNameFallback");let e=(s=t.name)==null?void 0:s.trim();if(e)return e;let i=(n=t.email)==null?void 0:n.trim();return i||r("settingsUsersNameFallback")}_formatUserRole(t){let e=(t||"").toString().toLowerCase();return e==="admin"?r("settingsUsersRoleAdmin"):e==="user"?r("settingsUsersRoleUser"):e==="guest"?r("settingsUsersRoleGuest"):r("settingsUsersRoleUnknown")}_formatUserStatus(t){return t?r("settingsUsersStatusActive"):r("settingsUsersStatusInactive")}_formatKey(t){let e=(t||"").trim();return e?e.length<=36?e:`${e.slice(0,20)}\u2026${e.slice(-10)}`:r("settingsUsersKeyMissing")}async _handleUserAction(t){let e=t.target.closest("[data-user-action]");if(!e||e.disabled)return;let i=e.getAttribute("data-user-action"),s=e.getAttribute("data-user-id"),n=Number.parseInt(s||"",10);if(!Number.isFinite(n))return;let a=this._usersData.find(l=>l.id===n);if(!a)return;if(i==="copy-key"){t.preventDefault();let l=e.getAttribute("data-key-value")||"";if(!l){this._setUsersStatus(r("settingsUsersCopyError"),"error");return}if(C(l)){this._setUsersStatus(r("settingsUsersCopySuccess"),"success");let u=e.querySelector("i");if(u){let k=u.dataset.originalClass||u.className;u.dataset.originalClass=k,u.className="ri-check-line text-base leading-4",setTimeout(()=>{u&&u.dataset.originalClass&&(u.className=u.dataset.originalClass)},2e3)}}else this._setUsersStatus(r("settingsUsersCopyError"),"error");return}let c=this._getDisplayName(a);if(i==="deactivate"){if(a.is_current_user){this._setUsersStatus(r("settingsUsersActionDeactivateSelfError"),"error");return}this._setUsersStatus(r("settingsUsersActionDeactivateWorking"),"info");let l=!1;this._setButtonLoading(e,"ri-loader-4-line",r("settingsUsersActionDeactivateWorking"));try{let o=await fetch(`/api/admin/users/${n}/deactivate`,{method:"POST",headers:{"Content-Type":"application/json"}});if(!o.ok)throw new Error(`deactivate_user_failed_${o.status}`);l=!0,await this._loadUsers(),this._setUsersStatus(r("settingsUsersActionDeactivateSuccess",{name:c}),"success")}catch(o){console.error("[SettingsUsersPanel] Failed to deactivate user",o),this._setUsersStatus(r("settingsUsersActionDeactivateError"),"error")}finally{l||this._restoreButton(e)}return}if(i==="activate"){this._setUsersStatus(r("settingsUsersActionActivateWorking"),"info");let l=!1;this._setButtonLoading(e,"ri-loader-4-line",r("settingsUsersActionActivateWorking"));try{let o=await fetch(`/api/admin/users/${n}/activate`,{method:"POST",headers:{"Content-Type":"application/json"}});if(!o.ok)throw new Error(`activate_user_failed_${o.status}`);l=!0,await this._loadUsers(),this._setUsersStatus(r("settingsUsersActionActivateSuccess",{name:c}),"success")}catch(o){console.error("[SettingsUsersPanel] Failed to activate user",o),this._setUsersStatus(r("settingsUsersActionActivateError"),"error")}finally{l||this._restoreButton(e)}return}if(i==="clear-sessions"){if(a.active_sessions===0)return;this._setUsersStatus(r("settingsUsersActionClearWorking"),"info");let l=!1;this._setButtonLoading(e,"ri-loader-4-line",r("settingsUsersActionClearWorking"));try{let o=await fetch(`/api/admin/users/${n}/clear-sessions`,{method:"POST",headers:{"Content-Type":"application/json"}});if(!o.ok)throw new Error(`clear_sessions_failed_${o.status}`);if(a.active_sessions=0,l=!0,await this._loadUsers(),a.is_current_user){window.location.assign("/login");return}this._setUsersStatus(r("settingsUsersActionClearSuccess",{name:c}),"success")}catch(o){console.error("[SettingsUsersPanel] Failed to clear sessions",o),this._setUsersStatus(r("settingsUsersActionClearError"),"error")}finally{l||this._restoreButton(e)}return}if(i==="delete"){if(a.is_current_user){this._setUsersStatus(r("settingsUsersActionDeleteSelfError"),"error");return}if(!window.confirm(r("settingsUsersActionDeleteConfirm",{name:c})))return;this._setUsersStatus(r("settingsUsersActionDeleteWorking"),"info");let o=!1;this._setButtonLoading(e,"ri-loader-4-line",r("settingsUsersActionDeleteWorking"));try{let u=await fetch(`/api/admin/users/${n}`,{method:"DELETE",headers:{"Content-Type":"application/json"}});if(!u.ok)throw new Error(`delete_user_failed_${u.status}`);o=!0,await this._loadUsers(),this._setUsersStatus(r("settingsUsersActionDeleteSuccess",{name:c}),"success")}catch(u){console.error("[SettingsUsersPanel] Failed to delete user",u),this._setUsersStatus(r("settingsUsersActionDeleteError"),"error")}finally{o||this._restoreButton(e)}}}_setButtonLoading(t,e,i){if(!t)return;t.dataset.originalContent||(t.dataset.originalContent=t.innerHTML),t.dataset.originalAriaLabel||(t.dataset.originalAriaLabel=t.getAttribute("aria-label")||"");let s=e?`<i class="${e} text-base leading-4 animate-spin" aria-hidden="true"></i>`:"";t.innerHTML=s||"",i&&t.setAttribute("aria-label",i),t.setAttribute("aria-busy","true"),t.disabled=!0,t.classList.add("opacity-60")}_restoreButton(t){!t||!t.dataset.originalContent||(t.innerHTML=t.dataset.originalContent,t.dataset.originalAriaLabel!==void 0&&(t.dataset.originalAriaLabel?t.setAttribute("aria-label",t.dataset.originalAriaLabel):t.removeAttribute("aria-label"),delete t.dataset.originalAriaLabel),t.removeAttribute("aria-busy"),t.disabled=!1,t.classList.remove("opacity-60"),delete t.dataset.originalContent)}};customElements.define("settings-users-panel",x);
