import{a as J}from"./chunks/chunk.T4UV54CI.js";import{a as Ne}from"./chunks/chunk.LITPCYMN.js";import{a as Y,b as Fe,e as le,f as ce,g as de,h as Me,i as g}from"./chunks/chunk.RASS3VP2.js";import{c as X,d as Ce,g as se,m as ze,o as _e,p as Te}from"./chunks/chunk.EL6E2633.js";import{A as P,a as Ee,c as D,f as Le,j as Z,k as Se,l as y,p as O,r as ne,s as Re,t as Ie,x as Ae,z as Ue}from"./chunks/chunk.NJSDOF6A.js";import"./chunks/chunk.XOPNHUSF.js";var pe=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117];typeof Int32Array<"u"&&(pe=new Int32Array(pe));var pr=(t,e)=>{let r=e===0?0:~~e^-1;for(let o=0;o<t.length;o++)r=pe[(r^t[o])&255]^r>>>8;return r^-1},De=pr;var hr=new TextEncoder;function ur(t=new Date){let e=t.getFullYear()-1980<<9,r=t.getMonth()+1<<5,o=t.getDate(),a=e|r|o,i=t.getHours()<<11,s=t.getMinutes()<<5,d=Math.floor(t.getSeconds()/2),p=i|s|d;return{date:a,time:p}}var he=class{constructor(e){this.name=hr.encode(e.name),this.size=e.size,this.bytesRead=0,this.crc=null,this.dateTime=ur()}get header(){let e=new ArrayBuffer(30+this.name.byteLength),r=new DataView(e);r.setUint32(0,67324752,!0),r.setUint16(4,20,!0),r.setUint16(6,2056,!0),r.setUint16(8,0,!0),r.setUint16(10,this.dateTime.time,!0),r.setUint16(12,this.dateTime.date,!0),r.setUint32(14,0,!0),r.setUint32(18,0,!0),r.setUint32(22,0,!0),r.setUint16(26,this.name.byteLength,!0),r.setUint16(28,0,!0);for(let o=0;o<this.name.byteLength;o++)r.setUint8(30+o,this.name[o]);return new Uint8Array(e)}get dataDescriptor(){let e=new ArrayBuffer(16),r=new DataView(e);return r.setUint32(0,134695760,!0),r.setUint32(4,this.crc,!0),r.setUint32(8,this.size,!0),r.setUint32(12,this.size,!0),new Uint8Array(e)}directoryRecord(e){let r=new ArrayBuffer(46+this.name.byteLength),o=new DataView(r);o.setUint32(0,33639248,!0),o.setUint16(4,20,!0),o.setUint16(6,20,!0),o.setUint16(8,2056,!0),o.setUint16(10,0,!0),o.setUint16(12,this.dateTime.time,!0),o.setUint16(14,this.dateTime.date,!0),o.setUint32(16,this.crc,!0),o.setUint32(20,this.size,!0),o.setUint32(24,this.size,!0),o.setUint16(28,this.name.byteLength,!0),o.setUint16(30,0,!0),o.setUint16(32,0,!0),o.setUint16(34,0,!0),o.setUint16(36,0,!0),o.setUint32(38,0,!0),o.setUint32(42,e,!0);for(let a=0;a<this.name.byteLength;a++)o.setUint8(46+a,this.name[a]);return new Uint8Array(r)}get byteLength(){return this.size+this.name.byteLength+30+16}append(e,r){this.bytesRead+=e.byteLength;let o=e.byteLength-Math.max(this.bytesRead-this.size,0),a=e.slice(0,o);if(this.crc=De(a,this.crc),r.enqueue(a),o<e.byteLength)return e.slice(o,e.byteLength)}};function gr(t,e){let r=0,o=0;for(let a=0;a<t.length;a++){let i=t[a],s=i.directoryRecord(r);r+=i.byteLength,e.enqueue(s),o+=s.byteLength}e.enqueue(mr(t.length,o,r))}function mr(t,e,r){let o=new ArrayBuffer(22),a=new DataView(o);return a.setUint32(0,101010256,!0),a.setUint16(4,0,!0),a.setUint16(6,0,!0),a.setUint16(8,t,!0),a.setUint16(10,t,!0),a.setUint32(12,e,!0),a.setUint32(16,r,!0),a.setUint16(20,0,!0),new Uint8Array(o)}var ue=class{constructor(e,r){this.files=e,this.fileIndex=0,this.file=null,this.reader=r.getReader(),this.nextFile(),this.extra=null}nextFile(){this.file=this.files[this.fileIndex++]}async pull(e){if(!this.file)return gr(this.files,e),e.close();if(this.file.bytesRead===0&&(e.enqueue(this.file.header),this.extra&&(this.extra=this.file.append(this.extra,e))),this.file.bytesRead>=this.file.size)return e.enqueue(this.file.dataDescriptor),this.nextFile(),this.pull(e);let r=await this.reader.read();if(r.done)return this.nextFile(),this.pull(e);this.extra=this.file.append(r.value,e)}},q=class{constructor(e,r){this.files=e.files.map(o=>new he(o)),this.source=r}get stream(){return new ReadableStream(new ue(this.files,this.source))}get size(){return this.files.reduce((o,a)=>o+a.byteLength*2-a.size,0)+22}};var $=class extends EventTarget{constructor(e){super(),this.keychain=new Y(e.secretKey,e.nonce),e.requiresPassword&&this.keychain.setPassword(e.password,e.url),this.fileInfo=e,this.reset()}get progressRatio(){return this.progress[0]/this.progress[1]}get progressIndefinite(){return this.state!=="downloading"}get sizes(){return{partialSize:y(this.progress[0]),totalSize:y(this.progress[1])}}cancel(){this.downloadRequest&&this.downloadRequest.cancel()}reset(){this.msg="fileSizeProgress",this.state="initialized",this.progress=[0,1]}async getMetadata(){let e=await ze(this.fileInfo.id,this.keychain);this.fileInfo.name=e.name,this.fileInfo.type=e.type,this.fileInfo.iv=e.iv,this.fileInfo.size=+e.size,this.fileInfo.manifest=e.manifest,this.state="ready"}sendMessageToSw(e){return new Promise((r,o)=>{let a=new MessageChannel;a.port1.onmessage=function(i){i.data===void 0?o("bad response from serviceWorker"):i.data.error!==void 0?o(i.data.error):r(i.data)},navigator.serviceWorker.controller.postMessage(e,[a.port2])})}async downloadBlob(e=!1){this.state="downloading",this.downloadRequest=await Te(this.fileInfo.id,this.keychain,r=>{this.progress=[r,this.fileInfo.size],this.dispatchEvent(new Event("progress"))});try{let r=await this.downloadRequest.result;this.downloadRequest=null,this.msg="decryptingFile",this.state="decrypting",this.dispatchEvent(new Event("decrypting"));let o=this.fileInfo.size,a=this.keychain.decryptStream(X(r));if(this.fileInfo.type==="send-archive"){let s=new q(this.fileInfo.manifest,a);a=s.stream,o=s.size}let i=await Ie(a,o);e||await fr({plaintext:i,name:decodeURIComponent(this.fileInfo.name),type:this.fileInfo.type}),this.msg="downloadFinish",this.dispatchEvent(new Event("complete")),this.state="complete"}catch(r){throw this.downloadRequest=null,r}}async downloadStream(e=!1){if(!navigator.serviceWorker.controller)return console.log("Service worker NA, switching to legacy download"),this.downloadBlob(e);let r=Date.now(),o=a=>{this.progress=[a,this.fileInfo.size],this.dispatchEvent(new Event("progress"))};this.downloadRequest={cancel:()=>{this.sendMessageToSw({request:"cancel",id:this.fileInfo.id})}};try{this.state="downloading";let a={request:"init",id:this.fileInfo.id,filename:this.fileInfo.name,type:this.fileInfo.type,manifest:this.fileInfo.manifest,key:this.fileInfo.secretKey,requiresPassword:this.fileInfo.requiresPassword,password:this.fileInfo.password,url:this.fileInfo.url,size:this.fileInfo.size,nonce:this.keychain.nonce,noSave:e};if(await this.sendMessageToSw(a),o(0),e){let d=await fetch(se(`/api/download/${this.fileInfo.id}`));if(d.status!==200)throw new Error(d.status)}else{let d=`/api/download/${this.fileInfo.id}`,p=se(d);p===d&&(p=`${location.protocol}//${location.host}${d}`);let c=document.createElement("a");c.href=p,document.body.appendChild(c),c.click()}let i=0,s=0;for(;i<this.fileInfo.size;){let d=await this.sendMessageToSw({request:"progress",id:this.fileInfo.id});if(d.progress===i?s++:s=0,s>30){let p=new Error("hung download");throw p.duration=Date.now()-r,p.size=this.fileInfo.size,p.progress=i,p}i=d.progress,o(i),await O(1e3)}this.downloadRequest=null,this.msg="downloadFinish",this.dispatchEvent(new Event("complete")),this.state="complete"}catch(a){throw this.downloadRequest=null,a==="cancelled"||a.message==="400"?new Error(0):a}}download(e){return e.stream?this.downloadStream(e.noSave):this.downloadBlob(e.noSave)}};async function fr(t){return new Promise(function(e,r){let o=new DataView(t.plaintext),a=new Blob([o],{type:t.type});if(navigator.msSaveBlob)return navigator.msSaveBlob(a,t.name),e();{let i=URL.createObjectURL(a),s=document.createElement("a");s.href=i,s.download=t.name,document.body.appendChild(s),s.click(),URL.revokeObjectURL(i),setTimeout(e,100)}})}var V=class extends EventTarget{constructor(){super(),this.keychain=new Y,this.reset()}get progressRatio(){return this.progress[0]/this.progress[1]}get progressIndefinite(){return["fileSizeProgress","notifyUploadEncryptDone"].indexOf(this.msg)===-1}get sizes(){return{partialSize:y(this.progress[0]),totalSize:y(this.progress[1])}}reset(){this.uploadRequest=null,this.msg="importingFile",this.progress=[0,1],this.cancelled=!1}cancel(){this.cancelled=!0,this.uploadRequest&&this.uploadRequest.cancel()}async upload(e){if(this.cancelled)throw new Error(0);this.msg="encryptingFile",this.dispatchEvent(new Event("encrypting"));let r=Ae(e.size),o=await this.keychain.encryptStream(e.stream),a=await this.keychain.encryptMetadata(e),i=await this.keychain.authKeyB64(),s=null,d=null,p=g.user;if(p)try{let c=await p.wrapSecret(this.keychain.rawSecret);s={ciphertext:c.ciphertext,nonce:c.nonce,ephemeralPublicKey:c.ephemeralPublicKey,version:c.version||le},c.updated&&g.setUser(p)}catch(c){console.warn("[FileSender] Failed to wrap owner secret",c)}if(e.recipientUserId&&e.recipientPublicKey)try{let c=await Me.wrapSecretForRecipient(this.keychain.rawSecret,e.recipientPublicKey);d={userId:e.recipientUserId,ciphertext:c.ciphertext,nonce:c.nonce,ephemeralPublicKey:c.ephemeralPublicKey,version:c.version||le}}catch(c){console.warn("[FileSender] Failed to wrap recipient secret",c)}if(this.uploadRequest=_e(o,a,i,e.timeLimit,e.dlimit,c=>{this.progress=[c,r],this.dispatchEvent(new Event("progress"))},s,d),this.cancelled)throw new Error(0);this.msg="fileSizeProgress",this.dispatchEvent(new Event("progress"));try{let c=await this.uploadRequest.result;this.msg="notifyUploadEncryptDone",this.uploadRequest=null,this.progress=[1,1];let b=Ee(this.keychain.rawSecret),w=g.user&&g.user.name?g.user.name:"",m=[];return e.recipientUserId&&m.push({userId:e.recipientUserId,userName:e.recipientName||"",userEmail:""}),new Fe({id:c.id,url:`${c.url}#${b}`,name:e.name,size:e.size,manifest:e.manifest,time:c.duration,speed:e.size/(c.duration/1e3),createdAt:Date.now(),expiresAt:Date.now()+e.timeLimit*1e3,secretKey:b,nonce:this.keychain.nonce,ownerToken:c.ownerToken,dlimit:e.dlimit,timeLimit:e.timeLimit,ownerString:w,authString:"",recipients:m})}catch(c){throw this.msg="errorPageHeader",this.uploadRequest=null,c}}};async function br(){try{let t=await crypto.subtle.generateKey({name:"AES-GCM",length:128},!0,["encrypt","decrypt"]);return await crypto.subtle.exportKey("raw",t),await crypto.subtle.encrypt({name:"AES-GCM",iv:crypto.getRandomValues(new Uint8Array(12)),tagLength:128},t,new ArrayBuffer(8)),await crypto.subtle.importKey("raw",crypto.getRandomValues(new Uint8Array(16)),"PBKDF2",!1,["deriveKey"]),await crypto.subtle.importKey("raw",crypto.getRandomValues(new Uint8Array(16)),"HKDF",!1,["deriveKey"]),await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveBits"]),!0}catch{return!1}}function wr(){try{return new ReadableStream({pull(){}}),!0}catch{return!1}}async function ge(){let t=Re(),e=/mobi|android/i.test(navigator.userAgent),r="serviceWorker"in navigator&&t!=="edge",o=await br(),a=wr(),i=e&&typeof navigator.share=="function"&&D().startsWith("en"),s=window.matchMedia("(display-mode: standalone)").matches||navigator.standalone;return{crypto:o,serviceWorker:r,streamUpload:a,streamDownload:a&&r&&t!=="safari"&&!(t==="firefox"&&e),multifile:a,share:i,standalone:s}}var L=class{constructor(e){this.value=e}valueOf(){return this.value}},h=class extends L{constructor(e="???"){super(e)}toString(e){return`{${this.value}}`}},f=class extends L{constructor(e,r={}){super(e),this.opts=r}toString(e){try{return e.memoizeIntlObject(Intl.NumberFormat,this.opts).format(this.value)}catch(r){return e.reportError(r),this.value.toString(10)}}},k=class extends L{constructor(e,r={}){super(e),this.opts=r}toString(e){try{return e.memoizeIntlObject(Intl.DateTimeFormat,this.opts).format(this.value)}catch(r){return e.reportError(r),new Date(this.value).toISOString()}}};var Oe=100,vr="\u2068",xr="\u2069";function yr(t,e,r){if(r===e||r instanceof f&&e instanceof f&&r.value===e.value)return!0;if(e instanceof f&&typeof r=="string"){let o=t.memoizeIntlObject(Intl.PluralRules,e.opts).select(e.value);if(r===o)return!0}return!1}function Pe(t,e,r){return e[r]?_(t,e[r].value):(t.reportError(new RangeError("No default")),new h)}function me(t,e){let r=[],o=Object.create(null);for(let a of e)a.type==="narg"?o[a.name]=B(t,a.value):r.push(B(t,a));return{positional:r,named:o}}function B(t,e){switch(e.type){case"str":return e.value;case"num":return new f(e.value,{minimumFractionDigits:e.precision});case"var":return kr(t,e);case"mesg":return Er(t,e);case"term":return Lr(t,e);case"func":return Sr(t,e);case"select":return Rr(t,e);default:return new h}}function kr(t,{name:e}){let r;if(t.params)if(Object.prototype.hasOwnProperty.call(t.params,e))r=t.params[e];else return new h(`$${e}`);else if(t.args&&Object.prototype.hasOwnProperty.call(t.args,e))r=t.args[e];else return t.reportError(new ReferenceError(`Unknown variable: $${e}`)),new h(`$${e}`);if(r instanceof L)return r;switch(typeof r){case"string":return r;case"number":return new f(r);case"object":if(r instanceof Date)return new k(r.getTime());default:return t.reportError(new TypeError(`Variable type not supported: $${e}, ${typeof r}`)),new h(`$${e}`)}}function Er(t,{name:e,attr:r}){let o=t.bundle._messages.get(e);if(!o)return t.reportError(new ReferenceError(`Unknown message: ${e}`)),new h(e);if(r){let a=o.attributes[r];return a?_(t,a):(t.reportError(new ReferenceError(`Unknown attribute: ${r}`)),new h(`${e}.${r}`))}return o.value?_(t,o.value):(t.reportError(new ReferenceError(`No value: ${e}`)),new h(e))}function Lr(t,{name:e,attr:r,args:o}){let a=`-${e}`,i=t.bundle._terms.get(a);if(!i)return t.reportError(new ReferenceError(`Unknown term: ${a}`)),new h(a);if(r){let d=i.attributes[r];if(d){t.params=me(t,o).named;let p=_(t,d);return t.params=null,p}return t.reportError(new ReferenceError(`Unknown attribute: ${r}`)),new h(`${a}.${r}`)}t.params=me(t,o).named;let s=_(t,i.value);return t.params=null,s}function Sr(t,{name:e,args:r}){let o=t.bundle._functions[e];if(!o)return t.reportError(new ReferenceError(`Unknown function: ${e}()`)),new h(`${e}()`);if(typeof o!="function")return t.reportError(new TypeError(`Function ${e}() is not callable`)),new h(`${e}()`);try{let a=me(t,r);return o(a.positional,a.named)}catch(a){return t.reportError(a),new h(`${e}()`)}}function Rr(t,{selector:e,variants:r,star:o}){let a=B(t,e);if(a instanceof h)return Pe(t,r,o);for(let i of r){let s=B(t,i.key);if(yr(t,a,s))return _(t,i.value)}return Pe(t,r,o)}function fe(t,e){if(t.dirty.has(e))return t.reportError(new RangeError("Cyclic reference")),new h;t.dirty.add(e);let r=[],o=t.bundle._useIsolating&&e.length>1;for(let a of e){if(typeof a=="string"){r.push(t.bundle._transform(a));continue}if(t.placeables++,t.placeables>Oe)throw t.dirty.delete(e),new RangeError(`Too many placeables expanded: ${t.placeables}, max allowed is ${Oe}`);o&&r.push(vr),r.push(B(t,a).toString(t)),o&&r.push(xr)}return t.dirty.delete(e),r.join("")}function _(t,e){return typeof e=="string"?t.bundle._transform(e):fe(t,e)}var Q=class{constructor(e,r,o){this.dirty=new WeakSet,this.params=null,this.placeables=0,this.bundle=e,this.errors=r,this.args=o}reportError(e){if(!this.errors||!(e instanceof Error))throw e;this.errors.push(e)}memoizeIntlObject(e,r){let o=this.bundle._intls.get(e);o||(o={},this.bundle._intls.set(e,o));let a=JSON.stringify(r);return o[a]||(o[a]=new e(this.bundle.locales,r)),o[a]}};function ee(t,e){let r=Object.create(null);for(let[o,a]of Object.entries(t))e.includes(o)&&(r[o]=a.valueOf());return r}var qe=["unitDisplay","currencyDisplay","useGrouping","minimumIntegerDigits","minimumFractionDigits","maximumFractionDigits","minimumSignificantDigits","maximumSignificantDigits"];function Ve(t,e){let r=t[0];if(r instanceof h)return new h(`NUMBER(${r.valueOf()})`);if(r instanceof f)return new f(r.valueOf(),{...r.opts,...ee(e,qe)});if(r instanceof k)return new f(r.valueOf(),{...ee(e,qe)});throw new TypeError("Invalid argument to NUMBER")}var $e=["dateStyle","timeStyle","fractionalSecondDigits","dayPeriod","hour12","weekday","era","year","month","day","hour","minute","second","timeZoneName"];function Be(t,e){let r=t[0];if(r instanceof h)return new h(`DATETIME(${r.valueOf()})`);if(r instanceof k)return new k(r.valueOf(),{...r.opts,...ee(e,$e)});if(r instanceof f)return new k(r.valueOf(),{...ee(e,$e)});throw new TypeError("Invalid argument to DATETIME")}var Ke=new Map;function je(t){let e=Array.isArray(t)?t.join(" "):t,r=Ke.get(e);return r===void 0&&(r=new Map,Ke.set(e,r)),r}var K=class{constructor(e,{functions:r,useIsolating:o=!0,transform:a=i=>i}={}){this._terms=new Map,this._messages=new Map,this.locales=Array.isArray(e)?e:[e],this._functions={NUMBER:Ve,DATETIME:Be,...r},this._useIsolating=o,this._transform=a,this._intls=je(e)}hasMessage(e){return this._messages.has(e)}getMessage(e){return this._messages.get(e)}addResource(e,{allowOverrides:r=!1}={}){let o=[];for(let a=0;a<e.body.length;a++){let i=e.body[a];if(i.id.startsWith("-")){if(r===!1&&this._terms.has(i.id)){o.push(new Error(`Attempt to override an existing term: "${i.id}"`));continue}this._terms.set(i.id,i)}else{if(r===!1&&this._messages.has(i.id)){o.push(new Error(`Attempt to override an existing message: "${i.id}"`));continue}this._messages.set(i.id,i)}}return o}formatPattern(e,r=null,o=null){if(typeof e=="string")return this._transform(e);let a=new Q(this,o,r);try{return fe(a,e).toString(a)}catch(i){if(a.errors&&i instanceof Error)return a.errors.push(i),new h().toString(a);throw i}}};var be=/^(-?[a-zA-Z][\w-]*) *= */gm,He=/\.([a-zA-Z][\w-]*) *= */y,Ir=/\*?\[/y,we=/(-?[0-9]+(?:\.([0-9]+))?)/y,Ar=/([a-zA-Z][\w-]*)/y,We=/([$-])?([a-zA-Z][\w-]*)(?:\.([a-zA-Z][\w-]*))?/y,Ur=/^[A-Z][A-Z0-9_-]*$/,re=/([^{}\n\r]+)/y,Cr=/([^\\"\n\r]*)/y,Ge=/\\([\\"])/y,Ze=/\\u([a-fA-F0-9]{4})|\\U([a-fA-F0-9]{6})/y,zr=/^\n+/,Xe=/ +$/,_r=/ *\r?\n/g,Tr=/( *)$/,Fr=/{\s*/y,Ye=/\s*}/y,Mr=/\[\s*/y,Nr=/\s*] */y,Dr=/\s*\(\s*/y,Or=/\s*->\s*/y,Pr=/\s*:\s*/y,qr=/\s*,?\s*/y,$r=/\s+/y,j=class{constructor(e){this.body=[],be.lastIndex=0;let r=0;for(;;){let n=be.exec(e);if(n===null)break;r=be.lastIndex;try{this.body.push(p(n[1]))}catch(l){if(l instanceof SyntaxError)continue;throw l}}function o(n){return n.lastIndex=r,n.test(e)}function a(n,l){if(e[r]===n)return r++,!0;if(l)throw new l(`Expected ${n}`);return!1}function i(n,l){if(o(n))return r=n.lastIndex,!0;if(l)throw new l(`Expected ${n.toString()}`);return!1}function s(n){n.lastIndex=r;let l=n.exec(e);if(l===null)throw new SyntaxError(`Expected ${n.toString()}`);return r=n.lastIndex,l}function d(n){return s(n)[1]}function p(n){let l=b(),u=c();if(l===null&&Object.keys(u).length===0)throw new SyntaxError("Expected message value or attributes");return{id:n,value:l,attributes:u}}function c(){let n=Object.create(null);for(;o(He);){let l=d(He),u=b();if(u===null)throw new SyntaxError("Expected attribute value");n[l]=u}return n}function b(){let n;if(o(re)&&(n=d(re)),e[r]==="{"||e[r]==="}")return w(n?[n]:[],1/0);let l=E();return l?n?w([n,l],l.length):(l.value=z(l.value,zr),w([l],l.length)):n?z(n,Xe):null}function w(n=[],l){for(;;){if(o(re)){n.push(d(re));continue}if(e[r]==="{"){n.push(m());continue}if(e[r]==="}")throw new SyntaxError("Unbalanced closing brace");let x=E();if(x){n.push(x),l=Math.min(l,x.length);continue}break}let u=n.length-1,S=n[u];typeof S=="string"&&(n[u]=z(S,Xe));let N=[];for(let x of n)x instanceof te&&(x=x.value.slice(0,x.value.length-l)),x&&N.push(x);return N}function m(){i(Fr,SyntaxError);let n=T();if(i(Ye))return n;if(i(Or)){let l=U();return i(Ye,SyntaxError),{type:"select",selector:n,...l}}throw new SyntaxError("Unclosed placeable")}function T(){if(e[r]==="{")return m();if(o(We)){let[,n,l,u=null]=s(We);if(n==="$")return{type:"var",name:l};if(i(Dr)){let S=F();if(n==="-")return{type:"term",name:l,attr:u,args:S};if(Ur.test(l))return{type:"func",name:l,args:S};throw new SyntaxError("Function names must be all upper-case")}return n==="-"?{type:"term",name:l,attr:u,args:[]}:{type:"mesg",name:l,attr:u}}return C()}function F(){let n=[];for(;;){switch(e[r]){case")":return r++,n;case void 0:throw new SyntaxError("Unclosed argument list")}n.push(ae()),i(qr)}}function ae(){let n=T();return n.type!=="mesg"?n:i(Pr)?{type:"narg",name:n.name,value:C()}:n}function U(){let n=[],l=0,u;for(;o(Ir);){a("*")&&(u=l);let S=W(),N=b();if(N===null)throw new SyntaxError("Expected variant value");n[l++]={key:S,value:N}}if(l===0)return null;if(u===void 0)throw new SyntaxError("Expected default variant");return{variants:n,star:u}}function W(){i(Mr,SyntaxError);let n;return o(we)?n=v():n={type:"str",value:d(Ar)},i(Nr,SyntaxError),n}function C(){if(o(we))return v();if(e[r]==='"')return M();throw new SyntaxError("Invalid expression")}function v(){let[,n,l=""]=s(we),u=l.length;return{type:"num",value:parseFloat(n),precision:u}}function M(){a('"',SyntaxError);let n="";for(;;){if(n+=d(Cr),e[r]==="\\"){n+=ie();continue}if(a('"'))return{type:"str",value:n};throw new SyntaxError("Unclosed string literal")}}function ie(){if(o(Ge))return d(Ge);if(o(Ze)){let[,n,l]=s(Ze),u=parseInt(n||l,16);return u<=55295||57344<=u?String.fromCodePoint(u):"\uFFFD"}throw new SyntaxError("Unknown escape sequence")}function E(){let n=r;switch(i($r),e[r]){case".":case"[":case"*":case"}":case void 0:return!1;case"{":return G(e.slice(n,r))}return e[r-1]===" "?G(e.slice(n,r)):!1}function z(n,l){return n.replace(l,"")}function G(n){let l=n.replace(_r,`
`),u=Tr.exec(n)[1].length;return new te(l,u)}}},te=class{constructor(e,r){this.value=e,this.length=r}};function Je(t,e){let r=new K(t,{useIsolating:!1});return r.addResource(new j(e)),r}var Qe={an:()=>import("./chunks/an.EYDETGLH.js"),ar:()=>import("./chunks/ar.FWDBHGFC.js"),ast:()=>import("./chunks/ast.IOIYFMJO.js"),az:()=>import("./chunks/az.NR6QSNQG.js"),azz:()=>import("./chunks/azz.KLH56K7U.js"),be:()=>import("./chunks/be.VCESGZRV.js"),bn:()=>import("./chunks/bn.C7NUGGQC.js"),br:()=>import("./chunks/br.7CG6JQ6W.js"),bs:()=>import("./chunks/bs.ECYC7BBK.js"),ca:()=>import("./chunks/ca.76FMOGF2.js"),cak:()=>import("./chunks/cak.AUNGX6BN.js"),ckb:()=>import("./chunks/ckb.L7OVEOE3.js"),cs:()=>import("./chunks/cs.UZIZXZNY.js"),cy:()=>import("./chunks/cy.XJ4CGVKE.js"),da:()=>import("./chunks/da.G2D5WNIM.js"),de:()=>import("./chunks/de.AYVMAZOL.js"),dsb:()=>import("./chunks/dsb.OQXHTIIV.js"),el:()=>import("./chunks/el.ETNZ3VJI.js"),"en-CA":()=>import("./chunks/en-CA.7ZKS3XRJ.js"),"en-GB":()=>import("./chunks/en-GB.JEHLP2HR.js"),"en-US":()=>import("./chunks/en-US.M7R6TU4W.js"),"es-AR":()=>import("./chunks/es-AR.CC36SUHA.js"),"es-CL":()=>import("./chunks/es-CL.J37ZE3OG.js"),"es-ES":()=>import("./chunks/es-ES.2BKDLIVF.js"),"es-MX":()=>import("./chunks/es-MX.TLPGRNTG.js"),et:()=>import("./chunks/et.RXSNVMXT.js"),eu:()=>import("./chunks/eu.5S6BZRMT.js"),fa:()=>import("./chunks/fa.UJ6JJ3PF.js"),fi:()=>import("./chunks/fi.JUKU7T36.js"),fr:()=>import("./chunks/fr.Z27XL4MC.js"),"fy-NL":()=>import("./chunks/fy-NL.TQONYGFY.js"),gn:()=>import("./chunks/gn.NOKFXUMG.js"),gor:()=>import("./chunks/gor.DV6X2EF3.js"),he:()=>import("./chunks/he.T46GJYHI.js"),hr:()=>import("./chunks/hr.WWNPUX4W.js"),hsb:()=>import("./chunks/hsb.3JSYCOQN.js"),hu:()=>import("./chunks/hu.XDD5L2UB.js"),hus:()=>import("./chunks/hus.KSYZFW3L.js"),"hy-AM":()=>import("./chunks/hy-AM.S2RYP26Y.js"),ia:()=>import("./chunks/ia.2J6UE5QQ.js"),id:()=>import("./chunks/id.VBCECWAY.js"),ig:()=>import("./chunks/ig.7ZJVCUVP.js"),it:()=>import("./chunks/it.BZ7CKJS3.js"),ixl:()=>import("./chunks/ixl.HLLV7ZZ3.js"),ja:()=>import("./chunks/ja.KU4B22LM.js"),ka:()=>import("./chunks/ka.6PATJYYK.js"),kab:()=>import("./chunks/kab.2RGAWRND.js"),ko:()=>import("./chunks/ko.IN4FPFX6.js"),lt:()=>import("./chunks/lt.2EPX5HZN.js"),lus:()=>import("./chunks/lus.2DTN6ICK.js"),meh:()=>import("./chunks/meh.DNYKYED2.js"),mix:()=>import("./chunks/mix.XDG4HRL2.js"),ml:()=>import("./chunks/ml.VH4LMJA3.js"),ms:()=>import("./chunks/ms.W3DBCQ7W.js"),"nb-NO":()=>import("./chunks/nb-NO.EYPCGXFG.js"),nl:()=>import("./chunks/nl.IKXSVNK7.js"),"nn-NO":()=>import("./chunks/nn-NO.CLS7ZYMV.js"),oc:()=>import("./chunks/oc.GDCTHI7V.js"),"pa-IN":()=>import("./chunks/pa-IN.ZET7DPHP.js"),pai:()=>import("./chunks/pai.ZSZMNBAL.js"),pl:()=>import("./chunks/pl.5Z67RJ6F.js"),ppl:()=>import("./chunks/ppl.CT4XE4Z3.js"),"pt-BR":()=>import("./chunks/pt-BR.JCK6EZ4H.js"),"pt-PT":()=>import("./chunks/pt-PT.R67FXLYO.js"),quc:()=>import("./chunks/quc.2THHW72M.js"),ro:()=>import("./chunks/ro.GEJS464M.js"),ru:()=>import("./chunks/ru.ZLUBPX6Y.js"),sk:()=>import("./chunks/sk.GOI66E76.js"),sl:()=>import("./chunks/sl.NIS2PR6Y.js"),sn:()=>import("./chunks/sn.AQE5L7T2.js"),sq:()=>import("./chunks/sq.HILPLQFR.js"),sr:()=>import("./chunks/sr.BI4DSNZ6.js"),su:()=>import("./chunks/su.EM37ZDSN.js"),"sv-SE":()=>import("./chunks/sv-SE.KRKPYLCC.js"),te:()=>import("./chunks/te.VMNZIPF7.js"),th:()=>import("./chunks/th.AQ2WKSSF.js"),tl:()=>import("./chunks/tl.LQSMUKUL.js"),tr:()=>import("./chunks/tr.3ZAVFSV5.js"),trs:()=>import("./chunks/trs.6LLAEHOV.js"),uk:()=>import("./chunks/uk.XQUAWDA6.js"),vi:()=>import("./chunks/vi.JL3UI2HQ.js"),yo:()=>import("./chunks/yo.Q3TSLSZV.js"),yua:()=>import("./chunks/yua.ZVFDNEXP.js"),zgh:()=>import("./chunks/zgh.WWUSDW35.js"),"zh-CN":()=>import("./chunks/zh-CN.DM6TZY7X.js"),"zh-TW":()=>import("./chunks/zh-TW.R7DFZGE6.js")};async function er(t){let e=[],{default:r}=await import("./chunks/en-US.M7R6TU4W.js");if(t!=="en-US"&&Qe[t]){let{default:o}=await Qe[t]();e.push(Je(t,o))}return e.push(Je("en-US",r)),function(o,a){for(let i of e)if(i.hasMessage(o))return i.formatPattern(i.getMessage(o).value,a)}}function Vr(t,e){for(let r of e)if(t.name===r.name&&t.size===r.size&&t.lastModified===r.lastModified)return!0;return!1}var H=class{constructor(e=[],r=86400,o=1){this.files=Array.from(e),this.defaultTimeLimit=r,this.defaultDownloadLimit=o,this.timeLimit=r,this.dlimit=o,this.password=null,this.customArchiveName=null,this.recipientUserId=null,this.recipientPublicKey=null,this.recipientName=null}get name(){if(this.files.length>1){let e=this.customArchiveName||"Send-Archive";return e.endsWith(".zip")?e:`${e}.zip`}return this.files[0].name}setArchiveName(e){this.files.length>1&&(this.customArchiveName=e)}get type(){return this.files.length>1?"send-archive":this.files[0].type}get size(){return this.files.reduce((e,r)=>e+r.size,0)}get numFiles(){return this.files.length}get manifest(){return{files:this.files.map(e=>({name:e.name,size:e.size,type:e.type}))}}get stream(){return Ce(this.files.map(e=>X(e)))}addFiles(e,r,o){if(this.files.length+e.length>o)throw new Error("tooManyFiles");let a=e.filter(s=>s.size>0&&!Vr(s,this.files)),i=a.reduce((s,d)=>s+d.size,0);if(this.size+i>r)throw new Error("fileTooBig");return this.files=this.files.concat(a),!0}remove(e){let r=this.files.indexOf(e);r>-1&&this.files.splice(r,1)}clear(){this.files=[],this.dlimit=this.defaultDownloadLimit,this.timeLimit=this.defaultTimeLimit,this.password=null,this.customArchiveName=null,this.recipientUserId=null,this.recipientPublicKey=null,this.recipientName=null}setRecipient(e,r){this.recipientUserId=e,this.recipientPublicKey=r}clearRecipient(){this.recipientUserId=null,this.recipientPublicKey=null,this.recipientName=null}};function rr(t,e,r,o,a,i){t.width=t.height=a,e.translate(a*.5,a*.5),e.rotate(-Math.PI*.5);let s=(a-o)*.5;e.beginPath(),e.arc(0,0,s,0,Math.PI*2*i,!1),e.strokeStyle=r,e.lineCap="square",e.lineWidth=o,e.stroke()}function Br(t,e){let r=document.createElement("canvas"),o=r.getContext("2d");return rr(r,o,"#efefef",5,32,1),rr(r,o,e,5,32,t),r.toDataURL()}function ve(t){var a,i,s,d;let e=document.querySelector("link[rel='icon'][sizes='32x32']");e||(e=document.createElement("link"),e.rel="icon",e.type="image/png",e.sizes="32x32",document.head.appendChild(e));let r=t*100;if(r===0||r===100){e.type="image/png";let p=(i=(a=window.WEB_UI)==null?void 0:a.CUSTOM_ASSETS)==null?void 0:i.favicon_32px;e.href=p||"/favicon.ico";return}let o=((d=(s=window.WEB_UI)==null?void 0:s.COLORS)==null?void 0:d.PRIMARY)||"#0A84FF";e.href=Br(t,o)}function Kr(t){let e=Math.floor(t*100);document.title=`${e}% - Send`}function tr(){document.title="Send"}function or(){let t=!1;return window.addEventListener("blur",()=>{t=!0}),window.addEventListener("focus",()=>{t=!1,tr(),ve(0)}),{update:e=>{t&&Kr(e),ve(e)},reset:()=>{tr(),ve(0)}}}var oe=class{constructor(e){this.root=e,this.state=null,this.handleAddFiles=this.handleAddFiles.bind(this),this.handleRemoveUpload=this.handleRemoveUpload.bind(this),this.handleUpload=this.handleUpload.bind(this),this.handleCancel=this.handleCancel.bind(this),this.handleDelete=this.handleDelete.bind(this),this.handleCopy=this.handleCopy.bind(this),this.handleShare=this.handleShare.bind(this),this.handleUpdateOptions=this.handleUpdateOptions.bind(this),this.handleMetadataRequest=this.handleMetadataRequest.bind(this),this.handleDownloadStart=this.handleDownloadStart.bind(this),this.intervals=[],this.lastRender=0,this.progressIndicators=or(),this.ready=this.initialize()}async initialize(){let e=await ge();if(!e.crypto&&window.location.pathname!=="/unsupported/crypto")throw window.location.assign("/unsupported/crypto"),new Error("Crypto not supported");if(e.serviceWorker)try{await navigator.serviceWorker.register("/serviceWorker.js"),await navigator.serviceWorker.ready,console.log("[Controller] Service Worker registered")}catch(o){console.warn("[Controller] Service Worker registration failed:",o),e.streamDownload=!1}let r=await er(D());return Ue(r),window.translate=r,this.state={LIMITS,DEFAULTS,WEB_UI,PREFS,archive:new H([],DEFAULTS.EXPIRE_SECONDS,DEFAULTS.DOWNLOADS),capabilities:e,translate:r,storage:g,transfer:null,fileInfo:null,locale:D()},window.appState=this.state,console.log("[Controller] Initialization complete"),this.state}async initializeUploadView(){console.log("[Controller] Initializing upload view"),await this.checkFiles()}hookupHandlers(){this.root.addEventListener("addfiles",this.handleAddFiles),this.root.addEventListener("removeupload",this.handleRemoveUpload),this.root.addEventListener("upload",this.handleUpload),this.root.addEventListener("cancel",this.handleCancel),this.root.addEventListener("delete",this.handleDelete),this.root.addEventListener("copy",this.handleCopy),this.root.addEventListener("share",this.handleShare),this.root.addEventListener("updateoptions",this.handleUpdateOptions),this.root.addEventListener("metadata-request",this.handleMetadataRequest),this.root.addEventListener("download-start",this.handleDownloadStart),this.intervals.push(setInterval(()=>this.checkFiles(),60*1e3)),this.intervals.push(setInterval(()=>this.rerenderCountdowns(),60*1e3)),console.log("[Controller] Event handlers attached")}destroyHandlers(){this.root.removeEventListener("addfiles",this.handleAddFiles),this.root.removeEventListener("removeupload",this.handleRemoveUpload),this.root.removeEventListener("upload",this.handleUpload),this.root.removeEventListener("cancel",this.handleCancel),this.root.removeEventListener("delete",this.handleDelete),this.root.removeEventListener("copy",this.handleCopy),this.root.removeEventListener("share",this.handleShare),this.root.removeEventListener("updateoptions",this.handleUpdateOptions),this.root.removeEventListener("metadata-request",this.handleMetadataRequest),this.root.removeEventListener("download-start",this.handleDownloadStart),this.intervals.forEach(e=>clearInterval(e)),this.intervals=[],console.log("[Controller] Event handlers destroyed")}async handleAddFiles(e){let{files:r}=e.detail;if(r.length<1)return;console.log("[Controller] Adding files:",r);let o=this.state.LIMITS.MAX_FILE_SIZE;try{this.state.archive.addFiles(r,o,this.state.LIMITS.MAX_FILES_PER_ARCHIVE),this._showUploadAreaError(null),this.root.currentLayout&&typeof this.root.currentLayout.refreshArchiveState=="function"&&this.root.currentLayout.refreshArchiveState()}catch(a){console.error("[Controller] Error adding files:",a),this._handleAddFilesError(a)}}handleRemoveUpload(e){let{file:r}=e.detail;console.log("[Controller] Removing upload:",r),this.state.archive.remove(r),this.state.archive.numFiles===0&&this.state.archive.clear(),this._showUploadAreaError(null),this.root.currentLayout&&typeof this.root.currentLayout.refreshArchiveState=="function"&&this.root.currentLayout.refreshArchiveState()}handleUpdateOptions(e){let{timeLimit:r,downloadLimit:o,password:a,archiveName:i,recipientUserId:s,recipientPublicKey:d,recipientName:p}=e.detail,c=this.state.archive;c&&(typeof r=="number"&&!Number.isNaN(r)&&(c.timeLimit=r),typeof o=="number"&&!Number.isNaN(o)&&(c.dlimit=o),a!==void 0&&(c.password=a||null),i!==void 0&&(c.customArchiveName=i||null),(s!==void 0||d!==void 0)&&(s&&d?(c.setRecipient(s,d),p&&(c.recipientName=p)):(c.clearRecipient(),c.recipientName=null)),console.log("[Controller] Updated archive options",{timeLimit:c.timeLimit,downloadLimit:c.dlimit,password:c.password?"***":null,recipientName:c.recipientName}))}async handleUpload(e){if(console.log("[Controller] Starting upload"),this.state.storage.files.length>=this.state.LIMITS.MAX_ARCHIVES_PER_USER){console.warn("[Controller] Too many archives");return}let r=this.state.archive,o=new V;o.addEventListener("progress",()=>this.updateProgress()),o.addEventListener("encrypting",()=>this.render()),o.addEventListener("complete",()=>this.render()),this.state.transfer=o,this.state.uploading=!0,this.render(),this.root.currentLayout&&typeof this.root.currentLayout.refreshArchiveState=="function"&&this.root.currentLayout.refreshArchiveState();let a=ne();await O(200);try{let i=await o.upload(r);this.state.storage.totalUploads+=1,this.progressIndicators.reset(),this.state.storage.addFile(i),r.password&&await this.handlePassword({password:r.password,file:i}),console.log("[Controller] Upload complete:",i),this.state.uploading=!1,this.state.transfer=null,r.clear(),await this.state.storage.merge(),this.root.currentLayout&&this.root.currentLayout.setUploadComplete&&this.root.currentLayout.setUploadComplete(i)}catch(i){i.message==="0"?(console.log("[Controller] Upload cancelled"),ne(a,!1),r.clear(),this.state.uploading=!1,this.state.transfer=null,await this.state.storage.merge(),this.render(),this.root.currentLayout&&typeof this.root.currentLayout.refreshArchiveState=="function"&&this.root.currentLayout.refreshArchiveState()):(console.error("[Controller] Upload error:",i),this.state.uploading=!1,this.state.transfer=null,this.render(),this._showUploadError(i.message||"An error occurred during upload"))}}handleCancel(e){console.log("[Controller] Cancelling upload"),this.state.transfer&&(this.state.transfer.cancel(),this.progressIndicators.reset()),this.root.currentLayout&&typeof this.root.currentLayout.refreshArchiveState=="function"&&this.root.currentLayout.refreshArchiveState()}async handleDelete(e){let{ownedFile:r}=e.detail;console.log("[Controller] Deleting file:",r);try{this.state.storage.remove(r.id),await r.del(),this.root.currentLayout&&typeof this.root.currentLayout.refreshUploadList=="function"&&this.root.currentLayout.refreshUploadList()}catch(o){console.error("[Controller] Error deleting file:",o)}}handleCopy(e){let{url:r}=e.detail;console.log("[Controller] Copying to clipboard:",r),Le(r)}handleShare(e){let{url:r,name:o}=e.detail;console.log("[Controller] Sharing:",{url:r,name:o}),navigator.share?navigator.share({title:o,url:r}).catch(a=>console.log("[Controller] Share cancelled:",a)):this.handleCopy({detail:{url:r}})}async handlePassword({password:e,file:r}){try{this.state.settingPassword=!0,this.render(),await r.setPassword(e),this.state.storage.writeFile(r),await O(1e3)}catch(o){console.error("[Controller] Error setting password:",o),this.state.passwordSetError=o}finally{this.state.settingPassword=!1}this.render()}updateProgress(){if(!this.state.transfer)return;let e=this.state.transfer.progressRatio;if(this.root.currentLayout&&this.root.currentLayout.updateProgress){let r=this.state.transfer.progress[0],o=this.state.transfer.progress[1];this.root.currentLayout.updateProgress(e,r,o)}this.progressIndicators.update(e)}async checkFiles(){let e=!1;if(this.state.storage.user)try{let o=this.state.storage.files.length;await J(this.state.storage.user),this.state.storage.files.length>o&&(e=!0)}catch(o){console.warn("[Controller] Failed to sync file list from server",o)}let r=await this.state.storage.merge();(r.downloadCount||r.outgoing||r.incoming||e)&&this.render()}rerenderCountdowns(){let e=Date.now(),r=this.state.storage&&this.state.storage.files.length>0,o=this.root.currentLayout&&this.root.currentLayout.tagName==="UPLOAD-LAYOUT",a=e-this.lastRender>3e4;r&&o&&a&&(console.log("[Controller] Updating countdown timers"),this.render())}render(){this.lastRender=Date.now();let e=this.root.currentLayout;e&&e.tagName==="UPLOAD-LAYOUT"&&typeof e.refreshUploadList=="function"&&e.refreshUploadList(),console.log("[Controller] Render requested")}_translate(e,r,o){let a=this.state.translate||window.translate;if(typeof a=="function")try{let i=a(e,o);if(i)return i}catch{}return r}_handleAddFilesError(e){let r="";e&&e.message==="tooManyFiles"?r=this._translate("tooManyFiles",`Too many files (max ${this.state.LIMITS.MAX_FILES_PER_ARCHIVE})`,{count:this.state.LIMITS.MAX_FILES_PER_ARCHIVE,size:y(this.state.LIMITS.MAX_FILE_SIZE)}):e&&e.message==="fileTooBig"&&(r=this._translate("fileTooBig",`That file is too big (max ${y(this.state.LIMITS.MAX_FILE_SIZE)})`,{size:y(this.state.LIMITS.MAX_FILE_SIZE)})),r?this._showUploadAreaError(r):this._showUploadAreaError(null)}_showUploadAreaError(e){let r=this.root.currentLayout;!r||!r.uploadArea||(e&&typeof r.uploadArea.showError=="function"?r.uploadArea.showError(e):e||(typeof r.uploadArea.clearError=="function"?r.uploadArea.clearError():typeof r.uploadArea.showError=="function"&&r.uploadArea.showError(null)))}_showUploadError(e){let r=this.root.currentLayout;!r||!r.uploadArea||typeof r.uploadArea.showErrorView=="function"&&r.uploadArea.showErrorView(e)}async handleMetadataRequest(e){let{fileInfo:r}=e.detail;console.log("[Controller] Metadata request for file:",r.id),this.state.fileInfo=r;let o=new $(r);try{await o.getMetadata(),this.state.transfer=o,Object.assign(this.state.fileInfo,{name:o.fileInfo.name,type:o.fileInfo.type,size:o.fileInfo.size,manifest:o.fileInfo.manifest,iv:o.fileInfo.iv}),console.log("[Controller] Metadata fetched successfully:",{name:o.fileInfo.name,size:o.fileInfo.size,type:o.fileInfo.type});let a=this.root.currentLayout;a&&typeof a.showOverviewView=="function"&&a.showOverviewView(this.state.fileInfo)}catch(a){if(console.error("[Controller] Error fetching metadata:",a),a.message==="401"){let i=this.root.currentLayout;if(i&&typeof i.showPasswordView=="function"){let s=this.state.translate||window.translate,d=s?s("passwordTryAgain"):"Incorrect password. Please try again.";i.showPasswordView(d)}}else if(a.message==="404"){let i=this.root.currentLayout;if(i&&typeof i.showErrorView=="function"){let s=this.state.translate||window.translate,d=s?s("notFoundDescription"):"File not found or expired.";i.showErrorView(d)}}else{let i=this.root.currentLayout;i&&typeof i.showErrorView=="function"&&i.showErrorView("An error occurred while fetching file information.")}}}async handleDownloadStart(e){if(console.log("[Controller] Download start"),!this.state.transfer){console.error("[Controller] No transfer (FileReceiver) in state");return}let r=this.state.transfer;r.addEventListener("progress",()=>{this.updateDownloadProgress()}),r.addEventListener("decrypting",()=>{console.log("[Controller] Decrypting file...")}),r.addEventListener("complete",()=>{console.log("[Controller] Download complete"),this.handleDownloadComplete()});try{let o=this.state.capabilities.streamDownload;await r.download({stream:o}),this.state.storage.totalDownloads+=1}catch(o){if(console.error("[Controller] Download error:",o),o.message==="0"){r.reset(),this.progressIndicators.reset();let a=this.root.currentLayout;a&&typeof a.showOverviewView=="function"&&a.showOverviewView(this.state.fileInfo)}else if(o.message==="404"){let a=this.root.currentLayout;if(a&&typeof a.showErrorView=="function"){let i=this.state.translate||window.translate,s=i?i("notFoundDescription"):"File not found or expired.";a.showErrorView(s)}}else{let a=this.root.currentLayout;a&&typeof a.showErrorView=="function"&&a.showErrorView("An error occurred during download.")}}}updateDownloadProgress(){if(!this.state.transfer)return;let e=this.state.transfer,r=e.progressRatio,o=e.progress[0],a=e.progress[1],i=this.root.currentLayout;i&&typeof i.updateProgress=="function"&&i.updateProgress(r,o,a),this.progressIndicators.update(r)}handleDownloadComplete(){console.log("[Controller] Download completed successfully"),this.progressIndicators.reset();let e=this.root.currentLayout;e&&typeof e.showFinishedView=="function"&&e.showFinishedView(),this.state.transfer=null}};var xe=class extends HTMLElement{constructor(){super(),this.currentView=null,this.currentLayout=null,this.controller=new oe(this),this._initFrame=null,this._templateMounted=!1}get state(){return this.controller?this.controller.state:null}connectedCallback(){if(!this._templateMounted){let e=document.getElementById("go-send");if(!e){console.error("Template #go-send not found");return}let r=e.content.cloneNode(!0);this.appendChild(r),this._templateMounted=!0}this._initFrame!==null&&cancelAnimationFrame(this._initFrame),this._initFrame=requestAnimationFrame(async()=>{this._initFrame=null,this.isConnected&&(await this.controller.ready,this.isConnected&&(P(this),this.controller.hookupHandlers()))})}disconnectedCallback(){this._initFrame!==null&&(cancelAnimationFrame(this._initFrame),this._initFrame=null),this.controller&&(this.controller.destroyHandlers(),this.controller=null)}showUploadLayout(){let e=this.querySelector("#app-content");if(!e){console.error("Slot #app-content not found in go-send template");return}e.innerHTML="";let r=document.createElement("upload-layout");e.appendChild(r),this.currentLayout=r,this.currentView="upload",this.controller&&typeof this.controller.initializeUploadView=="function"&&this.controller.initializeUploadView()}showDownloadLayout(){let e=this.querySelector("#app-content");if(!e){console.error("Slot #app-content not found in go-send template");return}e.innerHTML="";let r=document.createElement("download-layout");e.appendChild(r),this.currentLayout=r,this.currentView="download"}showRegisterLayout(){let e=this.querySelector("#app-content");if(!e){console.error("Slot #app-content not found in go-send template");return}e.innerHTML="";let r=document.createElement("register-layout");e.appendChild(r),this.currentLayout=r,this.currentView="register"}showLoginLayout(){let e=this.querySelector("#app-content");if(!e){console.error("Slot #app-content not found in go-send template");return}e.innerHTML="";let r=document.createElement("login-layout");e.appendChild(r),this.currentLayout=r,this.currentView="login"}showSettingsLayout(){let e=this.querySelector("#app-content");if(!e){console.error("Slot #app-content not found in go-send template");return}e.innerHTML="";let r=document.createElement("settings-layout");e.appendChild(r),this.currentLayout=r,this.currentView="settings"}showHelpLayout(){let e=this.querySelector("#app-content");if(!e){console.error("Slot #app-content not found in go-send template");return}e.innerHTML="",this.currentLayout=null,this.currentView="help"}showErrorLayout(e){let r=this.querySelector("#app-content");if(!r){console.error("Slot #app-content not found in go-send template");return}r.innerHTML="";let o=document.createElement("error-layout");e&&o.setAttribute("message",e),r.appendChild(o),this.currentLayout=o,this.currentView="error"}};customElements.define("go-send",xe);function R(t){t&&t.classList.remove("hidden")}function I(t){t&&t.classList.add("hidden")}var ye=class extends HTMLElement{constructor(){super(),this._templateMounted=!1,this._frame=null,this.config=window.FOOTER||{},this._boundHandlers={handleLogoutClick:this.handleLogoutClick.bind(this)}}connectedCallback(){if(!this._templateMounted){let e=document.getElementById("app-footer");if(!e){console.error("Template #app-footer not found");return}let r=e.content.cloneNode(!0);this.appendChild(r),this._templateMounted=!0}this._frame!==null&&cancelAnimationFrame(this._frame),this._frame=requestAnimationFrame(()=>{this._frame=null,this.isConnected&&(P(this),this._waitForTranslateAndSetup())})}_waitForTranslateAndSetup(){window.translate&&typeof window.translate=="function"?this.setupFooter():setTimeout(()=>{this.isConnected&&this._waitForTranslateAndSetup()},100)}disconnectedCallback(){this._frame!==null&&(cancelAnimationFrame(this._frame),this._frame=null);let e=this.querySelector('[data-role="auth-link"]');e&&e.href.includes("/logout")&&e.removeEventListener("click",this._boundHandlers.handleLogoutClick)}setupFooter(){let e=this.querySelector('[data-role="status-dot"]');if(e){let v=window.location.pathname.match(/^\/download/)||window.location.pathname.match(/^\/[0-9a-fA-F]{10,16}/);e.className=v?"status-dot status-dot-blue":"status-dot status-dot-green"}let r=this.querySelector("[data-if-custom]"),o=this.querySelector('[data-role="custom-link"]'),a=this.querySelector('[data-role="custom-text"]');if(this.config.CustomText){if(a&&(a.textContent=this.config.CustomText),this.config.CustomURL&&o)o.href=this.config.CustomURL,o.target="_blank";else if(o){let v=document.createElement("span");v.textContent=this.config.CustomText,o.replaceWith(v)}r&&R(r)}else r&&I(r);let i=this.querySelector("[data-if-dmca]"),s=this.querySelector('[data-role="dmca-link"]');this.config.DMCAURL?(s&&(s.href=this.config.DMCAURL,s.target="_blank"),i&&R(i)):i&&I(i);let d=this.querySelector("[data-if-source]"),p=this.querySelector('[data-role="source-link-footer"]');this.config.SourceURL?(p&&(p.href=this.config.SourceURL,p.target="_blank"),d&&R(d)):d&&I(d);let c=this.querySelector('[data-role="username"]'),b=this.querySelector('[data-role="auth-link"]'),w=this.querySelector('[data-role="auth-label"]'),m=g.user,T=Z(),F=m==null?void 0:m.role,ae=F===de.GUEST||typeof F=="string"&&F.trim().toLowerCase()==="guest",U=T||ae&&!m,W=U?Se():null;if(c&&(m&&m.name?(c.textContent=m.name,R(c)):W?(c.textContent=W,R(c)):I(c)),b&&w){if(b.removeEventListener("click",this._boundHandlers.handleLogoutClick),b.removeAttribute("target"),m||U){b.href="/logout",w.id="footerLinkLogout",w.removeAttribute("data-type"),w.textContent=this._translate("footerLinkLogout","Sign out"),b.addEventListener("click",this._boundHandlers.handleLogoutClick);let v=g.getTrustPreference(),M=m==null?void 0:m.role,ie=M===de.GUEST||typeof M=="string"&&M.trim().toLowerCase()==="guest",E=this.querySelector('[data-role="security-warning-icon"]');if(E)if(!v||U||ie){let z=U&&!m,G=z?"uploadGuestBannerMessageGuest":"uploadGuestBannerMessageEphemeral",n=this._translateText(G,z?"Remember to logout on untrusted devices!":"This computer isn't trusted! Remember to sign out!"),l=E.querySelector('[data-role="tooltip"]');l&&l.remove(),Ne(E,n,{position:"top",default:"open"}),R(E)}else I(E)}else{b.href="/login",w.id="footerLinkLogin",w.removeAttribute("data-type"),w.textContent=this._translate("footerLinkLogin","Sign in");let v=this.querySelector('[data-role="security-warning-icon"]');v&&I(v)}P(this)}let C=this.querySelector("[data-if-settings]");C&&(m?R(C):I(C))}handleLogoutClick(e){g.clearAll()}_translate(e,r){if(window.translate)try{return window.translate(e)}catch(o){console.warn("[AppFooter] Missing translation for",e,o)}return r}_translateText(e,r,o={}){if(window.translate&&typeof window.translate=="function")try{let a=window.translate(e);if(a&&a!==e)return a}catch(a){console.warn("[AppFooter] Error with window.translate:",e,a)}return r}};customElements.define("app-footer",ye);async function ke(t){console.log("[Route] Initializing upload page..."),await Promise.all([import("./chunks/upload-layout.A3TGWW7M.js"),import("./chunks/upload-area.FAHBFS24.js"),import("./chunks/upload-right.4SMGTYDX.js"),t.controller.ready]),t.showUploadLayout(),console.log("[Route] Upload page ready")}async function ar(t){console.log("[Route] Initializing download page..."),await Promise.all([import("./chunks/download-layout.OXJQFFYK.js"),import("./chunks/file-password.OWSH342U.js"),import("./chunks/file-overview.JGVUSZMR.js"),import("./chunks/file-downloading.RCKWTWKA.js"),import("./chunks/file-finished.52OO6RUU.js"),import("./chunks/file-error.OZ6UFOZJ.js"),t.controller.ready]),t.showDownloadLayout(),console.log("[Route] Download page ready")}async function ir(t){console.log("[Route] Initializing register page..."),await Promise.all([import("./chunks/register-layout.ZMY6M3SI.js"),t.controller.ready]),t.showRegisterLayout(),console.log("[Route] Register page ready")}async function nr(t){console.log("[Route] Initializing login page..."),await Promise.all([import("./chunks/login-layout.4H3XTNBK.js"),t.controller.ready]),t.showLoginLayout(),console.log("[Route] Login page ready")}async function sr(t){console.log("[Route] Initializing settings page..."),await Promise.all([import("./chunks/settings-layout.WZR6DPLP.js"),import("./chunks/settings-account-panel.IYTE6M6S.js"),import("./chunks/settings-upload-links-panel.FG3PDAQR.js"),import("./chunks/settings-users-panel.NWXS3DAQ.js"),import("./chunks/settings-logs-panel.CDX3ADFW.js"),t.controller.ready]),t.showSettingsLayout(),console.log("[Route] Settings page ready")}async function lr(t){console.log("[Route] Initializing help page..."),await t.controller.ready,t.showHelpLayout(),console.log("[Route] Help page ready")}async function cr(){let t=g.user;t&&t.version&&t.version!==ce&&(console.warn(`[App] Version mismatch: stored ${t.version}, current ${ce}. Clearing localStorage.`),g.clearAll()),g.user&&J(g.user).catch(e=>{console.warn("[App] File sync failed during startup",e)})}(async function(){await cr();let e=document.querySelector("go-send");if(!e){console.warn("[Router] <go-send> element not found in DOM");return}await dr(window.location.pathname,e),window.addEventListener("popstate",async()=>{await dr(window.location.pathname,e)}),console.log("[Router] Route initialized")})();var A={NONE:"none",GUEST:"guest",USER:"user"};function Hr(){return g.user?!g.getTrustPreference()&&!sessionStorage.getItem("session_valid")?(console.log("[Auth] Ephemeral session expired (browser restart detected)"),window.location.assign("/logout"),A.NONE):A.USER:Z()?A.GUEST:A.NONE}async function dr(t,e){var i;if(t.match(/^\/download/)||t.match(/^\/[0-9a-fA-F]{10,16}/)){await ar(e);return}if(t==="/help"||t.startsWith("/help/")){await lr(e);return}if(t.startsWith("/login")){await nr(e);return}if(t.startsWith("/register")){await ir(e);return}let r=((i=window.FEATURES)==null?void 0:i.UploadGuard)??!1,o=t==="/"||t.startsWith("/upload")||t==="/settings",a=Hr();if(r&&o){if(a===A.NONE){console.log("[Auth] Protected route requires authentication, redirecting to /login"),window.location.assign("/login");return}if(a===A.GUEST&&t==="/settings"){window.location.replace("/");return}}t==="/"||t.startsWith("/upload")?await ke(e):t==="/settings"?a===A.USER?await sr(e):window.location.replace("/"):(console.warn(`[Router] Unknown route: ${t}, defaulting to upload`),await ke(e))}
